<?php
/**
 * Plugin Name: Lilleprinsen â€“ Erstatning for manglende varer (Admin + Egen mobilportal + Async + Tillegg)
 * Description: Admin-velger for erstatning + egen mobiltilpasset portal. Asynkron ordreendring via Action Scheduler (med debounce). Lagersmart sÃ¸k. Bevarer brutto per enhet & opprinnelig mva-klasse, fryser rabatter og rater ikke frakt pÃ¥ nytt. Logger lager fÃ¸r/etter. Tilleggsordre kun for forslag merket â€œkunde betalerâ€. Reservasjon av lager ved top-up. Minimal lasting.
 * Author: Lilleprinsen
 * Version: 1.7.1
 * Text Domain: lilleprinsen
 * Domain Path: /languages
 */

use Automattic\WooCommerce\Internal\DataStores\Orders\CustomOrdersTableController;
use WC_Order;
use WC_Product;
use WC_Order_Item_Product;
use WC_Order_Item_Fee;

if ( ! defined( 'ABSPATH' ) ) exit;

/** Last inn oversettelser */
add_action( 'init', function(){
	load_plugin_textdomain( 'lilleprinsen', false, dirname( plugin_basename( __FILE__ ) ) . '/languages' );
} );

/* ==========================================================
 *                 KONFIG / KONSTANTER
 * ========================================================== */
if ( ! defined( 'LP_MPR_JOB_ACTION' ) )           define( 'LP_MPR_JOB_ACTION',          'lp_mpr_apply_replacements' );
if ( ! defined( 'LP_MPR_RELEASE_JOB_ACTION' ) )   define( 'LP_MPR_RELEASE_JOB_ACTION',  'lp_mpr_release_reservations' );
if ( ! defined( 'LP_MPR_JOB_GROUP' ) )            define( 'LP_MPR_JOB_GROUP',           'lp-mpr' );

/** Debounce/TTL kan justeres via filter */
function lp_mpr_debounce_seconds() : int { return (int) apply_filters( 'lp_mpr_debounce_seconds', 120 ); }
function lp_mpr_reservation_ttl_seconds() : int { return (int) apply_filters( 'lp_mpr_reservation_ttl_seconds', 2 * HOUR_IN_SECONDS ); }

/** Lagerpolicy for gammel vare: rÃ¸r ikke lager som standard; opt-in for Ã¥ tvinge 0. */
function lp_mpr_force_old_stock_zero() : bool { return (bool) apply_filters( 'lp_mpr_force_old_stock_zero', false ); }
/** Overstyr hvis eksternt lager-API brukes â€” eller for Ã¥ hoppe over reduksjon for reserverte linjer */
function lp_mpr_skip_external_stock_manager( $product_id ) { return apply_filters( 'lp_mpr_skip_external_stock_manager', false, $product_id ); }

/* ==========================================================
 *           SMÃ… HJELPERE (pris, mva, bilder, utils)
 * ========================================================== */

/** Enhetsbrutto / enhetsskatt for en ordrelinje (fra linjens totals) */
function lp_mpr_get_line_unit_prices( WC_Order $order, $item ) : array {
	$qty = max( 1, (int) $item->get_quantity() );
	return array(
		'unit_gross_subtotal' => (float) $item->get_subtotal()     / $qty + (float) $item->get_subtotal_tax() / $qty,
		'unit_gross_total'    => (float) $item->get_total()        / $qty + (float) $item->get_total_tax()    / $qty,
		'unit_tax_subtotal'   => (float) $item->get_subtotal_tax() / $qty,
		'unit_tax_total'      => (float) $item->get_total_tax()    / $qty,
		'tax_class'           => (string) $item->get_tax_class(),
	);
}

/** Brutto enhetspris for et produkt i *ordrens* skatte-kontekst. */
function lp_mpr_get_product_unit_gross_for_order( WC_Product $p, WC_Order $order ) : float {
	if ( '' === $p->get_price( 'edit' ) ) return 0.0;
	$raw_price = (float) $p->get_price( 'edit' );
	$tax_class = $p->get_tax_class();
	$prices_include_tax = wc_prices_include_tax();

	// NettobelÃ¸p utfra butikkens prislagring
	if ( $prices_include_tax ) {
		$base_rates = WC_Tax::get_base_tax_rates( $tax_class );
		$base_taxes = WC_Tax::calc_tax( $raw_price, $base_rates, true );
		$net = $raw_price - array_sum( $base_taxes );
	} else {
		$net = $raw_price;
	}

	// Legg pÃ¥ korrekt mva for *kunde-/ordre*-kontekst
	$args = array(
		'country'   => $order->get_shipping_country() ?: $order->get_billing_country(),
		'state'     => $order->get_shipping_state() ?: $order->get_billing_state(),
		'postcode'  => $order->get_shipping_postcode() ?: $order->get_billing_postcode(),
		'city'      => $order->get_shipping_city() ?: $order->get_billing_city(),
		'tax_class' => $tax_class,
	);
	$rates = method_exists( 'WC_Tax', 'find_rates' ) ? WC_Tax::find_rates( $args ) : WC_Tax::get_rates( $tax_class );
	$taxes = WC_Tax::calc_tax( $net, $rates, false );
	$gross = $net + array_sum( $taxes );

	return (float) wc_format_decimal( $gross, wc_get_price_decimals() );
}
function lp_mpr_get_product_unit_gross( WC_Product $p, WC_Order $order ) : float {
	return lp_mpr_get_product_unit_gross_for_order( $p, $order );
}

/** Delta (brutto) gitt original enhetsbrutto og valgt produkt * mengde */
function lp_mpr_calc_delta_gross( float $orig_unit_gross, WC_Product $p, int $qty, WC_Order $order ) : float {
	$new_unit_gross = lp_mpr_get_product_unit_gross_for_order( $p, $order );
	$delta = ( $new_unit_gross - $orig_unit_gross ) * max( 0, $qty );
	return (float) wc_format_decimal( $delta, wc_get_price_decimals() );
}

/** Skaler mva-matrise (beholder per-sats fordeling) */
function lp_mpr_scale_tax_array( array $taxes, int $orig_qty, int $new_qty ) : array {
	$orig_qty = max(1, (int) $orig_qty);
	$new_qty  = max(0, (int) $new_qty);
	$scale = function( $bucket ) use ( $orig_qty, $new_qty ) {
		$out = array();
		foreach ( (array) $bucket as $rate_id => $amount ) {
			$per_unit = (float) $amount / $orig_qty;
			$out[$rate_id] = $per_unit * $new_qty;
		}
		return $out;
	};
	return array(
		'subtotal' => $scale( $taxes['subtotal'] ?? array() ),
		'total'    => $scale( $taxes['total']    ?? array() ),
	);
}

/** Stabil hash for payload (ekskluderer flyktige felt) */
function lp_mpr_selection_hash( array $payload ) : string {
	$stable = $payload;
	if ( isset( $stable['items'] ) && is_array( $stable['items'] ) ) {
		foreach ( $stable['items'] as &$it ) {
			if ( isset( $it['replacements'] ) ) {
				usort( $it['replacements'], function( $a, $b ){
					return ($a['product_id'] <=> $b['product_id']) ?: ($a['qty'] <=> $b['qty']);
				});
			}
		}
		unset($it);
		usort( $stable['items'], function( $a, $b ){ return ($a['order_item_id'] <=> $b['order_item_id']); } );
	}
	unset( $stable['created_at'] );
	return sha1( wp_json_encode( $stable ) );
}

/** Kompakt produktbilde (HTML) */
function lp_mpr_thumb_html( WC_Product $product, string $class = 'lp-thumb' ) : string {
	$alt = wp_strip_all_tags( $product->get_name() );
	$img_id = $product->get_image_id();
	if ( $img_id ) {
		$html = wp_get_attachment_image( $img_id, 'thumbnail', false, array(
			'class'    => $class,
			'loading'  => 'lazy',
			'decoding' => 'async',
			'alt'      => $alt,
			'style'    => 'width:48px;height:48px;border-radius:6px;object-fit:cover;border:1px solid #e5e7eb',
		) );
	} else {
		$src = wc_placeholder_img_src( 'thumbnail' );
		$html = '<img src="' . esc_url( $src ) . '" alt="' . esc_attr( $alt ) . '" class="' . esc_attr( $class ) . '" loading="lazy" decoding="async" style="width:48px;height:48px;border-radius:6px;object-fit:cover;border:1px solid #e5e7eb" />';
	}
	return $html;
}

/* ==========================================================
 *                 ADMIN META BOX & SÃ˜K
 * ========================================================== */

add_action( 'add_meta_boxes', function () {
	$screen = class_exists( CustomOrdersTableController::class )
		&& wc_get_container()->get( CustomOrdersTableController::class )->custom_orders_table_usage_is_enabled()
			? wc_get_page_screen_id( 'shop-order' )
			: 'shop_order';

	add_meta_box(
	'lp_missing_product_replacement',
	__( 'Erstatning for manglende vare', 'lilleprinsen' ),
	'lp_render_missing_product_replacement_box',
	$screen,
	'advanced',
	'low'
	);
} );

add_action( 'admin_enqueue_scripts', function () {
	$screen = function_exists('get_current_screen') ? get_current_screen() : null;
	if ( ! $screen ) return;

	$order_screen = class_exists( CustomOrdersTableController::class )
		&& wc_get_container()->get( CustomOrdersTableController::class )->custom_orders_table_usage_is_enabled()
			? wc_get_page_screen_id( 'shop-order' )
			: 'shop_order';

	if ( $screen->id === $order_screen ) {
		if ( wp_script_is( 'wc-enhanced-select', 'registered' ) ) {
			wp_enqueue_script( 'wc-enhanced-select' );
		} elseif ( wp_script_is( 'selectWoo', 'registered' ) ) {
			wp_enqueue_script( 'selectWoo' );
		}
		if ( wp_style_is( 'woocommerce_admin_styles', 'registered' ) ) {
			wp_enqueue_style( 'woocommerce_admin_styles' );
		}
	}
} );

/**
 * Render admin-metaboks (viser delta og valg "kunde betaler" / "butikk dekker")
 */
function lp_render_missing_product_replacement_box( $object ) {
	$order = is_a( $object, 'WP_Post' ) ? wc_get_order( $object->ID ) : $object;
	if ( ! $order || ! is_a( $order, 'WC_Order' ) ) {
		echo '<p>' . esc_html__( 'Fant ikke ordren.', 'lilleprinsen' ) . '</p>';
		return;
	}

	$saved = (array) $order->get_meta( '_lp_missing_replacements', true );

	wp_nonce_field( 'lp_missing_replacements_save', 'lp_missing_replacements_nonce' );
	wp_nonce_field( 'lp_mpr_send_suggestion', 'lp_mpr_send_suggestion_nonce' );

echo '<style>
#lp-mpr{padding:10px;background:#f8fafc;border-radius:8px}
#lp-mpr .lp-header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:8px}
#lp-mpr .lp-eyebrow{margin:0;color:#475569;font-size:12px;letter-spacing:.04em;text-transform:uppercase}
#lp-mpr .lp-title{margin:2px 0 0;font-size:14px;font-weight:700;color:#0f172a}
#lp-mpr .lp-chips{display:flex;gap:6px;flex-wrap:wrap}
#lp-mpr .lp-chip{background:#fff;border:1px solid #e2e8f0;border-radius:999px;padding:4px 10px;font-size:12px;color:#0f172a;box-shadow:0 1px 2px rgba(15,23,42,.06);display:inline-flex;align-items:center;gap:6px}
#lp-mpr .lp-note{margin:4px 0 10px;color:#475569;font-size:12px}
#lp-mpr .lp-row{margin:10px 0;padding:12px;border:1px solid #e2e8f0;border-radius:10px;background:#fff;box-shadow:0 1px 3px rgba(15,23,42,.06)}
#lp-mpr .lp-top{display:flex;align-items:flex-start;gap:12px;flex-wrap:wrap}
#lp-mpr .lp-name{flex:1;font-size:13px;line-height:1.45;color:#0f172a}
#lp-mpr .lp-qty{width:96px}
#lp-mpr .lp-preview{font-size:12px;color:#475569;min-width:60px;text-align:right}
#lp-mpr small.muted{color:#667085}
#lp-mpr .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
#lp-mpr .lp-actions{margin-top:14px;padding:12px;border-top:1px solid #e5e7eb;background:#fff;border-radius:10px}
#lp-mpr .is-disabled{opacity:.6}
#lp-mpr .lp-suggestions{margin-top:10px;padding-top:10px;border-top:1px dashed #e5e7eb}
#lp-mpr .lp-suggestion{display:flex;gap:8px;align-items:flex-start;margin:6px 0;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:8px}
#lp-mpr .lp-suggestion .lp-sq{width:80px}
#lp-mpr .lp-suggestion .lp-remove{margin-left:auto}
#lp-mpr .lp-add{margin-top:6px}
#lp-mpr .select2-container{min-width:320px}
#lp-mpr .delta-badge{font-size:11px;padding:2px 6px;border-radius:999px;background:#eef2ff;color:#1d4ed8;margin-left:6px;white-space:nowrap}
#lp-mpr .mode{font-size:12px;color:#334155}
</style>';

	echo '<div id="lp-mpr" role="group" aria-label="' . esc_attr__( 'Erstatninger for manglende varer', 'lilleprinsen' ) . '">';

	$stats = array( 'active' => 0, 'suggestions' => 0 );
	foreach ( $saved as $row ) {
	if ( ! empty( $row['enabled'] ) ) $stats['active']++;
	if ( ! empty( $row['suggestions'] ) && is_array( $row['suggestions'] ) ) $stats['suggestions'] += count( $row['suggestions'] );
	}
	$line_items_count = count( $order->get_items( 'line_item' ) );

	echo '<div class="lp-header">';
	echo '<div><p class="lp-eyebrow">' . esc_html__( 'Oversikt', 'lilleprinsen' ) . '</p><p class="lp-title">' . esc_html__( 'Manglende varer & forslag', 'lilleprinsen' ) . '</p></div>';
	echo '<div class="lp-chips">';
	echo '<span class="lp-chip">ðŸ“¦ ' . esc_html( sprintf( _n( '%d varelinje', '%d varelinjer', $line_items_count, 'lilleprinsen' ), $line_items_count ) ) . '</span>';
	echo '<span class="lp-chip">âœ… ' . esc_html( sprintf( _n( '%d aktiv', '%d aktive', $stats['active'], 'lilleprinsen' ), $stats['active'] ) ) . '</span>';
	echo '<span class="lp-chip">ðŸ’¡ ' . esc_html( sprintf( _n( '%d forslag', '%d forslag', $stats['suggestions'], 'lilleprinsen' ), $stats['suggestions'] ) ) . '</span>';
echo '</div>';
echo '</div>';
echo '<p class="lp-note">' . esc_html__( 'Stegene ligger nederst for Ã¥ gi deg full oversikt â€“ merk linjene som mangler, legg til forslag og send lenke til kunden.', 'lilleprinsen' ) . '</p>';

foreach ( $order->get_items( 'line_item' ) as $item_id => $item ) {
		$name         = $item->get_name();
		$variation_id = $item->get_variation_id();
		$ordered_qty  = (int) $item->get_quantity();

		$key       = (string) $item_id;
		$row_saved = isset( $saved[ $key ] ) && is_array( $saved[ $key ] ) ? $saved[ $key ] : array();

		$enabled   = ! empty( $row_saved['enabled'] );
		$qty_val   = isset( $row_saved['qty'] ) ? max( 0, (int) $row_saved['qty'] ) : 0;

		$unit = lp_mpr_get_line_unit_prices( $order, $item );
		$orig_unit_gross = (float) $unit['unit_gross_total'];

		$suggestions = array();
		if ( ! empty( $row_saved['suggestions'] ) && is_array( $row_saved['suggestions'] ) ) {
			foreach ( $row_saved['suggestions'] as $sug ) {
				$pid = isset( $sug['product_id'] ) ? absint( $sug['product_id'] ) : 0;
				$sq  = isset( $sug['qty'] ) ? max( 0, (int) $sug['qty'] ) : 0;
				$mode= isset( $sug['mode'] ) ? (string) $sug['mode'] : ''; // 'customer_pays' | 'store_covers'
				if ( $pid && $sq > 0 ) {
					$p = wc_get_product( $pid );
					if ( $p ) {
						$delta = lp_mpr_calc_delta_gross( $orig_unit_gross, $p, $sq, $order );
						if ( $mode === '' ) $mode = $delta > 0 ? 'customer_pays' : 'store_covers';
						$suggestions[] = array(
							'product_id' => $p->get_id(),
							'label'      => wp_strip_all_tags( $p->get_formatted_name() ),
							'qty'        => $sq,
							'mode'       => $mode,
							'delta'      => $delta,
						);
					}
				}
			}
		}

		$checkbox_id = 'lp-enable-' . (int) $item_id;
		$qty_id      = 'lp-qty-' . (int) $item_id;

		echo '<div class="lp-row' . ( $enabled ? '' : ' is-disabled' ) . '" data-item-id="' . esc_attr( $item_id ) . '" data-order-id="' . esc_attr( $order->get_id() ) . '">';

		echo '<div class="lp-top">';
		echo '<div>';
		echo '<input type="checkbox" id="' . esc_attr( $checkbox_id ) . '" class="lp-enable" name="lp_replacements[' . esc_attr( $key ) . '][enabled]" value="1" ' . checked( $enabled, true, false ) . '>';
		echo '<label class="sr-only" for="' . esc_attr( $checkbox_id ) . '">' . esc_html__( 'Bruk erstatning for denne linja', 'lilleprinsen' ) . '</label>';
		echo '</div>';

		echo '<div class="lp-name">';
		echo esc_html( $name );
		if ( $variation_id ) echo '<br><small class="muted">#' . esc_html( $variation_id ) . '</small>';
		echo '</div>';

		echo '<input type="number" ' . ( $enabled ? '' : 'disabled' ) . ' id="' . esc_attr( $qty_id ) . '" class="lp-qty" min="0" max="' . esc_attr( $ordered_qty ) . '" step="1" name="lp_replacements[' . esc_attr( $key ) . '][qty]" value="' . esc_attr( $qty_val ) . '" aria-label="' . esc_attr__( 'Manglende antall (som skal erstattes)', 'lilleprinsen' ) . '" aria-describedby="' . esc_attr( $qty_id ) . '-desc">';
		echo '<div class="lp-preview" id="' . esc_attr( $qty_id ) . '-desc" aria-live="polite" data-ordered="' . esc_attr( $ordered_qty ) . '">' . esc_html( $qty_val . '/' . $ordered_qty ) . '</div>';
		echo '</div>';

		echo '<div class="lp-suggestions">';
		echo '<div class="lp-suggestion-rows" data-name-prefix="lp_replacements[' . esc_attr( $key ) . '][suggestions]">';

		if ( $enabled && ! empty( $suggestions ) ) {
			foreach ( $suggestions as $idx => $sug ) {
				$select_id = 'lp-sel-' . (int) $item_id . '-' . (int) $idx;
				$sq_id     = 'lp-sq-' . (int) $item_id . '-' . (int) $idx;
				$mode_name = 'lp_replacements[' . esc_attr( $key ) . '][suggestions][' . esc_attr( $idx ) . '][mode]';
				echo '<div class="lp-suggestion" data-idx="' . esc_attr( $idx ) . '">';
				echo '<select ' . ( $enabled ? '' : 'disabled' ) . ' id="' . esc_attr( $select_id ) . '" class="wc-product-search lp-sel" style="width:100%" name="lp_replacements[' . esc_attr( $key ) . '][suggestions][' . esc_attr( $idx ) . '][product_id]" data-placeholder="' . esc_attr__( 'SÃ¸k etter erstatning â€¦', 'lilleprinsen' ) . '" data-action="' . esc_attr( apply_filters( 'lp_mpr_search_action', 'lp_mpr_search_products_with_stock' ) ) . '" data-allow_clear="true">';
				echo '<option value="' . esc_attr( $sug['product_id'] ) . '" selected="selected">' . esc_html( $sug['label'] ) . '</option>';
				echo '</select>';
				$sign = $sug['delta'] > 0 ? '+ ' : ( $sug['delta'] < 0 ? 'âˆ’ ' : '' );
				$delta_html = $sign . wc_price( abs( $sug['delta'] ), array( 'currency' => $order->get_currency() ) );
				echo '<span class="delta-badge" title="' . esc_attr__( 'Prisforskjell for valgt antall', 'lilleprinsen' ) . '">' . wp_kses_post( $delta_html ) . '</span>';
				echo '<input type="number" ' . ( $enabled ? '' : 'disabled' ) . ' id="' . esc_attr( $sq_id ) . '" class="lp-sq" min="0" step="1" name="lp_replacements[' . esc_attr( $key ) . '][suggestions][' . esc_attr( $idx ) . '][qty]" value="' . esc_attr( (int) $sug['qty'] ) . '" aria-label="' . esc_attr__( 'ForeslÃ¥tt antall for dette produktet', 'lilleprinsen' ) . '">';
				$mode_name_attr = esc_attr( $mode_name );
				echo '<label class="mode"><input type="radio" name="'.$mode_name_attr.'" value="customer_pays" '.checked($sug['mode'],'customer_pays',false).'/> ' . esc_html__( 'Kunden betaler', 'lilleprinsen' ) . '</label>';
				echo '<label class="mode" style="margin-left:8px;"><input type="radio" name="'.$mode_name_attr.'" value="store_covers" '.checked($sug['mode'],'store_covers',false).'/> ' . esc_html__( 'Butikken dekker', 'lilleprinsen' ) . '</label>';
				echo '<button type="button" class="button lp-remove" ' . ( $enabled ? '' : 'disabled' ) . ' aria-label="' . esc_attr__( 'Fjern forslag', 'lilleprinsen' ) . '">Ã—</button>';
				echo '</div>';
			}
		}

		echo '</div>'; // rows
		echo '<button type="button" class="button lp-add" ' . ( $enabled ? '' : 'disabled' ) . '>' . esc_html__( 'Legg til forslag', 'lilleprinsen' ) . '</button>';
		echo '<p class="description" style="margin:6px 0 0;">' . esc_html__( 'Kunden kan godkjenne ett eller flere forslag, men summen kan ikke vÃ¦re hÃ¸yere enn manglende antall.', 'lilleprinsen' ) . '</p>';
		echo '</div>'; // suggestions

		echo '</div>'; // row
	}

	echo '<div class="lp-actions">';
	echo '<p style="margin:0 0 6px;"><label for="lp_mpr_message" style="font-weight:600;">' . esc_html__( 'Send forslag til kunden', 'lilleprinsen' ) . '</label><br>';
	echo '<textarea id="lp_mpr_message" name="lp_mpr_message" rows="3" placeholder="' . esc_attr__( 'Valgfri melding â€¦', 'lilleprinsen' ) . '"></textarea></p>';
	echo '<p style="margin:6px 0 0;"><button type="button" class="button button-primary" id="lp-mpr-send-btn" disabled>' . esc_html__( 'Send forslag', 'lilleprinsen' ) . '</button> ';
	echo '<span class="description">' . esc_html__( 'Sender en lenke til egen portal via kunde-notat e-post.', 'lilleprinsen' ) . '</span></p>';
	echo '</div>';

	echo '</div>'; // #lp-mpr
	?>
	<script>
	jQuery(function($){
		const previewNonce = '<?php echo esc_js( wp_create_nonce( 'lp_mpr_preview_delta' ) ); ?>';

		function initProductSearch($ctx){
			const $els = $ctx ? $ctx.find('.wc-product-search').filter(':not(.enhanced)') : $('.wc-product-search').filter(':not(.enhanced)');
			if ( $.fn.wc_product_search ) {
				$els.each(function(){ $(this).addClass('enhanced').wc_product_search(); });
			} else if ( $.fn.selectWoo ) {
				$els.each(function(){
					const $el = $(this);
					const actionName = $el.data('action') || 'lp_mpr_search_products_with_stock';
					$el.addClass('enhanced').selectWoo({
						allowClear: true,
						minimumInputLength: 2,
						ajax: {
							url: ajaxurl, dataType: 'json', delay: 250,
							data: function(params){ return { term: params.term || '', action: actionName, security: '<?php echo esc_js( wp_create_nonce( 'search-products' ) ); ?>' }; },
							processResults: function(data){ const results = []; $.each(data, function(id, text){ results.push({id:id, text:text}); }); return { results: results }; }
						},
						width: '100%'
					});
				});
			}
		}
		initProductSearch();

		function toggleRow($row, on){
			$row.toggleClass('is-disabled', !on);
			$row.find('.lp-qty, .wc-product-search, .lp-add, .lp-remove, .lp-sq, .mode input').prop('disabled', !on).trigger('change.select2');
		}
		$('#lp-mpr').on('change', '.lp-enable', function(){ toggleRow($(this).closest('.lp-row'), this.checked); refreshSendState(); });
		$('#lp-mpr .lp-row').each(function(){ toggleRow($(this), $(this).find('.lp-enable').is(':checked')); });

		$('#lp-mpr').on('input change', '.lp-qty', function(){
			const $row = $(this).closest('.lp-row');
			const ordered = parseInt($row.find('.lp-preview').attr('data-ordered'), 10) || 0;
			let chosen  = parseInt(this.value || '0', 10); if (isNaN(chosen)) chosen = 0;
			chosen = Math.max(0, Math.min(ordered, chosen)); this.value = chosen;
			$row.find('.lp-preview').text(chosen + '/' + ordered); refreshSendState();
		});

		// --- FIKS: robust beregning av neste index (tar hÃ¸yde for slettinger) ---
		function nextIndex($container){
			let maxIdx = -1;
			$container.children('.lp-suggestion').each(function(){
				const i = parseInt($(this).attr('data-idx') || '-1', 10);
				if (!isNaN(i)) maxIdx = Math.max(maxIdx, i);
			});
			return maxIdx + 1;
		}

		function recalcDelta($sug){
			const $row = $sug.closest('.lp-row');
			const orderId = parseInt($row.data('order-id'), 10) || 0;
			const itemId  = parseInt($row.data('item-id'), 10) || 0;
			const productId = parseInt($sug.find('.lp-sel').val(), 10) || 0;
			const qty = parseInt($sug.find('.lp-sq').val(), 10) || 0;
			if(!orderId || !itemId || !productId || !qty){
				$sug.find('.delta-badge').html('<?php echo wp_kses_post( wc_price( 0 ) ); ?>');
				return;
			}
			$.post(ajaxurl, { action:'lp_mpr_preview_delta', nonce: previewNonce, order_id: orderId, item_id: itemId, product_id: productId, qty: qty })
			.done(function(resp){ if(resp && resp.success && resp.data && resp.data.html){ $sug.find('.delta-badge').html(resp.data.html); } });
		}

		// Legg til forslag
		$(document).on('click', '#lp-mpr .lp-add', function(e){
			e.preventDefault();
			const $row = $(this).closest('.lp-row');
			const $container = $row.find('.lp-suggestion-rows');
			const prefix = $container.data('name-prefix');
			const itemId = $row.data('item-id');
			const idx = nextIndex($container);
			const selId = 'lp-sel-' + itemId + '-' + idx;
			const sqId  = 'lp-sq-' + itemId + '-' + idx;
			const modeName = prefix+'['+ idx +'][mode]';

			const html =
			'<div class="lp-suggestion" data-idx="'+ idx +'">\
				<select id="'+ selId +'" class="wc-product-search lp-sel" style="width:100%" \
					name="'+ prefix +'['+ idx +'][product_id]" \
					data-placeholder="<?php echo esc_js( __( 'SÃ¸k etter erstatning â€¦', 'lilleprinsen' ) ); ?>" \
					data-action="<?php echo esc_js( apply_filters( 'lp_mpr_search_action', 'lp_mpr_search_products_with_stock' ) ); ?>" \
					data-allow_clear="true"></select>\
				<span class="delta-badge"><?php echo wp_kses_post( wc_price( 0 ) ); ?></span>\
				<input type="number" id="'+ sqId +'" class="lp-sq" min="0" step="1" name="'+ prefix +'['+ idx +'][qty]" value="1" aria-label="<?php echo esc_js( __( 'ForeslÃ¥tt antall for dette produktet', 'lilleprinsen' ) ); ?>">\
				<label class="mode"><input type="radio" name="'+modeName+'" value="customer_pays" checked/> <?php echo esc_js( __( 'Kunden betaler', 'lilleprinsen' ) ); ?></label>\
				<label class="mode" style="margin-left:8px;"><input type="radio" name="'+modeName+'" value="store_covers"/> <?php echo esc_js( __( 'Butikken dekker', 'lilleprinsen' ) ); ?></label>\
				<button type="button" class="button lp-remove" aria-label="<?php echo esc_js( __( 'Fjern forslag', 'lilleprinsen' ) ); ?>">Ã—</button>\
			</div>';

			const $html = $(html);
			$container.append($html);
			initProductSearch($html);
			refreshSendState();
		});

		// Fjern forslag
		$(document).on('click', '#lp-mpr .lp-remove', function(e){
			e.preventDefault();
			$(this).closest('.lp-suggestion').remove();
			refreshSendState();
		});

		// Delta-live
		$(document).on('change input', '#lp-mpr .lp-suggestion .lp-sel, #lp-mpr .lp-suggestion .lp-sq', function(){ recalcDelta($(this).closest('.lp-suggestion')); });
		$('#lp-mpr .lp-suggestion').each(function(){ recalcDelta($(this)); });

		// Send-fanen
		const $orderForm = $('#post').length ? $('#post') : $('#lp-mpr').closest('form'); if (!$orderForm.attr('id')) $orderForm.attr('id','lp-mpr-form');

		function collectEnabledRows(){
			const rows = [];
			$('#lp-mpr .lp-row').each(function(){
				const $row = $(this);
				const enabled = $row.find('.lp-enable').is(':checked');
				if (!enabled) return;
				const missingQty = parseInt($row.find('.lp-qty').val(), 10) || 0;
				if (missingQty <= 0) return;
				let hasSuggestion = false;
				$row.find('.lp-suggestion').each(function(){
					const pid = $(this).find('.lp-sel').val();
					const sq  = parseInt($(this).find('.lp-sq').val(), 10) || 0;
					if (pid && sq > 0) { hasSuggestion = true; }
				});
				if (hasSuggestion) rows.push(true);
			});
			return rows;
		}
		function refreshSendState(){ $('#lp-mpr-send-btn').prop('disabled', collectEnabledRows().length === 0); }
		$(document).on('change input', '#lp-mpr .lp-sel, #lp-mpr .lp-sq, #lp-mpr .mode input', refreshSendState);
		refreshSendState();

		// Send forslag
		$(document).on('click', '#lp-mpr #lp-mpr-send-btn', function(e){
			e.preventDefault();
			const $btn = $(this);
			$btn.prop('disabled', true);
			const data = $orderForm.serializeArray();
			data.push({ name: 'action',   value: 'lp_mpr_send_suggestion' });
			data.push({ name: 'order_id', value: '<?php echo esc_js( $order->get_id() ); ?>' });
			$.post(ajaxurl, data)
			.done(function(resp){
				if (resp && resp.success) {
					alert(resp.data && resp.data.message ? resp.data.message : '<?php echo esc_js( __( 'Forslaget ble sendt til kunden.', 'lilleprinsen' ) ); ?>');
					location.reload();
				} else {
					alert((resp && resp.data && resp.data.message) || '<?php echo esc_js( __( 'Klarte ikke Ã¥ sende forslaget.', 'lilleprinsen' ) ); ?>');
				}
			})
			.fail(function(){ alert('<?php echo esc_js( __( 'Nettverksfeil. PrÃ¸v igjen.', 'lilleprinsen' ) ); ?>'); })
			.always(function(){ $btn.prop('disabled', false); });
		});
	});
	</script>
	<?php
}
/** Lagre verdier fra admin-metaboks (inkl. modus per forslag) */
add_action( 'woocommerce_process_shop_order_meta', function( $order_id ) {
	if ( ! isset( $_POST['lp_missing_replacements_nonce'] ) || ! wp_verify_nonce( $_POST['lp_missing_replacements_nonce'], 'lp_missing_replacements_save' ) ) return;
	if ( ! current_user_can( 'edit_shop_order', $order_id ) ) return;
	$order = wc_get_order( $order_id );
	if ( ! $order ) return;

	$raw = isset( $_POST['lp_replacements'] ) && is_array( $_POST['lp_replacements'] ) ? wp_unslash( $_POST['lp_replacements'] ) : array();

	$clean = array();
	foreach ( $order->get_items( 'line_item' ) as $item_id => $item ) {
		$key = (string) $item_id;
		if ( empty( $raw[ $key ] ) || ! is_array( $raw[ $key ] ) ) continue;
		$row = $raw[ $key ];

		$enabled     = ! empty( $row['enabled'] );
		$qty_posted  = isset( $row['qty'] ) ? (int) $row['qty'] : 0;
		$ordered     = (int) $item->get_quantity();
		$missing_qty = max( 0, min( $ordered, $qty_posted ) );

		$sugs_clean = array();
		if ( ! empty( $row['suggestions'] ) && is_array( $row['suggestions'] ) ) {
			foreach ( $row['suggestions'] as $sug ) {
				$pid  = isset( $sug['product_id'] ) ? absint( $sug['product_id'] ) : 0;
				$sq   = isset( $sug['qty'] ) ? (int) $sug['qty'] : 0;
				$mode = isset( $sug['mode'] ) ? sanitize_key( $sug['mode'] ) : '';
				$sq   = max( 0, $sq );
				if ( $pid && $sq > 0 ) {
					$p = wc_get_product( $pid );
					if ( $p ) {
						if ( $mode !== 'customer_pays' && $mode !== 'store_covers' ) {
							$unit = lp_mpr_get_line_unit_prices( $order, $item );
							$delta = lp_mpr_calc_delta_gross( (float) $unit['unit_gross_total'], $p, $sq, $order );
							$mode = $delta > 0 ? 'customer_pays' : 'store_covers';
						}
						$sugs_clean[] = array( 'product_id' => $p->get_id(), 'qty' => $sq, 'mode' => $mode );
					}
				}
			}
		}

		if ( $enabled && $missing_qty > 0 && ! empty( $sugs_clean ) ) {
			$clean[ $key ] = array(
				'enabled'     => 1,
				'qty'         => $missing_qty,
				'suggestions' => array_values( $sugs_clean ),
			);
		}
	}

	if ( ! empty( $clean ) ) {
		$order->update_meta_data( '_lp_missing_replacements', $clean );
	} else {
		$order->delete_meta_data( '_lp_missing_replacements' );
	}
	$order->save();
}, 20 );

/** Bygg portal-URL (ren rute) */
function lp_mpr_build_portal_url( WC_Order $order, $issue_ver = 0 ) : string {
	$order_id = $order->get_id();
	$key      = $order->get_order_key();
	$base     = user_trailingslashit( trailingslashit( home_url( 'lp-mpr/' . $order_id . '/' . rawurlencode( $key ) ) ) );
	if ( $issue_ver ) $base = add_query_arg( 'v', (int) $issue_ver, $base );
	return $base;
}
add_filter( 'lp_mpr_portal_url', function( $url, $order_id ){
	$order = wc_get_order( $order_id );
	if ( ! $order ) return $url;
	$issue = (array) $order->get_meta( '_lp_mpr_issue', true );
	$ver = (int) ( $issue['ver'] ?? 0 );
	return lp_mpr_build_portal_url( $order, $ver );
}, 10, 2 );

/** AJAX: send forslag pÃ¥ e-post med portal-lenke (gjenÃ¥pner issue) */
add_action( 'wp_ajax_lp_mpr_send_suggestion', 'lp_mpr_send_suggestion' );
function lp_mpr_send_suggestion() {
	if ( empty( $_POST['order_id'] ) ) wp_send_json_error( array( 'message' => __( 'Mangler ordre-ID.', 'lilleprinsen' ) ) );
	$order_id = absint( $_POST['order_id'] );
	$order    = wc_get_order( $order_id );
	if ( ! $order ) wp_send_json_error( array( 'message' => __( 'Fant ikke ordren.', 'lilleprinsen' ) ) );
	if ( ! current_user_can( 'edit_shop_order', $order_id ) ) wp_send_json_error( array( 'message' => __( 'Du har ikke tilgang til dette.', 'lilleprinsen' ) ) );
	if ( empty( $_POST['lp_mpr_send_suggestion_nonce'] ) || ! wp_verify_nonce( $_POST['lp_mpr_send_suggestion_nonce'], 'lp_mpr_send_suggestion' ) ) {
		wp_send_json_error( array( 'message' => __( 'Sikkerhetssjekk feilet.', 'lilleprinsen' ) ) );
	}

	// PersistÃ©r siste admin-valg
	$raw = isset( $_POST['lp_replacements'] ) && is_array( $_POST['lp_replacements'] ) ? wp_unslash( $_POST['lp_replacements'] ) : array();

	$clean = array();
	foreach ( $order->get_items( 'line_item' ) as $item_id => $item ) {
		$key = (string) $item_id;
		if ( empty( $raw[ $key ] ) || ! is_array( $raw[ $key ] ) ) continue;
		$row = $raw[ $key ];

		$enabled     = ! empty( $row['enabled'] );
		$qty_posted  = isset( $row['qty'] ) ? (int) $row['qty'] : 0;
		$ordered     = (int) $item->get_quantity();
		$missing_qty = max( 0, min( $ordered, $qty_posted ) );

		$sugs_clean = array();
		if ( ! empty( $row['suggestions'] ) && is_array( $row['suggestions'] ) ) {
			foreach ( $row['suggestions'] as $sug ) {
				$pid  = isset( $sug['product_id'] ) ? absint( $sug['product_id'] ) : 0;
				$sq   = isset( $sug['qty'] ) ? (int) $sug['qty'] : 0;
				$mode = isset( $sug['mode'] ) ? sanitize_key( $sug['mode'] ) : '';
				$sq   = max( 0, $sq );
				if ( $pid && $sq > 0 ) {
					$p = wc_get_product( $pid );
					if ( $p ) {
						if ( $mode !== 'customer_pays' && $mode !== 'store_covers' ) {
							$unit = lp_mpr_get_line_unit_prices( $order, $item );
							$delta = lp_mpr_calc_delta_gross( (float) $unit['unit_gross_total'], $p, $sq, $order );
							$mode = $delta > 0 ? 'customer_pays' : 'store_covers';
						}
						$sugs_clean[] = array( 'product_id' => $p->get_id(), 'qty' => $sq, 'mode' => $mode );
					}
				}
			}
		}

		if ( $enabled && $missing_qty > 0 && ! empty( $sugs_clean ) ) {
			$clean[ $key ] = array(
				'enabled'     => 1,
				'qty'         => $missing_qty,
				'suggestions' => array_values( $sugs_clean ),
			);
		}
	}

	if ( ! empty( $clean ) ) {
		$order->update_meta_data( '_lp_missing_replacements', $clean );
	} else {
		$order->delete_meta_data( '_lp_missing_replacements' );
		$order->save();
		wp_send_json_error( array( 'message' => __( 'Ingen gyldige forslag Ã¥ sende.', 'lilleprinsen' ) ) );
	}

	// GjenÃ¥pne "issue"
	$issue = (array) $order->get_meta( '_lp_mpr_issue', true );
	$ver   = isset( $issue['ver'] ) ? (int) $issue['ver'] : 0;
	$ver++;
	$order->update_meta_data( '_lp_mpr_issue', array(
		'ver'      => $ver,
		'consumed' => false,
		'sent_at'  => time(),
	) );
	$order->save();

	// Throttle
	$throttle_key = 'lp_mpr_sent_' . $order_id;
	if ( get_transient( $throttle_key ) ) {
		wp_send_json_error( array( 'message' => __( 'Forslag ble nettopp sendt. Vent et lite Ã¸yeblikk fÃ¸r du sender igjen.', 'lilleprinsen' ) ) );
	}
	set_transient( $throttle_key, 1, MINUTE_IN_SECONDS * 2 );

	// Ny portal-lenke
	$url = apply_filters( 'lp_mpr_portal_url', '', $order_id );

	// Kunde-notat
	$extra = isset( $_POST['lp_mpr_message'] ) ? wp_kses_post( wp_unslash( $_POST['lp_mpr_message'] ) ) : '';
	$note  = $extra ? $extra . "\n\n" : '';
	$note .= sprintf( __( 'Vi har foreslÃ¥tt alternativer for varer vi mangler. Ã…pne portalen her: %s', 'lilleprinsen' ), esc_url( $url ) );
	$order->add_order_note( $note, true );

	do_action( 'lp_mpr_suggestion_emailed', $order, $url, $clean );

	wp_send_json_success( array( 'message' => __( 'Forslaget ble sendt til kunden.', 'lilleprinsen' ), 'url' => $url ) );
}

/* ==========================================================
 *           PORTAL â€“ rewrite + query vars + hooks
 * ========================================================== */

function lp_mpr_register_portal_route() {
	add_rewrite_rule( '^lp-mpr/([0-9]+)/([^/]+)/?$', 'index.php?lp_mpr_portal=1&lp_mpr_order_id=$matches[1]&lp_mpr_key=$matches[2]', 'top' );
}
add_action( 'init', 'lp_mpr_register_portal_route' );

add_filter( 'query_vars', function( $vars ){
	$vars[] = 'lp_mpr_portal';
	$vars[] = 'lp_mpr_order_id';
	$vars[] = 'lp_mpr_key';
	return $vars;
} );

/** Flush rewrites pÃ¥ aktivering/oppdatering */
register_activation_hook( __FILE__, function(){
	lp_mpr_register_portal_route();
	flush_rewrite_rules();
} );
register_deactivation_hook( __FILE__, function(){
	flush_rewrite_rules();
} );

/* ==========================================================
 *                 PORTAL-AJAX (gjestesikker) â€” del 1
 * ========================================================== */

add_action( 'wp_ajax_lp_mpr_portal_action', 'lp_mpr_portal_action' );
add_action( 'wp_ajax_nopriv_lp_mpr_portal_action', 'lp_mpr_portal_action' );
function lp_mpr_portal_action() {
	$which      = isset( $_POST['which'] ) ? sanitize_key( wp_unslash( $_POST['which'] ) ) : '';
	$order_id   = isset( $_POST['order_id'] ) ? absint( $_POST['order_id'] ) : 0;
	$order_key  = isset( $_POST['order_key'] ) ? (string) $_POST['order_key'] : '';
	$nonce      = isset( $_POST['nonce'] ) ? (string) $_POST['nonce'] : '';
	$issue_ver  = isset( $_POST['issue_ver'] ) ? (int) $_POST['issue_ver'] : -1;

	if ( ! wp_verify_nonce( $nonce, 'lp_mpr_portal_action' ) ) wp_send_json_error( array( 'message' => __( 'Sikkerhetssjekk feilet.', 'lilleprinsen' ) ) );

	$order = $order_id ? wc_get_order( $order_id ) : false;
	if ( ! $order ) wp_send_json_error( array( 'message' => __( 'Fant ikke ordren.', 'lilleprinsen' ) ) );

	// Sjekk kunde-kontekst
	$ok_context = false;
	if ( is_user_logged_in() ) {
		$ok_context = ( (int) $order->get_user_id() === (int) get_current_user_id() ) || current_user_can( 'edit_shop_order', $order_id );
	} else {
		$ok_context = ( $order_key && $order->get_order_key() === $order_key );
	}
	if ( ! $ok_context ) wp_send_json_error( array( 'message' => __( 'Du har ikke tilgang til denne ordren.', 'lilleprinsen' ) ) );

	// liten throttle
	$ip   = isset( $_SERVER['REMOTE_ADDR'] ) ? sanitize_text_field( wp_unslash( $_SERVER['REMOTE_ADDR'] ) ) : '0.0.0.0';
	$thk  = 'lp_mpr_th_' . md5( $order_id . '|' . $which . '|' . $ip );
	if ( get_transient( $thk ) ) wp_send_json_error( array( 'message' => __( 'Vent et lite Ã¸yeblikk fÃ¸r du prÃ¸ver igjen.', 'lilleprinsen' ) ) );
	set_transient( $thk, 1, 5 );

	$allowed = array( 'approve_update', 'delete_missing' );
	if ( ! in_array( $which, $allowed, true ) ) wp_send_json_error( array( 'message' => __( 'Ukjent handling.', 'lilleprinsen' ) ) );

	// Versjonssjekk
	$issue = (array) $order->get_meta( '_lp_mpr_issue', true );
	$cur_ver = isset( $issue['ver'] ) ? (int) $issue['ver'] : 0;
	if ( $issue_ver >= 0 && $issue_ver !== $cur_ver ) wp_send_json_error( array( 'message' => __( 'Denne lenken er utlÃ¸pt. Bruk den siste vi sendte.', 'lilleprinsen' ) ) );

	// Blokker hvis allerede konsumert (flag settes ved suksess)
	if ( ! empty( $issue['consumed'] ) ) wp_send_json_error( array( 'message' => __( 'Denne forespÃ¸rselen er allerede besvart.', 'lilleprinsen' ) ) );

	$data = (array) $order->get_meta( '_lp_missing_replacements', true );
	/* ===== approve_update ===== */
	if ( $which === 'approve_update' ) {
		$sel_raw = isset( $_POST['selections'] ) ? wp_unslash( $_POST['selections'] ) : array();

		if ( is_string( $sel_raw ) ) {
			$decoded = json_decode( $sel_raw, true );
			if ( json_last_error() !== JSON_ERROR_NONE || ! is_array( $decoded ) ) $decoded = maybe_unserialize( $sel_raw );
			if ( is_array( $decoded ) ) $sel_raw = $decoded;
		}
		$selections = is_array( $sel_raw ) ? wc_clean( $sel_raw ) : array();
		if ( empty( $selections ) ) { $order->add_order_note( 'MPR portal: tomt valg fra kunden.', false ); wp_send_json_error( array( 'message' => __( 'Vi mottok ingen valg.', 'lilleprinsen' ) ) ); }

		// Cap mot "missing"
		foreach ( $selections as $item_id_str => $indexes ) {
			$item_id = absint( $item_id_str ); $key = (string) $item_id;
			$missing_qty = isset( $data[ $key ]['qty'] ) ? max( 0, (int) $data[ $key ]['qty'] ) : 0;
			$sugs        = ! empty( $data[ $key ]['suggestions'] ) ? array_values( $data[ $key ]['suggestions'] ) : array();
			$chosen_total = 0;
			if ( is_array( $indexes ) ) foreach ( $indexes as $i ) if ( isset( $sugs[ $i ] ) ) $chosen_total += max( 0, (int) ( $sugs[ $i ]['qty'] ?? 0 ) );
			if ( $missing_qty > 0 && $chosen_total > $missing_qty ) { $order->add_order_note( 'MPR portal: over-valg blokkert.', false ); wp_send_json_error( array( 'message' => __( 'Valgt antall er for hÃ¸yt i forhold til det som mangler.', 'lilleprinsen' ) ) ); }
		}

		// Lager-sjekk + reservasjon
		$want = array(); // pid => qty
		foreach ( $selections as $item_id_str => $indexes ) {
			$item_id = absint( $item_id_str ); $key = (string) $item_id;
			$sugs = ! empty( $data[ $key ]['suggestions'] ) ? array_values( $data[ $key ]['suggestions'] ) : array();
			if ( ! is_array( $indexes ) ) continue;
			foreach ( $indexes as $i ) {
				$i = absint( $i );
				if ( isset( $sugs[ $i ] ) ) {
					$pid = absint( $sugs[ $i ]['product_id'] ?? 0 );
					$qty = max( 0, (int) ( $sugs[ $i ]['qty'] ?? 0 ) );
					if ( $pid && $qty > 0 ) $want[$pid] = ($want[$pid] ?? 0) + $qty;
				}
			}
		}

		$reserved = array();
		foreach ( $want as $pid => $qty ) {
			if ( apply_filters( 'lp_mpr_skip_external_stock_manager', false, $pid ) ) continue;
			$p = wc_get_product( $pid );
			if ( ! $p || ! $p->is_purchasable() ) wp_send_json_error( array( 'message' => sprintf( __( 'Erstatningsprodukt #%d er ikke kjÃ¸pbart lenger.', 'lilleprinsen' ), $pid ) ) );
			if ( $p->backorders_allowed() ) continue;
			if ( $p->managing_stock() ) {
				$have = (int) $p->get_stock_quantity();
				if ( $have < $qty ) wp_send_json_error( array( 'message' => sprintf( __( 'Beklager! %1$s har bare %3$d pÃ¥ lager, men du valgte %2$d.', 'lilleprinsen' ), wp_strip_all_tags( $p->get_formatted_name() ), $qty, max(0,$have) ) ) );
				$updated = wc_update_product_stock( $p, $qty, 'decrease' );
				if ( is_wp_error( $updated ) ) wp_send_json_error( array( 'message' => __( 'Kunne ikke reservere lager for valgt vare.', 'lilleprinsen' ) ) );
				$reserved[ $pid ] = $qty;
			} else {
				if ( ! $p->is_in_stock() ) wp_send_json_error( array( 'message' => sprintf( __( '%s er ikke pÃ¥ lager lenger.', 'lilleprinsen' ), wp_strip_all_tags( $p->get_formatted_name() ) ) ) );
			}
		}

		$payload = lp_mpr_build_payload( $order, $data, $selections, array( 'reserved_products' => $reserved, 'issue_ver' => $cur_ver ) );
		if ( empty( $payload['items'] ) && empty( $payload['delete_only'] ) ) { $order->add_order_note( __( 'MPR: Ingen gyldige valg i payload.', 'lilleprinsen' ), false ); wp_send_json_error( array( 'message' => __( 'Ingen gyldige valg funnet.', 'lilleprinsen' ) ) ); }

		$hash = lp_mpr_selection_hash( $payload );
		$pending = (array) $order->get_meta( '_lp_mpr_pending', true );
		$pending['hash']    = $hash;
		$pending['payload'] = $payload;
		$order->update_meta_data( '_lp_mpr_pending', $pending );

		// RegistrÃ©r reservasjoner (med TTL)
		if ( ! empty( $reserved ) ) {
			$order->update_meta_data( '_lp_mpr_reservations', array(
				'products'   => $reserved,
				'expires_at' => time() + lp_mpr_reservation_ttl_seconds(),
				'issue_ver'  => $cur_ver,
			) );
		}
		$order->save();

		// Planlegg APPLY + RELEASE
		if ( function_exists( 'as_schedule_single_action' ) ) {
			if ( function_exists( 'as_unschedule_all_actions' ) ) as_unschedule_all_actions( LP_MPR_JOB_ACTION, array( $order->get_id() ), LP_MPR_JOB_GROUP );
			as_schedule_single_action( time() + lp_mpr_debounce_seconds(), LP_MPR_JOB_ACTION, array( $order->get_id() ), LP_MPR_JOB_GROUP, true );

			$res = (array) $order->get_meta( '_lp_mpr_reservations', true );
			if ( ! empty( $res['expires_at'] ) ) as_schedule_single_action( (int) $res['expires_at'], LP_MPR_RELEASE_JOB_ACTION, array( $order->get_id(), $cur_ver ), LP_MPR_JOB_GROUP, true );

			$issue['consumed'] = true;
			$order->update_meta_data( '_lp_mpr_issue', $issue );
			$order->save();

			wp_send_json_success( array( 'ok' => true ) );
		} else {
			wp_send_json_error( array( 'message' => __( 'Action Scheduler finnes ikke; kan ikke kjÃ¸re i bakgrunnen.', 'lilleprinsen' ) ) );
		}
	}

	/* ===== delete_missing ===== */
	if ( $which === 'delete_missing' ) {
		$delete_items = array();
		foreach ( $order->get_items( 'line_item' ) as $item_id => $item ) {
			$key = (string) $item_id;
			if ( empty( $data[ $key ]['enabled'] ) ) continue;
			$missing = max( 0, (int) ( $data[ $key ]['qty'] ?? 0 ) );
			if ( $missing <= 0 ) continue;
			$delete_items[] = array( 'order_item_id' => (int) $item_id, 'missing_qty' => $missing );
		}
		if ( empty( $delete_items ) ) wp_send_json_error( array( 'message' => __( 'Ingen manglende linjer Ã¥ slette.', 'lilleprinsen' ) ) );

		$payload = array(
			'order_id'    => $order->get_id(),
			'delete_only' => $delete_items,
			'issue_ver'   => $cur_ver,
			'created_at'  => time(),
			'policy'      => array( 'shipping' => 'no_rerate', 'discounts' => 'freeze' ),
		);
		$hash = lp_mpr_selection_hash( $payload );
		$pending = (array) $order->get_meta( '_lp_mpr_pending', true );
		$pending['hash']    = $hash;
		$pending['payload'] = $payload;
		$order->update_meta_data( '_lp_mpr_pending', $pending );
		$order->save();

		if ( function_exists( 'as_schedule_single_action' ) ) {
			if ( function_exists( 'as_unschedule_all_actions' ) ) as_unschedule_all_actions( LP_MPR_JOB_ACTION, array( $order->get_id() ), LP_MPR_JOB_GROUP );
			as_schedule_single_action( time() + lp_mpr_debounce_seconds(), LP_MPR_JOB_ACTION, array( $order->get_id() ), LP_MPR_JOB_GROUP, true );

			$issue['consumed'] = true;
			$order->update_meta_data( '_lp_mpr_issue', $issue );
			$order->save();

			wp_send_json_success( array( 'ok' => true ) );
		} else {
			wp_send_json_error( array( 'message' => __( 'Action Scheduler finnes ikke; kan ikke kjÃ¸re i bakgrunnen.', 'lilleprinsen' ) ) );
		}
	}

	wp_send_json_success( array( 'ok' => true ) );
}

/* ========= PRODUKT-SÃ˜K (admin) + live deltavisning ========= */

add_action( 'wp_ajax_lp_mpr_search_products_with_stock', 'lp_mpr_search_products_with_stock' );
function lp_mpr_search_products_with_stock() {
	if ( ! current_user_can( 'edit_products' ) ) wp_send_json_error( array( 'message' => __( 'Du har ikke tilgang til dette.', 'lilleprinsen' ) ) );
	$nonce = isset( $_REQUEST['security'] ) ? wp_unslash( $_REQUEST['security'] ) : '';
	if ( ! wp_verify_nonce( $nonce, 'search-products' ) ) wp_send_json_error( array( 'message' => __( 'Sikkerhetssjekk feilet.', 'lilleprinsen' ) ) );

	$term = isset( $_REQUEST['term'] ) ? wc_clean( wp_unslash( $_REQUEST['term'] ) ) : '';
	$results       = array();
	$max           = (int) apply_filters( 'lp_mpr_search_limit', 30 );
	$only_in_stock = (bool) apply_filters( 'lp_mpr_search_only_in_stock', false );
	$max_children  = (int) apply_filters( 'lp_mpr_search_max_children', 50 );

	$products = wc_get_products( array(
		'status'  => array( 'publish', 'private' ),
		'limit'   => $max,
		'type'    => array( 'simple', 'variable' ),
		'orderby' => 'title',
		'order'   => 'ASC',
		's'       => (string) $term,
		'return'  => 'objects',
	) );
	foreach ( $products as $product ) {
		if ( $product->is_type( 'simple' ) ) {
			if ( $only_in_stock && ! $product->is_in_stock() ) continue;
			$results[ $product->get_id() ] = lp_mpr_format_label_with_stock( $product );
		} elseif ( $product->is_type( 'variable' ) ) {
			$children = array_slice( (array) $product->get_children(), 0, $max_children );
			foreach ( $children as $vid ) {
				if ( count( $results ) >= $max ) break;
				$variation = wc_get_product( $vid );
				if ( ! $variation || ! $variation->exists() ) continue;
				if ( $only_in_stock && ! $variation->is_in_stock() ) continue;
				$hay = strtolower( $variation->get_formatted_name() . ' ' . $variation->get_sku() );
				if ( $term === '' || strpos( $hay, strtolower( $term ) ) !== false ) $results[ $variation->get_id() ] = lp_mpr_format_label_with_stock( $variation );
			}
		}
	}
	if ( empty( $results ) && $term ) {
		$sku_id = wc_get_product_id_by_sku( $term );
		if ( $sku_id ) {
			$p = wc_get_product( $sku_id );
			if ( $p && ( ! $only_in_stock || $p->is_in_stock() ) ) $results[ $p->get_id() ] = lp_mpr_format_label_with_stock( $p );
		}
	}
	wp_send_json( $results );
}

function lp_mpr_format_label_with_stock( WC_Product $product ) : string {
	$name = wp_strip_all_tags( $product->get_formatted_name() );
	$sku  = $product->get_sku();
	$stock_text = $product->is_in_stock() ? __( 'PÃ¥ lager', 'lilleprinsen' ) : __( 'Tomt pÃ¥ lager', 'lilleprinsen' );
	if ( $product->managing_stock() ) {
		$q = $product->get_stock_quantity();
		$stock_text = is_null($q) ? $stock_text : sprintf( __( 'PÃ¥ lager: %d', 'lilleprinsen' ), (int) $q );
		if ( $product->backorders_allowed() && $product->get_stock_status() === 'onbackorder' ) $stock_text = __( 'Restordre', 'lilleprinsen' );
	}
	$bits = array( $name, $sku ? '['.$sku.']' : '', 'â€” ' . $stock_text );
	return trim( implode( ' ', array_filter( $bits ) ) );
}

add_action( 'wp_ajax_lp_mpr_preview_delta', function () {
	if ( ! current_user_can( 'edit_shop_orders' ) ) wp_send_json_error( array( 'message' => __( 'Mangler rettigheter.', 'lilleprinsen' ) ) );
	if ( empty( $_POST['nonce'] ) || ! wp_verify_nonce( wp_unslash( $_POST['nonce'] ), 'lp_mpr_preview_delta' ) ) wp_send_json_error( array( 'message' => __( 'Sikkerhetssjekk feilet.', 'lilleprinsen' ) ) );

	$order_id  = absint( $_POST['order_id'] ?? 0 );
	$item_id   = absint( $_POST['item_id'] ?? 0 );
	$product_id= absint( $_POST['product_id'] ?? 0 );
	$qty       = max( 0, intval( $_POST['qty'] ?? 0 ) );

	$order = wc_get_order( $order_id );
	$item  = $order ? $order->get_item( $item_id ) : false;
	$p     = $product_id ? wc_get_product( $product_id ) : false;

	if ( ! $order || ! $item || ! $p || $qty <= 0 ) {
		wp_send_json_success( array( 'html' => wp_kses_post( wc_price( 0, array( 'currency' => $order ? $order->get_currency() : get_woocommerce_currency() ) ) ) ) );
	}

	$unit = lp_mpr_get_line_unit_prices( $order, $item );
	$delta = lp_mpr_calc_delta_gross( (float) $unit['unit_gross_total'], $p, $qty, $order );
	$sign  = $delta > 0 ? '+ ' : ( $delta < 0 ? 'âˆ’ ' : '' );
	$html  = $sign . wc_price( abs( $delta ), array( 'currency' => $order->get_currency() ) );
	wp_send_json_success( array( 'html' => wp_kses_post( $html ) ) );
} );

/* ===== BUILD PAYLOAD + JOBB DRIVER + RESERVASJON RELEASE ===== */

function lp_mpr_build_payload( WC_Order $order, array $data, array $selections, array $opts = array() ) : array {
	$items = array();
	foreach ( $selections as $item_id_str => $indexes ) {
		$item_id = absint( $item_id_str ); $key = (string) $item_id;
		if ( empty( $data[ $key ]['enabled'] ) || empty( $data[ $key ]['suggestions'] ) ) continue;

		$order_item = $order->get_item( $item_id ); if ( ! $order_item || 'line_item' !== $order_item->get_type() ) continue;
		$orig_qty_total   = (int) $order_item->get_quantity();
		$missing_qty      = max( 0, (int) ( $data[ $key ]['qty'] ?? 0 ) );

		$qty_safe           = max( 1, $orig_qty_total );
		$unit_net_subtotal  = (float) $order_item->get_subtotal()     / $qty_safe;
		$unit_tax_subtotal  = (float) $order_item->get_subtotal_tax() / $qty_safe;
		$unit_net_total     = (float) $order_item->get_total()        / $qty_safe;
		$unit_tax_total     = (float) $order_item->get_total_tax()    / $qty_safe;

		$unit_gross_subtotal = $unit_net_subtotal + $unit_tax_subtotal;
		$unit_gross_total    = $unit_net_total    + $unit_tax_total;

		$orig_tax_class = $order_item->get_tax_class();

		$sugs   = array_values( $data[ $key ]['suggestions'] );
		$chosen = array();
		if ( is_array( $indexes ) ) {
			foreach ( $indexes as $i ) {
				$i = absint( $i );
				if ( isset( $sugs[ $i ] ) ) {
					$pid  = absint( $sugs[ $i ]['product_id'] ?? 0 );
					$sq   = max( 0, (int) ( $sugs[ $i ]['qty'] ?? 0 ) );
					$mode = in_array( (string) ( $sugs[ $i ]['mode'] ?? '' ), array( 'customer_pays', 'store_covers' ), true ) ? (string) $sugs[ $i ]['mode'] : 'customer_pays';
					if ( $pid && $sq > 0 ) $chosen[] = array( 'product_id' => $pid, 'qty' => $sq, 'mode' => $mode );
				}
			}
		}
		if ( empty( $chosen ) ) continue;

		$items[] = array(
			'order_item_id'       => $item_id,
			'old_product_id'      => $order_item->get_product_id(),
			'old_variation_id'    => $order_item->get_variation_id(),
			'missing_qty'         => $missing_qty,
			'unit_gross_subtotal' => $unit_gross_subtotal,
			'unit_gross_total'    => $unit_gross_total,
			'unit_tax_subtotal'   => $unit_tax_subtotal,
			'unit_tax_total'      => $unit_tax_total,
			'tax_class'           => is_string( $orig_tax_class ) ? $orig_tax_class : '',
			'replacements'        => $chosen, // inkluderer 'mode'
		);
	}

	$payload = array(
		'order_id'   => $order->get_id(),
		'items'      => $items,
		'policy'     => array(
			'pricing'   => 'preserve_gross_per_unit',
			'tax'       => 'keep_original_tax_class',
			'discounts' => 'freeze',
			'shipping'  => 'no_rerate',
			'stock'     => array( 'new' => 'reduce_by_qty', 'old' => apply_filters( 'lp_mpr_force_old_stock_zero', false ) ? 'force_zero' : 'decrease' ),
		),
		'created_at' => time(),
	);
	if ( ! empty( $opts['reserved_products'] ) && is_array( $opts['reserved_products'] ) ) $payload['reserved_products'] = array_map( 'absint', $opts['reserved_products'] );
	if ( isset( $opts['issue_ver'] ) ) $payload['issue_ver'] = (int) $opts['issue_ver'];

	return $payload;
}

function lp_mpr_acquire_lock( $order_id ) : bool { $key = 'lp_mpr_lock_order_' . (int) $order_id; if ( get_transient( $key ) ) return false; set_transient( $key, 1, (int) apply_filters( 'lp_mpr_lock_ttl', 600 ) ); return true; }
function lp_mpr_release_lock( $order_id ) : void { delete_transient( 'lp_mpr_lock_order_' . (int) $order_id ); }

function lp_mpr_run_apply_job( $order_id ) {
	$order_id = absint( $order_id ); $order = wc_get_order( $order_id ); if ( ! $order ) return;
	if ( ! lp_mpr_acquire_lock( $order_id ) ) { if ( function_exists( 'as_schedule_single_action' ) ) as_schedule_single_action( time() + 30, LP_MPR_JOB_ACTION, array( $order->get_id() ), LP_MPR_JOB_GROUP, true ); $order->add_order_note( 'MPR: Jobb hoppet over pga. aktiv lÃ¥s; planlagt ny kjÃ¸ring.', false ); return; }
	try {
		$pending = (array) $order->get_meta( '_lp_mpr_pending', true );
		if ( empty( $pending['hash'] ) || empty( $pending['payload'] ) ) { $order->add_order_note( __( 'MPR: Ingen ventende payload Ã¥ bruke.', 'lilleprinsen' ), false ); return; }
		$hash    = (string) $pending['hash'];
		$payload = (array) $pending['payload'];

		$applied_map = (array) $order->get_meta( '_lp_mpr_applied', true );
		if ( ! empty( $applied_map[ $hash ] ) ) { $order->add_order_note( __( 'MPR: Payload allerede brukt (idempotent).', 'lilleprinsen' ), false ); return; }

		$blocked = apply_filters( 'lp_mpr_blocked_statuses', array( 'cancelled', 'refunded', 'failed' ) );
		if ( in_array( $order->get_status(), $blocked, true ) ) throw new Exception( 'Ordre har avsluttende status: ' . $order->get_status() );

		do_action( 'lp_mpr_before_apply', $order, $payload );
		$result = lp_mpr_apply_replacements_atomic_v2( $order, $payload );

		if ( ! empty( $result['pending_fee'] ) ) {
			$amount = (float) ( $result['pending_fee']['amount'] ?? 0.0 );
			$order->add_order_note( sprintf( __( 'MPR: Venter pÃ¥ tilleggsbetaling (%s). Varer er reservert inntil fristen.', 'lilleprinsen' ), wc_price( $amount, array( 'currency' => $order->get_currency() ) ) ), true );
			$order->save();
			return;
		}

		$applied_map[ $hash ] = array( 'applied_at' => time(), 'v' => 2 );
		$order->update_meta_data( '_lp_mpr_applied', $applied_map );

		$current = (array) $order->get_meta( '_lp_mpr_pending', true );
		if ( isset( $current['hash'] ) && $current['hash'] === $hash ) $order->delete_meta_data( '_lp_mpr_pending' );

		if ( apply_filters( 'lp_mpr_delete_meta_on_success', true, $order, $payload ) ) $order->delete_meta_data( '_lp_missing_replacements' );
		$order->delete_meta_data( '_lp_mpr_reservations' );

		$order->update_status( 'oppdatert', __( 'Erstatninger er lagt inn (MPR).', 'lilleprinsen' ), true ); $order->save();

		do_action( 'lp_mpr_after_apply', $order, $result );
		lp_mpr_send_customer_confirmation( $order, $result );

	} catch ( Throwable $e ) {
		$order->add_order_note( sprintf( __( 'MPR feilet: %s', 'lilleprinsen' ), $e->getMessage() ), false );
		do_action( 'lp_mpr_apply_failed', $order, $e );
		throw $e;
	} finally { lp_mpr_release_lock( $order_id ); }
}
add_action( 'plugins_loaded', function () {
	add_action( LP_MPR_JOB_ACTION,         'lp_mpr_run_apply_job',       10, 1 );
	add_action( LP_MPR_RELEASE_JOB_ACTION, 'lp_mpr_release_reservations',10, 2 );
} );

function lp_mpr_release_reservations( $order_id, $issue_ver = 0 ) {
	$order = wc_get_order( $order_id ); if ( ! $order ) return;
	$res = (array) $order->get_meta( '_lp_mpr_reservations', true ); if ( empty( $res['products'] ) ) return;
	if ( isset( $res['issue_ver'] ) && $issue_ver && (int) $res['issue_ver'] !== (int) $issue_ver ) return;

	$pending = (array) $order->get_meta( '_lp_mpr_pending', true );
	if ( empty( $pending ) ) { $order->delete_meta_data( '_lp_mpr_reservations' ); $order->save(); return; }

	foreach ( (array) $res['products'] as $pid => $qty ) {
		$pid = absint( $pid ); $qty = max( 0, (int) $qty ); if ( ! $pid || $qty <= 0 ) continue;
		if ( apply_filters( 'lp_mpr_skip_external_stock_manager', false, $pid ) ) continue;
		$p = wc_get_product( $pid ); if ( $p && $p->managing_stock() ) wc_update_product_stock( $p, $qty, 'increase' );
	}
	$order->add_order_note( __( 'MPR: Reserverte varer er frigitt (tidsavbrudd).', 'lilleprinsen' ), false );
	$order->delete_meta_data( '_lp_mpr_reservations' ); $order->save();
}
/* ==========================================================
 *           ATOMISK MUTASJON V2 + EKSTRA-GEBYR (per forslag)
 * ========================================================== */

function lp_mpr_apply_replacements_atomic_v2( WC_Order $order, array $payload ) : array {
	if ( ! empty( $payload['delete_only'] ) ) return lp_mpr_apply_delete_only( $order, $payload );

	$policy          = (array) ( $payload['policy'] ?? array() );
	$old_stock_mode  = $policy['stock']['old'] ?? 'decrease';
	$cap_enabled     = true;

	$delta_gross_sum = 0.0; $delta_by_line = array();

	// Kun forslag merket "customer_pays" skaper tilleggsordre â€“ og bare for positive deltas.
	foreach ( (array) $payload['items'] as $it ) {
		$allowed = max( 0, (int) ( $it['missing_qty'] ?? 0 ) );
		$reps    = (array) ( $it['replacements'] ?? array() );

		$approved_total = 0; foreach ( $reps as $rep ) { $approved_total += max(0,(int)$rep['qty']); }
		if ( $cap_enabled && $allowed > 0 ) $approved_total = min( $approved_total, $allowed );

		$orig_unit_gross = (float) $it['unit_gross_total'];
		$left = $approved_total; $d_line = 0.0;

		foreach ( $reps as $rep ) {
			if ( $left <= 0 ) break;
			$qty = min( $left, max( 0, (int) $rep['qty'] ) );
			if ( $qty <= 0 ) continue;
			if ( (string) ( $rep['mode'] ?? 'customer_pays' ) !== 'customer_pays' ) { $left -= $qty; continue; } // butikk dekker â†’ ikke med i avgift

			$p = wc_get_product( absint( $rep['product_id'] ) );
			if ( ! $p ) { $left -= $qty; continue; }
			$repl_unit_gross = lp_mpr_get_product_unit_gross_for_order( $p, $order );
			$diff = max( 0, $repl_unit_gross - $orig_unit_gross ) * $qty; // Kunde betaler kun POSITIVT mellomlegg
			$d_line += $diff;
			$left -= $qty;
		}
		if ( $d_line > 0 ) { $delta_by_line[ absint( $it['order_item_id'] ) ] = $d_line; $delta_gross_sum += $d_line; }
	}
	$delta_gross_sum = (float) wc_format_decimal( $delta_gross_sum, wc_get_price_decimals() );

	// Tilleggsordre hvis nÃ¸dvendig
	if ( $delta_gross_sum > 0 ) {
		$child = lp_mpr_create_extra_fee_order( $order, $payload, $delta_gross_sum, $delta_by_line );
		$order->update_meta_data( '_lp_mpr_child_fee_order_id', $child->get_id() ); $order->save();
		lp_mpr_email_extra_fee_invoice( $order, $child, $delta_gross_sum );
		return array( 'pending_fee' => array( 'order_id' => $child->get_id(), 'amount' => $delta_gross_sum ) );
	}

	// Ellers: bruk erstatningene nÃ¥
	return lp_mpr_apply_now( $order, $payload, array( 'old_stock_mode' => $old_stock_mode, 'cap' => $cap_enabled ) );
}

function lp_mpr_apply_delete_only( WC_Order $order, array $payload ) : array {
	$changes = array();
	foreach ( (array) $payload['delete_only'] as $row ) {
		$order_item_id = absint( $row['order_item_id'] ); $missing = max(0,(int)($row['missing_qty']??0));
		if ( ! $order_item_id || $missing <= 0 ) continue;

		$old_item = $order->get_item( $order_item_id ); $old_qty = (int) $old_item->get_quantity();
		$new_qty = max(0,$old_qty-$missing);
		if ( $new_qty === 0 ) $order->remove_item( $old_item->get_id() );
		else {
			$scale = $new_qty / max(1,$old_qty);
			$old_item->set_quantity( $new_qty );
			$old_item->set_subtotal( (float)$old_item->get_subtotal() * $scale );
			$old_item->set_total(    (float)$old_item->get_total()    * $scale );
			$old_item->set_subtotal_tax( (float)$old_item->get_subtotal_tax()*$scale );
			$old_item->set_total_tax(    (float)$old_item->get_total_tax()   *$scale );
			$old_item->save();
		}
		$changes[] = array( 'order_item_id'=>$order_item_id, 'old'=>array('name'=>$old_item->get_name(),'qty_before'=>$old_qty,'qty_after'=>$new_qty), 'new_added'=>array() );
	}
	$order->calculate_totals(false); $order->save();
if ( ! empty( $changes ) ) $order->add_order_note( __( 'ðŸ—‘ï¸ MPR: Manglende vare(r) slettet uten alternativ.', 'lilleprinsen' ), false );
	return array( 'changes'=>$changes );
}

function lp_mpr_apply_now( WC_Order $order, array $payload, array $opts ) : array {
	$changes = array(); $old_stock_mode = $opts['old_stock_mode'] ?? 'decrease'; $cap_enabled = ! empty( $opts['cap'] );

	foreach ( (array) $payload['items'] as $it ) {
		$order_item_id = absint( $it['order_item_id'] ); $replacements = (array) ( $it['replacements'] ?? array() );
		$old_item = $order->get_item( $order_item_id ); if ( ! $old_item || 'line_item' !== $old_item->get_type() ) continue;

		$missing = max( 0, (int) $it['missing_qty'] ); $old_qty = (int) $old_item->get_quantity();
		$allowed = $missing > 0 ? $missing : $old_qty; if ( $allowed <= 0 ) { $order->add_order_note( sprintf('MPR: Hopper over linje %d â€” allowed_qty=0.',$order_item_id), false ); continue; }

		$unit_gross_subtotal = (float) $it['unit_gross_subtotal']; $unit_gross_total = (float) $it['unit_gross_total'];
		$unit_tax_subtotal   = (float) $it['unit_tax_subtotal'];   $unit_tax_total  = (float) $it['unit_tax_total'];
		$tax_class           = (string) $it['tax_class'];

		$old_name = $old_item->get_name(); $old_pid = (int) $it['old_product_id']; $old_vid = (int) $it['old_variation_id'];

		$applied_for_this_item = array(); $old_line_taxes = $old_item->get_taxes();

		$approved_total = 0; foreach ( $replacements as $rep ) { $approved_total += max(0,(int)$rep['qty']); }
		if ( $cap_enabled && $allowed > 0 ) $approved_total = min( $approved_total, $allowed );
		if ( $approved_total <= 0 ) { $order->add_order_note( sprintf('MPR: Skipper linje %d â€” approved_total=0 (allowed=%d).',$order_item_id,$allowed), false ); continue; }

		$left_to_apply = $approved_total;

		foreach ( $replacements as $rep ) {
			if ( $left_to_apply <= 0 ) break;

			$pid = absint( $rep['product_id'] ); $qty_req = max(0,(int)$rep['qty']); $qty = min( $qty_req, $left_to_apply );
			if ( ! $pid || $qty <= 0 ) continue;
			$product = wc_get_product( $pid ); if ( ! $product ) continue;

			$scaled_taxes   = lp_mpr_scale_tax_array( $old_line_taxes, max(1,$old_qty), $qty );
			$subtax_sum2    = array_sum( (array) $scaled_taxes['subtotal'] );
			$totaltax_sum2  = array_sum( (array) $scaled_taxes['total'] );

			$line = new WC_Order_Item_Product();
			$line->set_product( $product );
			$line->set_name( wp_strip_all_tags( $product->get_formatted_name() ) );
			$line->set_quantity( $qty );
			$line->set_subtotal( max( 0, ( $unit_gross_subtotal - $unit_tax_subtotal ) ) * $qty );
			$line->set_total(    max( 0, ( $unit_gross_total    - $unit_tax_total    ) ) * $qty );
			$line->set_tax_class( $tax_class );
			$line->set_subtotal_tax( $subtax_sum2 );
			$line->set_total_tax(    $totaltax_sum2 );
			$line->set_taxes( array( 'subtotal' => $scaled_taxes['subtotal'], 'total' => $scaled_taxes['total'] ) );

			$order->add_item( $line ); $line->save();

			// Reduser lager (skip ved ekst./reservasjon)
			$stock_before = null; $stock_after = null;
			if ( ! apply_filters( 'lp_mpr_skip_external_stock_manager', false, $pid ) && $product->managing_stock() ) {
				$stock_before = $product->get_stock_quantity();
				$updated      = wc_update_product_stock( $product, $qty, 'decrease' );
				$stock_after  = is_wp_error( $updated ) ? $stock_before : (int) $updated;
				$line->add_meta_data( '_reduced_stock', $qty ); $line->save();
			}

			$applied_for_this_item[] = array(
				'type'           => 'added',
				'product_id'     => $pid,
				'name'           => $product->get_name(),
				'qty'            => $qty,
				'subtotal_gross' => $unit_gross_subtotal * $qty,
				'total_gross'    => $unit_gross_total    * $qty,
				'stock_before'   => $stock_before,
				'stock_after'    => $stock_after,
			);
			$left_to_apply -= $qty;
		}

		// Reduser gammel linje
		$new_qty = max( 0, $old_qty - $approved_total );
		if ( $new_qty === 0 ) $order->remove_item( $old_item->get_id() );
		else {
			$scale = $new_qty / max(1,$old_qty);
			$old_item->set_quantity( $new_qty );
			$old_item->set_subtotal(      (float) $old_item->get_subtotal()      * $scale );
			$old_item->set_total(         (float) $old_item->get_total()         * $scale );
			$old_item->set_subtotal_tax(  (float) $old_item->get_subtotal_tax()  * $scale );
			$old_item->set_total_tax(     (float) $old_item->get_total_tax()     * $scale );
			$old_item->set_taxes( lp_mpr_scale_tax_array( $old_line_taxes, max(1,$old_qty), $new_qty ) );
			$old_item->save();
		}

		// LagerhÃ¥ndtering for gammel vare
		if ( $old_pid && ! apply_filters( 'lp_mpr_skip_external_stock_manager', false, $old_pid ) ) {
			$old_product = wc_get_product( $old_vid ? $old_vid : $old_pid );
			if ( $old_product && $old_product->managing_stock() ) {
				if ( $old_stock_mode === 'force_zero' ) wc_update_product_stock( $old_product, 0, 'set' );
				else wc_update_product_stock( $old_product, $approved_total, 'decrease' );
			}
		}

		$changes[] = array(
			'order_item_id' => $order_item_id,
			'old' => array(
				'product_id'        => $old_pid,
				'variation_id'      => $old_vid,
				'name'              => $old_name,
				'qty_before'        => $old_qty,
				'qty_after'         => $new_qty,
				'stock_mode'        => $old_stock_mode,
			),
			'new_added'     => $applied_for_this_item,
		);
	}

	$order->calculate_totals(false); $order->save();
	if ( function_exists( 'wc_delete_shop_order_transients' ) ) wc_delete_shop_order_transients( $order->get_id() );

	$currency = $order->get_currency();
	if ( ! empty( $changes ) ) {
		$lines = array();
		foreach ( $changes as $c ) {
			$old = $c['old'];
			$id_label = '#' . $old['product_id'] . ( $old['variation_id'] ? '/' . $old['variation_id'] : '' );
			$lines[] = sprintf( 'â€¢ %s (%s): %d â†’ %d â€” %s', $old['name'], $id_label, $old['qty_before'], $old['qty_after'], $old['stock_mode'] );
			foreach ( $c['new_added'] as $n ) {
				$price_str = wp_strip_all_tags( wc_price( $n['total_gross'], array( 'currency' => $currency ) ) );
				$stock_note = '';
				if ( $n['stock_before'] !== null && $n['stock_after'] !== null ) {
					$stock_note = ' (' . sprintf( __( 'lager %d â†’ %d', 'lilleprinsen' ), $n['stock_before'], $n['stock_after'] ) . ')';
				}
				$lines[] = sprintf( '   â†³ + %s (#%d) Ã— %d â€” %s%s', $n['name'], $n['product_id'], $n['qty'], $price_str, $stock_note );
			}
		}
		$policy = __( 'Politikk: cap per linje; behold brutto per enhet; opprinnelig mva-klasse; rabatter frosset; frakt uendret.', 'lilleprinsen' );
		$order->add_order_note( "ðŸ§¾ MPR: Erstatning brukt\n" . implode( "\n", $lines ) . "\n" . $policy, false );
	} else {
		$order->add_order_note( __( 'â„¹ï¸ MPR: Ingen endringer ble gjort.', 'lilleprinsen' ), false );
	}
	return array( 'changes' => $changes );
}

/** Tilleggsordre (avgiftsfri fee pÃ¥ brutto mellomlegg) */
function lp_mpr_create_extra_fee_order( WC_Order $parent, array $payload, float $amount_gross, array $delta_by_line ) : WC_Order {
	$args  = array( 'customer_id' => $parent->get_user_id() ? (int) $parent->get_user_id() : 0 );
	$child = wc_create_order( $args );
	$child->update_meta_data( '_lp_mpr_parent_order_id', $parent->get_id() );
	$child->update_meta_data( '_lp_mpr_hash',            lp_mpr_selection_hash( $payload ) );
	$child->update_meta_data( '_lp_mpr_delta_breakdown', $delta_by_line );
	$child->set_address( $parent->get_address( 'billing' ), 'billing' );
	$child->set_address( $parent->get_address( 'shipping' ), 'shipping' );

	$fee = new WC_Order_Item_Fee();
	$fee->set_name( __( 'Tilleggsbetaling for erstatningsvarer', 'lilleprinsen' ) );
	$fee->set_amount( $amount_gross );
	$fee->set_total(  $amount_gross );
	$fee->set_tax_status( 'none' );
	$child->add_item( $fee );

	$child->set_currency( $parent->get_currency() );
	$child->calculate_totals( false );
	$child->update_status( 'pending', __( 'Ventende tilleggsbetaling (MPR).', 'lilleprinsen' ), true );
	$child->save();

	$parent->add_order_note( sprintf( __( 'MPR: Laget tilleggsordre #%s pÃ¥ %.2f.', 'lilleprinsen' ), $child->get_order_number(), $amount_gross ), false );
	return $child;
}

function lp_mpr_email_extra_fee_invoice( WC_Order $parent, WC_Order $child, float $amount_gross ) : void {
	$email = $parent->get_billing_email(); if ( ! $email ) return;
	$link  = $child->get_checkout_payment_url();
	$body  = sprintf( __( "Du har godkjent erstatningsvarer som er dyrere enn originalen.\nVennligst betal mellomlegget: %.2f\n\nBetal her: %s\n\nNÃ¥r betalingen er fullfÃ¸rt oppdaterer vi ordren.", 'lilleprinsen' ), $amount_gross, esc_url( $link ) );
	$headers = array( 'Content-Type: text/plain; charset=UTF-8' );
	wc_mail( $email, __( 'Tilleggsbetaling for erstatningsvarer', 'lilleprinsen' ), $body, $headers );
}

add_action( 'woocommerce_order_status_processing', 'lp_mpr_on_fee_order_paid' );
add_action( 'woocommerce_order_status_completed',  'lp_mpr_on_fee_order_paid' );
add_action( 'woocommerce_payment_complete',        'lp_mpr_on_fee_order_paid' );
function lp_mpr_on_fee_order_paid( $fee_order_id ) {
	$fee = wc_get_order( $fee_order_id ); if ( ! $fee ) return;
	$parent_id = (int) $fee->get_meta( '_lp_mpr_parent_order_id', true ); if ( ! $parent_id ) return;
	$parent = wc_get_order( $parent_id ); if ( ! $parent ) return;

	$pending = (array) $parent->get_meta( '_lp_mpr_pending', true );
	if ( empty( $pending['hash'] ) || empty( $pending['payload'] ) ) { $parent->add_order_note( __( 'MPR: Ingen pending payload ved registrert betaling av tilleggsordre.', 'lilleprinsen' ), false ); return; }

	$hash_parent = (string) $pending['hash']; $hash_child  = (string) $fee->get_meta( '_lp_mpr_hash', true );
	if ( $hash_child && $hash_child !== $hash_parent ) { $parent->add_order_note( __( 'MPR: Hash-mismatch mellom tilleggsordre og payload â€” hopper over.', 'lilleprinsen' ), false ); return; }

	try {
		$result = lp_mpr_apply_now( $parent, (array) $pending['payload'], array(
			'old_stock_mode' => ( $pending['payload']['policy']['stock']['old'] ?? 'decrease' ),
			'cap'            => true,
		) );
		$applied_map = (array) $parent->get_meta( '_lp_mpr_applied', true );
		$applied_map[ $hash_parent ] = array( 'applied_at' => time(), 'v' => 2, 'by_fee' => $fee_order_id );
		$parent->update_meta_data( '_lp_mpr_applied', $applied_map );
		$parent->delete_meta_data( '_lp_mpr_pending' );
		$parent->delete_meta_data( '_lp_mpr_reservations' );

		if ( apply_filters( 'lp_mpr_delete_meta_on_success', true, $parent, $pending['payload'] ) ) $parent->delete_meta_data( '_lp_missing_replacements' );

		$parent->update_status( 'oppdatert', __( 'Erstatninger brukt etter mottatt tilleggsbetaling.', 'lilleprinsen' ), true );
		$parent->save();

		$fee->update_status( 'completed', __( 'Tilleggsbetaling registrert (MPR).', 'lilleprinsen' ), true ); $fee->save();

		lp_mpr_send_customer_confirmation( $parent, $result );
	} catch ( Throwable $e ) {
		$parent->add_order_note( sprintf( __( 'MPR: Feil under bruk etter betaling: %s', 'lilleprinsen' ), $e->getMessage() ), false );
		throw $e;
	}
}

/* ===== UnngÃ¥ dobbel lagerreduksjon ved reservasjon â†’ apply ===== */

$GLOBALS['lp_mpr_current_apply_order_id'] = 0;
add_action( 'lp_mpr_before_apply', function( WC_Order $order ){ $GLOBALS['lp_mpr_current_apply_order_id'] = (int) $order->get_id(); }, 1, 1 );
add_action( 'lp_mpr_after_apply',  function( WC_Order $order ){ $GLOBALS['lp_mpr_current_apply_order_id'] = 0; }, 99, 1 );

add_filter( 'lp_mpr_skip_external_stock_manager', function( $skip, $pid ){
	$order_id = (int) ( $GLOBALS['lp_mpr_current_apply_order_id'] ?? 0 ); if ( ! $order_id ) return $skip;
	$order = wc_get_order( $order_id ); if ( ! $order ) return $skip;
	$res = (array) $order->get_meta( '_lp_mpr_reservations', true ); if ( empty( $res['products'][ $pid ] ) ) return $skip;
	return true;
}, 10, 2 );

add_action( 'lp_mpr_after_apply', function( WC_Order $order, array $result ){
	$res = (array) $order->get_meta( '_lp_mpr_reservations', true ); if ( empty( $res['products'] ) ) return;
	$left = (array) $res['products']; $used = array();
	foreach ( (array) $result['changes'] as $change ) foreach ( (array) $change['new_added'] as $n ) { $pid=(int)$n['product_id']; $qty=max(0,(int)$n['qty']); if ($pid && $qty>0) $used[$pid]=($used[$pid]??0)+$qty; }
	if ( empty( $used ) ) return;
	foreach ( $used as $pid=>$qty ) { if ( empty( $left[$pid] ) ) continue; $left[$pid]=max(0,(int)$left[$pid]-(int)$qty); if ($left[$pid]===0) unset($left[$pid]); }
	if ( empty( $left ) ) {
		$order->delete_meta_data( '_lp_mpr_reservations' ); $order->save();
		if ( function_exists( 'as_unschedule_all_actions' ) ) { $issue=(array)$order->get_meta('_lp_mpr_issue',true); $ver=(int)($issue['ver']??0); as_unschedule_all_actions( LP_MPR_RELEASE_JOB_ACTION, array( $order->get_id(), $ver ), LP_MPR_JOB_GROUP ); }
	} else {
		$order->update_meta_data( '_lp_mpr_reservations', array(
			'products'   => $left,
			'issue_ver'  => $res['issue_ver'] ?? 0,
			'expires_at' => $res['expires_at'] ?? 0,
			'mode'       => 'decrease_hold',
		) ); $order->save();
	}
}, 10, 2 );

/* ===== Kunde-bekreftelse + status ===== */

if ( ! function_exists( 'lp_mpr_send_customer_confirmation' ) ) {
	function lp_mpr_send_customer_confirmation( WC_Order $order, array $result ) : void {
		$send = apply_filters( 'lp_mpr_send_customer_email', true, $order, $result ); if ( ! $send ) return;
		$email = $order->get_billing_email(); if ( ! $email ) return;
		$order_url = $order->get_view_order_url();
		$lines = array();
		if ( ! empty( $result['changes'] ) ) {
			foreach ( $result['changes'] as $c ) {
				$old = $c['old']; $lines[] = sprintf( "%s: %d â†’ %d", $old['name'], $old['qty_before'], $old['qty_after'] );
				foreach ( $c['new_added'] as $n ) $lines[] = sprintf( "Erstattet med: %s Ã— %d", $n['name'], $n['qty'] );
			}
		}
		$subject = sprintf( __( 'Vi har oppdatert bestillingen din #%s hos Lilleprinsen', 'lilleprinsen' ), $order->get_order_number() );
		$body    = implode( "\n", $lines ) . "\n\n" . __( 'Pris per enhet er uendret. Du kan se ordren her:', 'lilleprinsen' ) . "\n" . esc_url( $order_url ) . "\n\n" . __( 'Si ifra hvis du lurer pÃ¥ noe ðŸ™‚', 'lilleprinsen' );
		$headers = array( 'Content-Type: text/html; charset=UTF-8' );
		wc_mail( $email, $subject, nl2br( wp_kses_post( $body ) ), $headers );
	}
}

add_action( 'init', function() {
	register_post_status( 'wc-oppdatert', array(
		'label'                     => _x( 'Oppdatert', 'Order status', 'lilleprinsen' ),
		'public'                    => true,
		'exclude_from_search'       => false,
		'show_in_admin_all_list'    => true,
		'show_in_admin_status_list' => true,
		'label_count'               => _n_noop( 'Oppdatert <span class="count">(%s)</span>', 'Oppdatert <span class="count">(%s)</span>', 'lilleprinsen' ),
	) );
});
add_filter( 'wc_order_statuses', function( $statuses ) {
	$new = array();
	foreach ( $statuses as $key => $label ) {
		$new[ $key ] = $label;
		if ( 'wc-completed' === $key ) $new['wc-oppdatert'] = _x( 'Oppdatert', 'Order status', 'lilleprinsen' );
	}
	if ( ! isset( $new['wc-oppdatert'] ) ) $new['wc-oppdatert'] = _x( 'Oppdatert', 'Order status', 'lilleprinsen' );
	return $new;
} );
/* ==========================================================
 *           STANDALONE PORTAL-RENDER (kun ved rute)
 * ========================================================== */

add_action( 'template_redirect', function(){
	if ( intval( get_query_var( 'lp_mpr_portal' ) ) !== 1 ) return;

	$order_id  = absint( get_query_var( 'lp_mpr_order_id' ) );
	$order_key = (string) get_query_var( 'lp_mpr_key' );
	if ( ! $order_id || ! $order_key ) return;

	$order = wc_get_order( $order_id ); if ( ! $order ) return;

	// Sikkerhetskontekst
	$ok = false;
	if ( is_user_logged_in() ) {
		$ok = ( (int) $order->get_user_id() === (int) get_current_user_id() ) || current_user_can( 'edit_shop_order', $order_id );
	} else {
		$ok = ( $order_key && $order->get_order_key() === $order_key );
	}
	if ( ! $ok ) { status_header( 403 ); echo esc_html__( 'Du har ikke tilgang til denne siden.', 'lilleprinsen' ); exit; }

	// Ikke cache
	nocache_headers();

	$data  = (array) $order->get_meta( '_lp_missing_replacements', true );
	$issue = (array) $order->get_meta( '_lp_mpr_issue', true );
	$ver   = (int) ( $issue['ver'] ?? 0 );

	// Regn informasjonsoppsummering (hvem dekker?)
	$cnt_customer_pays = 0; $cnt_store_covers = 0;
	foreach ( $data as $row ) {
		if ( empty( $row['enabled'] ) || empty( $row['suggestions'] ) ) continue;
		foreach ( (array) $row['suggestions'] as $s ) {
			$m = (string) ( $s['mode'] ?? 'customer_pays' );
			if ( $m === 'store_covers' ) $cnt_store_covers++; else $cnt_customer_pays++;
		}
	}
$ttl_minutes = max( 1, floor( lp_mpr_reservation_ttl_seconds() / 60 ) );
$customer_name = trim( $order->get_billing_first_name() . ' ' . $order->get_billing_last_name() );
if ( ! $customer_name ) $customer_name = (string) $order->get_billing_company();
if ( ! $customer_name ) $customer_name = (string) $order->get_formatted_billing_full_name();
if ( ! $customer_name ) $customer_name = __( 'venn', 'lilleprinsen' );

?><!doctype html>
<html <?php language_attributes(); ?>>
	<head>
	<meta charset="<?php bloginfo( 'charset' ); ?>">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<title><?php echo esc_html__( 'Erstatninger for manglende varer', 'lilleprinsen' ); ?></title>
<style>
:root{--ink:#0f172a;--muted:#475569;--bg:#f8fafc;--card:#ffffff;--br:#e2e8f0;--accent:#2563eb;--pill:#e0f2fe;}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);}
.container{max-width:720px;margin:0 auto;padding:18px;}
.hero{display:flex;gap:12px;align-items:center;background:linear-gradient(135deg,#0f172a,#1e293b);color:#fff;border-radius:14px;padding:14px 16px;box-shadow:0 10px 30px rgba(15,23,42,.16);margin-bottom:12px}
.hero .emoji{font-size:26px}
.hero .title{margin:0;font-size:18px;font-weight:700}
.hero .subtitle{margin:4px 0 0;font-size:13px;color:rgba(255,255,255,.9)}
.pills{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 10px 0}
.pill{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;background:var(--pill);border:1px solid #bae6fd;color:#0f172a;border-radius:12px;font-size:12px;box-shadow:0 1px 3px rgba(15,23,42,.08)}
.pill .emoji{font-size:14px}
.card{background:var(--card);border:1px solid var(--br);border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 1px 4px rgba(15,23,42,.06)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.tag{font-size:12px;color:var(--muted)}
.badge{font-size:12px;background:#eef2ff;color:#3730a3;padding:4px 10px;border-radius:10px;white-space:nowrap;display:inline-flex;align-items:center;gap:6px}
.chip{font-size:11px;background:#ecfeff;color:#0e7490;border:1px solid #a5f3fc;padding:2px 8px;border-radius:999px;margin-left:6px;white-space:nowrap}
.choice{display:flex;gap:10px;align-items:center;padding:10px;border:1px solid var(--br);border-radius:10px;margin:8px 0;background:#f8fafc}
.choice img{flex:0 0 auto}
.choice a{color:var(--ink);text-decoration:none}
.choice a:focus,.choice a:hover{color:var(--accent);text-decoration:underline}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
button{appearance:none;background:var(--accent);border:0;color:#fff;border-radius:10px;padding:12px 14px;font-weight:700;box-shadow:0 1px 3px rgba(37,99,235,.35)}
button.secondary{background:#fff;color:var(--ink);border:1px solid var(--br);box-shadow:none}
.footer-note{color:var(--muted);font-size:13px;margin-top:12px;text-align:center}
hr{border:0;border-top:1px solid var(--br);margin:10px 0}
.small{font-size:12px;color:var(--muted)}
.li{list-style:none;padding:0;margin:0}
.qty{font-variant-numeric:tabular-nums;color:var(--muted)}
.old{display:flex;gap:10px;align-items:center;flex:1;min-width:0}
@media (max-width:480px){ .badge{margin-top:4px; width:100%; justify-content:center;} }
</style>
	</head>
	<body>
<div class="container" id="lp-mpr-standalone"
         data-ajax="<?php echo esc_attr( admin_url( 'admin-ajax.php' ) ); ?>"
         data-order-id="<?php echo esc_attr( $order_id ); ?>"
         data-order-key="<?php echo esc_attr( $order_key ); ?>"
         data-nonce="<?php echo esc_attr( wp_create_nonce( 'lp_mpr_portal_action' ) ); ?>"
         data-issue-ver="<?php echo esc_attr( $ver ); ?>">
<div class="hero">
<div class="emoji">ðŸ¤—</div>
<div>
<p class="title"><?php echo sprintf( esc_html__( 'Hei %s!', 'lilleprinsen' ), esc_html( $customer_name ) ); ?></p>
<p class="subtitle"><?php echo esc_html__( 'Vi fant alternativer for varene som mangler. Kryss av det du Ã¸nsker â€“ resten fikser vi. âœ¨', 'lilleprinsen' ); ?></p>
</div>
</div>

<div class="pills">
<span class="pill"><span class="emoji">â±ï¸</span><span><?php printf( esc_html__( 'Vi holder av valgene dine i ca. %d min.', 'lilleprinsen' ), (int) $ttl_minutes ); ?></span></span>
<?php if ( $cnt_customer_pays && $cnt_store_covers ) : ?>
<span class="pill"><span class="emoji">ðŸ’³</span><span><?php echo esc_html__( 'Noen alternativer kan gi et lite mellomlegg.', 'lilleprinsen' ); ?></span></span>
<span class="pill"><span class="emoji">ðŸ›¡ï¸</span><span><?php echo esc_html__( 'Andre alternativer dekker butikken helt.', 'lilleprinsen' ); ?></span></span>
<?php elseif ( $cnt_customer_pays ) : ?>
<span class="pill"><span class="emoji">ðŸ’³</span><span><?php echo esc_html__( 'Mellomlegg betales kun om du velger dyrere vare.', 'lilleprinsen' ); ?></span></span>
<?php else : ?>
<span class="pill"><span class="emoji">âœ…</span><span><?php echo esc_html__( 'Butikken dekker eventuelle prisforskjeller.', 'lilleprinsen' ); ?></span></span>
<?php endif; ?>
<span class="pill"><span class="emoji">ðŸ§¾</span><span><?php echo esc_html__( 'Velg Ã©n eller flere forslag, maks likt antallet som mangler.', 'lilleprinsen' ); ?></span></span>
</div>

<?php
if ( empty( $data ) ) {
echo '<div class="card"><p>' . esc_html__( 'Ingen erstatninger foreslÃ¥tt akkurat nÃ¥.', 'lilleprinsen' ) . '</p></div>';
}

		foreach ( $order->get_items( 'line_item' ) as $item_id => $item ) {
			$key = (string) $item_id;
			if ( empty( $data[ $key ]['enabled'] ) ) continue;

			$ordered     = (int) $item->get_quantity();
			$missing_qty = max( 0, (int) ( $data[ $key ]['qty'] ?? 0 ) );
			$sugs        = ! empty( $data[ $key ]['suggestions'] ) ? (array) $data[ $key ]['suggestions'] : array();

			// Gammelt produktbilde
			$old_prod = null;
			$old_vid  = $item->get_variation_id();
			$old_pid  = $item->get_product_id();
			if ( $old_vid ) $old_prod = wc_get_product( $old_vid );
			if ( ! $old_prod && $old_pid ) $old_prod = wc_get_product( $old_pid );

			echo '<div class="card lp-portal-item" data-item-id="' . esc_attr( $item_id ) . '" data-missing="' . esc_attr( $missing_qty ) . '">';
			echo '<div class="row old">';
			if ( $old_prod ) echo wp_kses_post( lp_mpr_thumb_html( $old_prod ) ); else echo '<div style="width:48px;height:48px;background:#f1f5f9;border:1px solid #e5e7eb;border-radius:6px"></div>';
			echo '<div style="flex:1"><div><strong>' . esc_html( $item->get_name() ) . '</strong></div><div class="tag">' . esc_html__( 'Opprinnelig vare', 'lilleprinsen' ) . '</div></div>';
			echo '<div class="qty small">' . esc_html__( 'Bestilt', 'lilleprinsen' ) . ': ' . esc_html( $ordered ) . '</div>';
			echo '<div class="qty small">' . esc_html__( 'Mangler', 'lilleprinsen' ) . ': ' . esc_html( $missing_qty ) . '</div>';
			echo '</div>';

			echo '<hr />';
			if ( ! empty( $sugs ) ) {
				echo '<ul class="li">';
				$unit = lp_mpr_get_line_unit_prices( $order, $item );
				foreach ( array_values( $sugs ) as $idx => $s ) {
					$pid = absint( $s['product_id'] ?? 0 );
					$sq  = max( 0, (int) ( $s['qty'] ?? 0 ) );
					$mode = in_array( (string) ( $s['mode'] ?? '' ), array( 'customer_pays', 'store_covers' ), true ) ? (string) $s['mode'] : 'customer_pays';
					if ( ! $pid || $sq <= 0 ) continue;

					$p     = wc_get_product( $pid );
					$label = $p ? wp_strip_all_tags( $p->get_formatted_name() ) : '#' . $pid;
					$link  = ( $p && $p->is_visible() ) ? get_permalink( $p->get_id() ) : '';

					$delta = $p ? lp_mpr_calc_delta_gross( (float) $unit['unit_gross_total'], $p, $sq, $order ) : 0.0;
					$sign  = $delta > 0 ? '+ ' : ( $delta < 0 ? 'âˆ’ ' : '' );
					$delta_html = $sign . wc_price( abs( $delta ), array( 'currency' => $order->get_currency() ) );
					$chip = $mode === 'store_covers' ? esc_html__( 'Butikken dekker', 'lilleprinsen' ) : esc_html__( 'Kunde betaler', 'lilleprinsen' );

					echo '<li class="choice">';
					echo '<input class="lp-choice" type="checkbox" value="' . esc_attr( $idx ) . '" data-qty="' . esc_attr( $sq ) . '"> ';
					if ( $p ) echo wp_kses_post( lp_mpr_thumb_html( $p ) );
					echo '<div style="flex:1;min-width:0">';
					echo $link ? '<a href="' . esc_url( $link ) . '"><strong>' . esc_html( $label ) . '</strong></a>' : '<strong>' . esc_html( $label ) . '</strong>';
					echo '<div class="small">' . esc_html__( 'Antall', 'lilleprinsen' ) . ': ' . esc_html( $sq ) . '</div>';
					echo '</div>';
					echo '<div><span class="badge" title="' . esc_attr__( 'Prisforskjell', 'lilleprinsen' ) . '">' . wp_kses_post( $delta_html ) . '</span><span class="chip">' . esc_html( $chip ) . '</span></div>';
					echo '</li>';
				}
				echo '</ul>';
			} else {
				echo '<p class="small">' . esc_html__( 'Ingen alternativer oppfÃ¸rt for denne linjen. Du kan velge Ã¥ slette det manglende antallet.', 'lilleprinsen' ) . '</p>';
			}

			echo '<div class="actions">';
			echo '<button type="button" class="primary" data-action="approve_update">' . esc_html__( 'Godkjenn valgte erstatninger', 'lilleprinsen' ) . '</button>';
			echo '<button type="button" class="secondary" data-action="delete_missing">' . esc_html__( 'Slett manglende vare', 'lilleprinsen' ) . '</button>';
			echo '</div>';

			echo '</div>'; // card
		}
		?>

		<p class="footer-note"><?php echo esc_html__( 'Vi gjÃ¸r endringen i bakgrunnen og oppdaterer ordren din straks.', 'lilleprinsen' ); ?></p>
	</div>

	<script>
	(function(){
		var host = document.getElementById('lp-mpr-standalone'); if(!host) return;
		var ajax=host.getAttribute('data-ajax'), orderId=parseInt(host.getAttribute('data-order-id')||'0',10)||0, orderKey=host.getAttribute('data-order-key')||'', nonce=host.getAttribute('data-nonce')||'', issueVer=parseInt(host.getAttribute('data-issue-ver')||'0',10)||0;
		var cooldown=2500, lastClick=0;

		function selections(){
			var out = {};
			host.querySelectorAll('.lp-portal-item').forEach(function(card){
				var id = card.getAttribute('data-item-id'), picked=[];
				card.querySelectorAll('.lp-choice:checked').forEach(function(c){ picked.push(parseInt(c.value,10)); });
				if(picked.length){ out[id]=picked; }
			});
			return out;
		}
		function overChosen(card){
			var allowed = parseInt(card.getAttribute('data-missing')||'0',10)||0, chosen=0;
			card.querySelectorAll('.lp-choice:checked').forEach(function(c){ chosen += parseInt(c.getAttribute('data-qty')||'0',10)||0; });
			return allowed>0 && chosen>allowed;
		}
		function post(which, extra){
			var now=Date.now(); if(now-lastClick<cooldown) return; lastClick=now;
			var fd=new FormData(); fd.append('action','lp_mpr_portal_action'); fd.append('which',which); fd.append('order_id',orderId); fd.append('order_key',orderKey); fd.append('nonce',nonce); fd.append('issue_ver',issueVer);
			if(extra&&extra.selections){ fd.append('selections', JSON.stringify(extra.selections)); }
			fetch(ajax,{method:'POST',body:fd,credentials:'same-origin'}).then(function(r){return r.json().catch(function(){return {success:false,data:{message:'Ugyldig svar'}};});}).then(function(resp){
				if(resp && resp.success){ alert('Takk! Vi tar det herfra.'); location.reload(); }
				else { alert((resp&&resp.data&&resp.data.message)||'Noe gikk galt.'); }
			}).catch(function(){ alert('Nettverksfeil.'); });
		}

		host.addEventListener('click', function(e){
			var t=e.target.closest('button[data-action]'); if(!t) return;
			var act=t.getAttribute('data-action');
			if(act==='approve_update'){
				var bad=false; host.querySelectorAll('.lp-portal-item').forEach(function(card){ if(overChosen(card)) bad=true; });
				if(bad){ alert('<?php echo esc_js( __( 'Valgt antall er for hÃ¸yt i forhold til det som mangler.', 'lilleprinsen' ) ); ?>'); return; }
				var sel=selections(); if(Object.keys(sel).length===0){ alert('<?php echo esc_js( __( 'Huk av et alternativ fÃ¸rst ðŸ™‚', 'lilleprinsen' ) ); ?>'); return; }
				post('approve_update',{selections:sel});
			}else if(act==='delete_missing'){
				if(confirm('<?php echo esc_js( __( 'Er du sikker pÃ¥ at vi skal slette den manglende varen?', 'lilleprinsen' ) ); ?>')) post('delete_missing');
			}
		});
	})();
	</script>
	</body>
	</html>
	<?php
	exit;
} );