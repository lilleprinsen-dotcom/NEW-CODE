<?php
/**
 * Plugin Name: Lilleprinsen ‚Äì Erstatning for manglende varer (Admin + Egen mobilportal + Async + Tillegg)
 * Description: Admin-velger for erstatning + egen mobiltilpasset portal. Asynkron ordreendring via Action Scheduler (med debounce). Lagersmart s√∏k. Bevarer brutto per enhet & opprinnelig mva-klasse, fryser rabatter og rater ikke frakt p√• nytt. Logger lager f√∏r/etter. Tilleggsordre kun for forslag merket ‚Äúkunde betaler‚Äù. Reservasjon av lager ved top-up. Minimal lasting.
 * Author: Lilleprinsen
 * Version: 1.7.1
 * Text Domain: lilleprinsen
 * Domain Path: /languages
 */

use Automattic\WooCommerce\Internal\DataStores\Orders\CustomOrdersTableController;
use WC_Order;
use WC_Product;
use WC_Order_Item_Product;
use WC_Order_Item_Fee;
use WC_Coupon;

if ( ! defined( 'ABSPATH' ) ) exit;

/** Last inn oversettelser */
add_action( 'init', function(){
	load_plugin_textdomain( 'lilleprinsen', false, dirname( plugin_basename( __FILE__ ) ) . '/languages' );
} );

/* ==========================================================
 *                 KONFIG / KONSTANTER
 * ========================================================== */
if ( ! defined( 'LP_MPR_JOB_ACTION' ) )           define( 'LP_MPR_JOB_ACTION',          'lp_mpr_apply_replacements' );
if ( ! defined( 'LP_MPR_RELEASE_JOB_ACTION' ) )   define( 'LP_MPR_RELEASE_JOB_ACTION',  'lp_mpr_release_reservations' );
if ( ! defined( 'LP_MPR_REMINDER_JOB_ACTION' ) )  define( 'LP_MPR_REMINDER_JOB_ACTION', 'lp_mpr_send_missing_reminder' );
if ( ! defined( 'LP_MPR_JOB_GROUP' ) )            define( 'LP_MPR_JOB_GROUP',           'lp-mpr' );

/** Debounce/TTL kan justeres via filter */
function lp_mpr_debounce_seconds() : int { return (int) apply_filters( 'lp_mpr_debounce_seconds', 120 ); }
function lp_mpr_reservation_ttl_seconds() : int { return (int) apply_filters( 'lp_mpr_reservation_ttl_seconds', 2 * HOUR_IN_SECONDS ); }
function lp_mpr_get_reminder_intervals() : array {
        $raw = get_option( 'lp_mpr_reminder_intervals', array( 24 ) ); // lagres i timer
        if ( ! is_array( $raw ) ) $raw = array();
        $clean = array();
        foreach ( $raw as $hrs ) {
                $hrs = (int) $hrs;
                if ( $hrs > 0 ) $clean[] = $hrs;
        }
        $clean = array_values( array_unique( $clean ) );
        sort( $clean );
        return $clean;
}
function lp_mpr_parse_reminder_intervals_from_input( $input ) : array {
        if ( is_array( $input ) ) $input = implode( ',', $input );
        $parts = array_map( 'trim', explode( ',', (string) $input ) );
        $out   = array();
        foreach ( $parts as $p ) {
                if ( $p === '' ) continue;
                $hrs = (int) $p;
                if ( $hrs > 0 ) $out[] = $hrs;
        }
        $out = array_values( array_unique( $out ) ); sort( $out );
        return $out;
}

/** Lagerpolicy for gammel vare: r√∏r ikke lager som standard; opt-in for √• tvinge 0. */
function lp_mpr_force_old_stock_zero() : bool { return (bool) apply_filters( 'lp_mpr_force_old_stock_zero', false ); }
/** Overstyr hvis eksternt lager-API brukes ‚Äî eller for √• hoppe over reduksjon for reserverte linjer */
function lp_mpr_skip_external_stock_manager( $product_id ) { return apply_filters( 'lp_mpr_skip_external_stock_manager', false, $product_id ); }

/* ==========================================================
 *           SM√Ö HJELPERE (pris, mva, bilder, utils)
 * ========================================================== */

/** Enhetsbrutto / enhetsskatt for en ordrelinje (fra linjens totals) */
function lp_mpr_get_line_unit_prices( WC_Order $order, $item ) : array {
	$qty = max( 1, (int) $item->get_quantity() );
	return array(
		'unit_gross_subtotal' => (float) $item->get_subtotal()     / $qty + (float) $item->get_subtotal_tax() / $qty,
		'unit_gross_total'    => (float) $item->get_total()        / $qty + (float) $item->get_total_tax()    / $qty,
		'unit_tax_subtotal'   => (float) $item->get_subtotal_tax() / $qty,
		'unit_tax_total'      => (float) $item->get_total_tax()    / $qty,
		'tax_class'           => (string) $item->get_tax_class(),
	);
}

/** Brutto enhetspris for et produkt i *ordrens* skatte-kontekst. */
function lp_mpr_get_product_unit_gross_for_order( WC_Product $p, WC_Order $order ) : float {
	if ( '' === $p->get_price( 'edit' ) ) return 0.0;
	$raw_price = (float) $p->get_price( 'edit' );
	$tax_class = $p->get_tax_class();
	$prices_include_tax = wc_prices_include_tax();

	// Nettobel√∏p utfra butikkens prislagring
	if ( $prices_include_tax ) {
		$base_rates = WC_Tax::get_base_tax_rates( $tax_class );
		$base_taxes = WC_Tax::calc_tax( $raw_price, $base_rates, true );
		$net = $raw_price - array_sum( $base_taxes );
	} else {
		$net = $raw_price;
	}

	// Legg p√• korrekt mva for *kunde-/ordre*-kontekst
	$args = array(
		'country'   => $order->get_shipping_country() ?: $order->get_billing_country(),
		'state'     => $order->get_shipping_state() ?: $order->get_billing_state(),
		'postcode'  => $order->get_shipping_postcode() ?: $order->get_billing_postcode(),
		'city'      => $order->get_shipping_city() ?: $order->get_billing_city(),
		'tax_class' => $tax_class,
	);
	$rates = method_exists( 'WC_Tax', 'find_rates' ) ? WC_Tax::find_rates( $args ) : WC_Tax::get_rates( $tax_class );
	$taxes = WC_Tax::calc_tax( $net, $rates, false );
	$gross = $net + array_sum( $taxes );

	return (float) wc_format_decimal( $gross, wc_get_price_decimals() );
}
function lp_mpr_get_product_unit_gross( WC_Product $p, WC_Order $order ) : float {
	return lp_mpr_get_product_unit_gross_for_order( $p, $order );
}

/** Delta (brutto) gitt original enhetsbrutto og valgt produkt * mengde */
function lp_mpr_get_coupon_factor_for_product( WC_Product $p, WC_Order $order ) : array {
        $factor     = 1.0;
        $applies    = false;
        $pct_total  = 0.0;
        $unit_gross = lp_mpr_get_product_unit_gross_for_order( $p, $order );

        foreach ( (array) $order->get_coupon_codes() as $code ) {
                $coupon = new WC_Coupon( $code );
                if ( ! $coupon->get_id() ) continue;

                $type = $coupon->get_discount_type();
                if ( ! $coupon->is_valid_for_product( $p, array() ) ) continue;

                if ( in_array( $type, array( 'percent', 'percent_product' ), true ) ) {
                        $pct_total += (float) $coupon->get_amount();
                        $applies = true;
                        continue;
                }

                if ( 'fixed_product' === $type ) {
                        $applies = true;
                        if ( $unit_gross > 0 ) {
                                $factor = min( $factor, max( 0.0, ( $unit_gross - (float) $coupon->get_amount() ) / $unit_gross ) );
                        }
                }
        }

        if ( $pct_total > 0 ) {
                $applies = true;
                $pct_total = min( 100.0, $pct_total );
                $factor    = min( $factor, ( 100.0 - $pct_total ) / 100.0 );
        }

        return array(
                'factor'  => (float) wc_format_decimal( max( 0.0, $factor ), 6 ),
                'applies' => (bool) $applies,
        );
}

function lp_mpr_calc_delta_gross( float $orig_unit_gross, WC_Product $p, int $qty, WC_Order $order, bool &$coupon_applied = false ) : float {
        $coupon_factor = lp_mpr_get_coupon_factor_for_product( $p, $order );
        $new_unit_gross = lp_mpr_get_product_unit_gross_for_order( $p, $order ) * (float) $coupon_factor['factor'];
        $coupon_applied = (bool) $coupon_factor['applies'];
        $delta = ( $new_unit_gross - $orig_unit_gross ) * max( 0, $qty );
        return (float) wc_format_decimal( $delta, wc_get_price_decimals() );
}

/** Prisdetaljer for et produkt i ordre-kontekst (per enhet) */
function lp_mpr_get_product_unit_breakdown_for_order( WC_Product $p, WC_Order $order ) : array {
        $raw_price = (float) $p->get_price( 'edit' );
        $tax_class = $p->get_tax_class();
        $prices_include_tax = wc_prices_include_tax();

        if ( $prices_include_tax ) {
                $base_rates = WC_Tax::get_base_tax_rates( $tax_class );
                $base_taxes = WC_Tax::calc_tax( $raw_price, $base_rates, true );
                $unit_net = $raw_price - array_sum( $base_taxes );
        } else {
                $unit_net = $raw_price;
        }

        $args = array(
                'country'   => $order->get_shipping_country() ?: $order->get_billing_country(),
                'state'     => $order->get_shipping_state() ?: $order->get_billing_state(),
                'postcode'  => $order->get_shipping_postcode() ?: $order->get_billing_postcode(),
                'city'      => $order->get_shipping_city() ?: $order->get_billing_city(),
                'tax_class' => $tax_class,
        );
        $rates = method_exists( 'WC_Tax', 'find_rates' ) ? WC_Tax::find_rates( $args ) : WC_Tax::get_rates( $tax_class );
        $taxes = WC_Tax::calc_tax( $unit_net, $rates, false );
        $unit_tax = array_sum( $taxes );
        $unit_gross = $unit_net + $unit_tax;

        return array(
                'unit_net'   => (float) wc_format_decimal( $unit_net, wc_get_price_decimals() ),
                'unit_tax'   => (float) wc_format_decimal( $unit_tax, wc_get_price_decimals() ),
                'unit_gross' => (float) wc_format_decimal( $unit_gross, wc_get_price_decimals() ),
                'taxes'      => $taxes,
        );
}

/** Skalerer en taksamling med faktor (for rabatt/antall) */
function lp_mpr_scale_tax_amounts( array $taxes, float $factor ) : array {
        $out = array();
        $factor = max( 0.0, $factor );
        foreach ( $taxes as $rate_id => $amount ) {
                $out[ $rate_id ] = (float) wc_format_decimal( (float) $amount * $factor, wc_get_price_decimals() );
        }
        return $out;
}

/** Rabattfaktor (brutto) mellom originalt subtotal og total per enhet */
function lp_mpr_discount_factor_from_units( float $unit_gross_subtotal, float $unit_gross_total ) : float {
        if ( $unit_gross_subtotal <= 0 ) return 1.0;
        $factor = (float) $unit_gross_total / $unit_gross_subtotal;
        return max( 0.0, min( 1.0, (float) wc_format_decimal( $factor, 6 ) ) );
}

/** Kj√∏r full recalculation tilsvarende WooCommerce "Recalculate" */
function lp_mpr_recalculate_order( WC_Order $order ) : void {
        if ( class_exists( 'WC_Admin_Order' ) && method_exists( 'WC_Admin_Order', 'calculate_totals' ) ) {
                \WC_Admin_Order::calculate_totals( $order );
        } else {
                $order->calculate_totals( true );
        }
}

/** Skaler mva-matrise (beholder per-sats fordeling) */
function lp_mpr_scale_tax_array( array $taxes, int $orig_qty, int $new_qty ) : array {
        $orig_qty = max(1, (int) $orig_qty);
        $new_qty  = max(0, (int) $new_qty);
	$scale = function( $bucket ) use ( $orig_qty, $new_qty ) {
		$out = array();
		foreach ( (array) $bucket as $rate_id => $amount ) {
			$per_unit = (float) $amount / $orig_qty;
			$out[$rate_id] = $per_unit * $new_qty;
		}
		return $out;
	};
        return array(
                'subtotal' => $scale( $taxes['subtotal'] ?? array() ),
                'total'    => $scale( $taxes['total']    ?? array() ),
        );
}

/** Rabattkontekst for ordren (kun prosentkuponger summeres, max 100%) */
function lp_mpr_get_discount_context( WC_Order $order ) : array {
        $percent = 0.0; $codes = array();
        foreach ( (array) $order->get_coupon_codes() as $code ) {
                $coupon = new WC_Coupon( $code );
                if ( ! $coupon->get_id() ) continue;
                $type = $coupon->get_discount_type();
                if ( in_array( $type, array( 'percent', 'percent_product' ), true ) ) {
                        $percent += (float) $coupon->get_amount();
                        $codes[]  = $coupon->get_code();
                }
        }
        return array(
                'percent' => max( 0.0, min( 100.0, (float) $percent ) ),
                'codes'   => array_values( array_unique( $codes ) ),
        );
}

/** P√•f√∏r prosentvis rabatt p√• et positivt mellomlegg */
function lp_mpr_apply_discount_to_delta( float $delta, array $discount_ctx, bool $coupon_priced = false ) : float {
        $delta   = (float) wc_format_decimal( $delta, wc_get_price_decimals() );
        $percent = isset( $discount_ctx['percent'] ) ? (float) $discount_ctx['percent'] : 0.0;

        // If coupons don't apply to the replacement product (e.g. sale exclusions),
        // leave the delta untouched. When coupons do apply, the replacement price is
        // already reduced in lp_mpr_calc_delta_gross ‚Äî applying the order discount
        // again would double-discount the difference customers pay.
        if ( $delta <= 0 || $percent <= 0 ) return $delta;

        if ( $coupon_priced ) return $delta;

        $factor = max( 0.0, ( 100.0 - min( 100.0, $percent ) ) / 100.0 );

        return (float) wc_format_decimal( $delta * $factor, wc_get_price_decimals() );
}

/* ==========================================================
 *                       LOGGING & E-POST
 * ========================================================== */

function lp_mpr_append_log_entry( WC_Order $order, string $message, string $status = '', string $actor = 'system', array $meta = array(), bool $save = true ) : void {
        $entries = (array) $order->get_meta( '_lp_mpr_log', true );
        $entries[] = array(
                'at'      => time(),
                'message' => $message,
                'status'  => $status,
                'actor'   => $actor,
                'meta'    => $meta,
        );
        if ( count( $entries ) > 200 ) $entries = array_slice( $entries, -200 );
        $order->update_meta_data( '_lp_mpr_log', $entries );
        if ( $save ) $order->save();
}
function lp_mpr_get_log_entries( WC_Order $order ) : array { return (array) $order->get_meta( '_lp_mpr_log', true ); }
function lp_mpr_log_status_label( string $status ) : string {
        $map = array(
                'alternativer_sendt'          => __( 'Alternativer sendt', 'lilleprinsen' ),
                'kunde_godkjent'              => __( 'Kunde godkjente', 'lilleprinsen' ),
                'kunde_godkjent_venter'       => __( 'Kunde godkjent ‚Äì venter betaling', 'lilleprinsen' ),
                'sletting_valgt'              => __( 'Kunde √∏nsker sletting', 'lilleprinsen' ),
                'betaling_feilet'             => __( 'Betaling feilet', 'lilleprinsen' ),
                'reservasjon_frigitt'         => __( 'Reservasjon frigitt', 'lilleprinsen' ),
                'chat'                        => __( 'Chat', 'lilleprinsen' ),
                'epost'                       => __( 'E-post', 'lilleprinsen' ),
                'oppdatert'                   => __( 'Ordre oppdatert', 'lilleprinsen' ),
                'p√•minnelse'                  => __( 'P√•minnelse', 'lilleprinsen' ),
        );
        return $map[ $status ] ?? $status;
}

function lp_mpr_render_branded_email( string $heading, string $body_html, array $cta = array() ) : string {
        $button = '';
        if ( ! empty( $cta['label'] ) && ! empty( $cta['url'] ) ) {
                $button = '<p style="margin:24px 0 10px;"><a href="' . esc_url( $cta['url'] ) . '" style="background:#0ea5e9;color:#fff;padding:12px 18px;border-radius:10px;font-weight:700;text-decoration:none;display:inline-block;">' . wp_kses_post( $cta['label'] ) . '</a></p>';
        }

        return '<div style="background:#f8fafc;padding:28px 0;font-family:-apple-system,Segoe UI,Roboto,sans-serif;color:#0f172a;">'
             . '<div style="max-width:640px;margin:0 auto;background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:24px;box-shadow:0 10px 30px rgba(15,23,42,.05);">'
             . '<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;"><span style="font-size:24px;">üß∏</span><div style="font-weight:700;font-size:18px;">Lilleprinsen</div></div>'
             . '<h1 style="margin:0 0 12px;font-size:20px;">' . wp_kses_post( $heading ) . '</h1>'
             . '<div style="font-size:15px;line-height:1.6;">' . $body_html . '</div>'
             . $button
             . '<p style="margin-top:22px;font-size:13px;color:#475569;">' . esc_html__( 'Takk for at du handler hos oss! Ta kontakt om du lurer p√• noe.', 'lilleprinsen' ) . '</p>'
             . '</div></div>';
}

function lp_mpr_send_branded_email( string $to, string $subject, string $heading, string $body_html, array $cta = array(), WC_Order $order = null, string $log_status = 'epost', string $actor = 'system' ) : void {
        if ( ! $to ) return;
        $html = lp_mpr_render_branded_email( $heading, $body_html, $cta );
        wc_mail( $to, $subject, $html, array( 'Content-Type: text/html; charset=UTF-8' ) );
        if ( $order ) {
                lp_mpr_append_log_entry( $order, wp_strip_all_tags( $subject ), $log_status, $actor );
        }
}

function lp_mpr_schedule_reminders( WC_Order $order, int $issue_ver ) : void {
        $intervals = lp_mpr_get_reminder_intervals();
        if ( empty( $intervals ) ) return;

        if ( function_exists( 'as_unschedule_all_actions' ) ) {
                as_unschedule_all_actions( LP_MPR_REMINDER_JOB_ACTION, array( $order->get_id() ), LP_MPR_JOB_GROUP );
        } else {
                wp_clear_scheduled_hook( LP_MPR_REMINDER_JOB_ACTION, array( $order->get_id(), $issue_ver ) );
        }

        foreach ( $intervals as $hrs ) {
                $ts = time() + ( (int) $hrs * HOUR_IN_SECONDS );
                if ( function_exists( 'as_schedule_single_action' ) ) {
                        as_schedule_single_action( $ts, LP_MPR_REMINDER_JOB_ACTION, array( $order->get_id(), $issue_ver ), LP_MPR_JOB_GROUP, true );
                } else {
                        wp_schedule_single_event( $ts, LP_MPR_REMINDER_JOB_ACTION, array( $order->get_id(), $issue_ver ) );
                }
        }
}

function lp_mpr_send_missing_reminder( $order_id, $issue_ver = 0 ) {
        $order = wc_get_order( $order_id ); if ( ! $order ) return;
        $issue = (array) $order->get_meta( '_lp_mpr_issue', true );
        $current_ver = (int) ( $issue['ver'] ?? 0 );
        if ( $issue_ver && $current_ver && $issue_ver !== $current_ver ) return;
        if ( ! empty( $issue['consumed'] ) ) return;

        $url   = apply_filters( 'lp_mpr_portal_url', '', $order_id );
        $lines = array();
        $saved = (array) $order->get_meta( '_lp_missing_replacements', true );
        foreach ( $saved as $row ) {
                $missing = max( 0, (int) ( $row['qty'] ?? 0 ) );
                if ( $missing > 0 ) $lines[] = sprintf( _n( '%d vare mangler', '%d varer mangler', $missing, 'lilleprinsen' ), $missing );
        }

        $body  = '<p>' . esc_html__( 'Vi savner svaret ditt p√• erstatningene vi har foresl√•tt.', 'lilleprinsen' ) . '</p>';
        if ( ! empty( $lines ) ) {
                $body .= '<p>' . esc_html__( 'Dette mangler fortsatt:', 'lilleprinsen' ) . '</p>';
                $body .= '<ul style="padding-left:20px;line-height:1.5;">';
                foreach ( array_slice( $lines, 0, 5 ) as $l ) {
                        $body .= '<li>' . esc_html( $l ) . '</li>';
                }
                $body .= '</ul>';
        }
        $body .= '<p>' . esc_html__( 'Trykk p√• knappen under for √• bekrefte eller justere valgene dine.', 'lilleprinsen' ) . '</p>';

        lp_mpr_send_branded_email(
                $order->get_billing_email(),
                __( 'P√•minnelse: velg erstatningene dine', 'lilleprinsen' ),
                __( 'Kan du bekrefte erstatningene?', 'lilleprinsen' ),
                $body,
                array( 'label' => __( '√Öpne erstatningsportalen', 'lilleprinsen' ), 'url' => $url ),
                $order,
                'p√•minnelse'
        );
        lp_mpr_append_log_entry( $order, __( 'P√•minnelse sendt til kunden om manglende valg.', 'lilleprinsen' ), 'p√•minnelse', 'system' );
}

/** Kundevennlig oppsummering etter oppdatering */
function lp_mpr_build_customer_summary( WC_Order $order, array $result ) : array {
        $pricing = (array) ( $result['pricing'] ?? array() );
        $currency = $order->get_currency();
        $order_total_before = isset( $pricing['order_total_before'] ) ? (float) $pricing['order_total_before'] : (float) $order->get_total();
        $order_total_after  = isset( $pricing['order_total_after'] )  ? (float) $pricing['order_total_after']  : (float) $order->get_total();
        $order_total_delta  = isset( $pricing['order_total_delta'] )  ? (float) $pricing['order_total_delta']  : (float) wc_format_decimal( $order_total_after - $order_total_before, wc_get_price_decimals() );
        $delta_payer        = (string) ( $pricing['delta_payer'] ?? '' );

        $summary = array(
                'order_total_html'         => $pricing['order_total_after_html'] ?? $pricing['order_total_html'] ?? wc_price( $order_total_after, array( 'currency' => $currency ) ),
                'order_total_before_html'  => $pricing['order_total_before_html'] ?? wc_price( $order_total_before, array( 'currency' => $currency ) ),
                'order_total_after_html'   => $pricing['order_total_after_html']  ?? wc_price( $order_total_after, array( 'currency' => $currency ) ),
                'order_total_delta_html'   => $pricing['order_total_delta_html']  ?? wc_price( abs( $order_total_delta ), array( 'currency' => $currency ) ),
                'order_total_delta'        => $order_total_delta,
                'delta_payer'              => $delta_payer ?: ( $order_total_delta > 0 ? 'customer' : ( $order_total_delta < 0 ? 'store' : 'even' ) ),
                'added'            => array(),
                'removed'          => array(),
        );

        foreach ( (array) ( $result['changes'] ?? array() ) as $change ) {
                $old        = (array) ( $change['old'] ?? array() );
                $old_name   = wp_strip_all_tags( $old['name'] ?? '' );
                $qty_before = max( 0, (int) ( $old['qty_before'] ?? 0 ) );
                $qty_after  = max( 0, (int) ( $old['qty_after'] ?? 0 ) );
                $removed_qty = $qty_before > $qty_after ? $qty_before - $qty_after : 0;
                if ( $removed_qty > 0 ) {
                        $summary['removed'][] = array(
                                'name' => $old_name ?: __( 'Opprinnelig vare', 'lilleprinsen' ),
                                'qty'  => $removed_qty,
                        );
                }

                foreach ( (array) ( $change['new_added'] ?? array() ) as $n ) {
                        $qty = max( 0, (int) ( $n['qty'] ?? 0 ) );
                        if ( $qty <= 0 ) continue;
                        $summary['added'][] = array(
                                'name'       => wp_strip_all_tags( $n['name'] ?? '' ),
                                'qty'        => $qty,
                                'price_html' => wc_price( (float) ( $n['total_gross'] ?? 0.0 ), array( 'currency' => $currency ) ),
                        );
                }
        }

        return $summary;
}

function lp_mpr_store_customer_summary( WC_Order $order, array $result ) : string {
        $summary = lp_mpr_build_customer_summary( $order, $result );
        if ( empty( $summary['order_total_html'] ) && empty( $summary['added'] ) && empty( $summary['removed'] ) ) return '';

        $token = wp_generate_password( 12, false, false );
        set_transient( 'lp_mpr_summary_' . $token, array(
                'order_id' => $order->get_id(),
                'data'     => $summary,
        ), HOUR_IN_SECONDS );

        return $token;
}

/** Stabil hash for payload (ekskluderer flyktige felt) */
function lp_mpr_selection_hash( array $payload ) : string {
	$stable = $payload;
	if ( isset( $stable['items'] ) && is_array( $stable['items'] ) ) {
		foreach ( $stable['items'] as &$it ) {
			if ( isset( $it['replacements'] ) ) {
				usort( $it['replacements'], function( $a, $b ){
					return ($a['product_id'] <=> $b['product_id']) ?: ($a['qty'] <=> $b['qty']);
				});
			}
		}
		unset($it);
		usort( $stable['items'], function( $a, $b ){ return ($a['order_item_id'] <=> $b['order_item_id']); } );
	}
	unset( $stable['created_at'] );
	return sha1( wp_json_encode( $stable ) );
}

/** Finner et sikkert produktbilde (URL + alt-tekst) */
function lp_mpr_get_product_thumb( ?WC_Product $product, string $fallback_alt = '' ) : array {
        $alt = $product ? wp_strip_all_tags( $product->get_name() ) : wp_strip_all_tags( $fallback_alt );
        if ( '' === $alt ) {
                $alt = __( 'Produktbilde', 'lilleprinsen' );
        }

        $img_id = $product ? $product->get_image_id() : 0;
        if ( $product && ! $img_id && $product->is_type( 'variation' ) ) {
                $parent_id = $product->get_parent_id();
                if ( $parent_id ) {
                        $parent = wc_get_product( $parent_id );
                        if ( $parent ) {
                                $img_id = $parent->get_image_id();
                        }
                }
        }

        $placeholder = wc_placeholder_img_src( 'thumbnail' );
        $url         = '';
        if ( $img_id ) {
                $src = wp_get_attachment_image_url( $img_id, 'thumbnail' );
                if ( $src ) {
                        $url = (string) $src;
                }
        }

        $safe_url = '' === $url ? $placeholder : $url;
        if ( '' === $safe_url ) {
                $safe_url = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120" preserveAspectRatio="xMidYMid meet"><rect width="120" height="120" fill="%23f1f5f9"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="%2394a3b8" font-size="18" font-family="Arial, sans-serif">üì¶</text></svg>';
        }

        return array(
                'url'       => esc_url_raw( $safe_url ),
                'actual'    => esc_url_raw( $url ),
                'alt'       => $alt,
                'fallback'  => esc_url_raw( $safe_url ),
        );
}

/** Kompakt produktbilde (HTML) ‚Äì enkel WooCommerce-basert renderer */
function lp_mpr_thumb_html( ?WC_Product $product, string $class = 'lp-thumb', string $fallback_alt = '' ) : string {
        $img = lp_mpr_get_product_thumb( $product, $fallback_alt );
        $style = 'width:48px;height:48px;border-radius:6px;object-fit:cover;border:1px solid #e5e7eb;display:block;background:#fff';

        $attrs = array(
                'class'       => $class,
                'src'         => $img['fallback'],
                'data-src'    => $img['actual'] ?: $img['fallback'],
                'data-fallback' => $img['fallback'],
                'alt'         => $img['alt'],
                'loading'     => 'eager',
                'style'       => $style,
                'decoding'    => 'async',
        );

        return '<img ' . lp_mpr_render_html_attributes( $attrs ) . ' />';
}

/** Trygg attributt-builder for HTML */
function lp_mpr_render_html_attributes( array $attrs ) : string {
        $out = array();
        foreach ( $attrs as $k => $v ) {
                $k = sanitize_key( $k );
                if ( '' === $k ) continue;
                $out[] = $k . '="' . esc_attr( $v ) . '"';
        }
        return implode( ' ', $out );
}

/* ==========================================================
 *                 CHAT / PORTAL-DIALOG
 * ========================================================== */

function lp_mpr_chat_status_options() : array {
        return array(
                'open'     => __( '√Öpen', 'lilleprinsen' ),
                'answered' => __( 'Besvart', 'lilleprinsen' ),
                'closed'   => __( 'Lukket', 'lilleprinsen' ),
        );
}

function lp_mpr_sanitize_chat_message( string $message ) : string {
        return trim( wp_strip_all_tags( $message ) );
}

function lp_mpr_get_order_chats( WC_Order $order ) : array {
        $raw = $order->get_meta( '_lp_mpr_chats', true );
        return is_array( $raw ) ? $raw : array();
}

function lp_mpr_save_order_chats( WC_Order $order, array $chats ) : void {
        $order->update_meta_data( '_lp_mpr_chats', $chats );
        $order->save();
}

function lp_mpr_chat_suggestion_snapshot( WC_Order $order ) : string {
        $data = (array) $order->get_meta( '_lp_missing_replacements', true );
        $parts = array();
        foreach ( $order->get_items( 'line_item' ) as $item_id => $item ) {
                $key = (string) $item_id;
                if ( empty( $data[ $key ]['suggestions'] ) || ! is_array( $data[ $key ]['suggestions'] ) ) continue;

                $sugs = array();
                foreach ( (array) $data[ $key ]['suggestions'] as $sug ) {
                        $pid = absint( $sug['product_id'] ?? 0 );
                        $qty = max( 0, (int) ( $sug['qty'] ?? 0 ) );
                        if ( ! $pid || $qty <= 0 ) continue;
                        $p    = wc_get_product( $pid );
                        $name = $p ? wp_strip_all_tags( $p->get_formatted_name() ) : '#' . $pid;
                        $sugs[] = $name . ' √ó ' . $qty;
                }

                if ( ! empty( $sugs ) ) {
                        $parts[] = wp_strip_all_tags( $item->get_name() ) . ': ' . implode( ', ', $sugs );
                }
        }

        return $parts ? implode( '; ', $parts ) : __( 'Ingen forslag registrert', 'lilleprinsen' );
}

function lp_mpr_create_customer_chat( WC_Order $order, string $message, int $issue_ver = 0 ) : array {
        $msg = lp_mpr_sanitize_chat_message( $message );
        $chats = lp_mpr_get_order_chats( $order );
        $chat = array(
                'id'           => function_exists( 'wp_generate_uuid4' ) ? wp_generate_uuid4() : uniqid( 'lp-chat-', true ),
                'status'       => 'open',
                'issue_ver'    => $issue_ver,
                'suggestions'  => lp_mpr_chat_suggestion_snapshot( $order ),
                'created_at'   => time(),
                'updated_at'   => time(),
                'messages'     => array(
                        array( 'from' => 'customer', 'at' => time(), 'body' => $msg ),
                ),
        );
        $chats[] = $chat;
        lp_mpr_save_order_chats( $order, $chats );
        return $chat;
}

function lp_mpr_update_chat_on_order( WC_Order $order, string $chat_id, string $message = '', ?string $status = null ) : array {
        $chats = lp_mpr_get_order_chats( $order );
        $found = array();
        foreach ( $chats as $idx => $chat ) {
                if ( (string) ( $chat['id'] ?? '' ) !== (string) $chat_id ) continue;
                $chat['updated_at'] = time();
                if ( $message !== '' ) {
                        $chat['messages'][] = array(
                                'from' => 'admin',
                                'at'   => time(),
                                'body' => lp_mpr_sanitize_chat_message( $message ),
                        );
                        $chat['status'] = 'answered';
                }
                if ( $status && isset( lp_mpr_chat_status_options()[ $status ] ) ) {
                        $chat['status'] = $status;
                }
                $chats[ $idx ] = $chat;
                $found = $chat;
                break;
        }
        if ( ! empty( $found ) ) {
                lp_mpr_save_order_chats( $order, $chats );
        }
        return $found;
}

function lp_mpr_format_chat_transcript_html( array $chat ) : string {
        $parts = array();
        foreach ( (array) ( $chat['messages'] ?? array() ) as $msg ) {
                $who  = (string) ( $msg['from'] ?? '' ) === 'admin' ? __( 'Kundeservice', 'lilleprinsen' ) : __( 'Kunde', 'lilleprinsen' );
                $when = ! empty( $msg['at'] ) ? date_i18n( 'Y-m-d H:i', (int) $msg['at'] ) : '';
                $body = isset( $msg['body'] ) ? nl2br( esc_html( $msg['body'] ) ) : '';
                $parts[] = '<p><strong>' . esc_html( $who ) . '</strong> ' . ( $when ? '(' . esc_html( $when ) . ') ' : '' ) . '<br>' . $body . '</p>';
        }
        return implode( '', $parts );
}

function lp_mpr_format_chat_transcript_text( array $chat ) : string {
        $parts = array();
        foreach ( (array) ( $chat['messages'] ?? array() ) as $msg ) {
                $who  = (string) ( $msg['from'] ?? '' ) === 'admin' ? __( 'Kundeservice', 'lilleprinsen' ) : __( 'Kunde', 'lilleprinsen' );
                $when = ! empty( $msg['at'] ) ? date_i18n( 'Y-m-d H:i', (int) $msg['at'] ) : '';
                $body = isset( $msg['body'] ) ? $msg['body'] : '';
                $parts[] = trim( $who . ( $when ? ' (' . $when . ')' : '' ) . ': ' . $body );
        }
        return implode( "\n", $parts );
}

function lp_mpr_collect_all_chats() : array {
        $orders = wc_get_orders( array(
                'limit'      => -1,
                'meta_query' => array(
                        array(
                                'key'     => '_lp_mpr_chats',
                                'compare' => 'EXISTS',
                        ),
                ),
                'status'     => array_keys( wc_get_order_statuses() ),
                'return'     => 'objects',
        ) );

        $out = array();
        foreach ( $orders as $order ) {
                $chats = lp_mpr_get_order_chats( $order );
                foreach ( $chats as $chat ) {
                        $chat['order_id']     = $order->get_id();
                        $chat['order_number'] = $order->get_order_number();
                        $chat['order_email']  = $order->get_billing_email();
                        $out[] = $chat;
                }
        }

        usort( $out, function( $a, $b ){
                $a_time = isset( $a['updated_at'] ) ? (int) $a['updated_at'] : 0;
                $b_time = isset( $b['updated_at'] ) ? (int) $b['updated_at'] : 0;
                return $b_time <=> $a_time;
        } );

        return $out;
}


/* ==========================================================
 *                 ADMIN META BOX & S√òK
 * ========================================================== */

add_action( 'add_meta_boxes', function () {
	$screen = class_exists( CustomOrdersTableController::class )
		&& wc_get_container()->get( CustomOrdersTableController::class )->custom_orders_table_usage_is_enabled()
			? wc_get_page_screen_id( 'shop-order' )
			: 'shop_order';

	add_meta_box(
	'lp_missing_product_replacement',
	__( 'Erstatning for manglende vare', 'lilleprinsen' ),
	'lp_render_missing_product_replacement_box',
	$screen,
	'advanced',
	'low'
	);
} );

add_action( 'admin_enqueue_scripts', function () {
        $screen = function_exists('get_current_screen') ? get_current_screen() : null;
        if ( ! $screen ) return;

	$order_screen = class_exists( CustomOrdersTableController::class )
		&& wc_get_container()->get( CustomOrdersTableController::class )->custom_orders_table_usage_is_enabled()
			? wc_get_page_screen_id( 'shop-order' )
			: 'shop_order';

	if ( $screen->id === $order_screen ) {
		if ( wp_script_is( 'wc-enhanced-select', 'registered' ) ) {
			wp_enqueue_script( 'wc-enhanced-select' );
		} elseif ( wp_script_is( 'selectWoo', 'registered' ) ) {
			wp_enqueue_script( 'selectWoo' );
		}
		if ( wp_style_is( 'woocommerce_admin_styles', 'registered' ) ) {
			wp_enqueue_style( 'woocommerce_admin_styles' );
		}
        }
} );

/* ==========================================================
 *                 ADMIN MENY / INFORMASJON
 * ========================================================== */

add_action( 'admin_menu', function () {
        add_menu_page(
                __( 'Erstatning for manglende varer', 'lilleprinsen' ),
                __( 'Erstatninger', 'lilleprinsen' ),
                'manage_woocommerce',
                'lp-mpr-settings',
                'lp_mpr_render_settings_page',
                'dashicons-randomize',
                56
        );
} );

add_action( 'admin_post_lp_mpr_reply_chat', 'lp_mpr_reply_chat' );
function lp_mpr_reply_chat() {
        if ( ! current_user_can( 'manage_woocommerce' ) ) {
                wp_die( esc_html__( 'Du har ikke tilgang til dette.', 'lilleprinsen' ) );
        }

        if ( empty( $_POST['lp_mpr_reply_chat_nonce'] ) || ! wp_verify_nonce( $_POST['lp_mpr_reply_chat_nonce'], 'lp_mpr_reply_chat' ) ) {
                wp_die( esc_html__( 'Sikkerhetssjekk feilet.', 'lilleprinsen' ) );
        }

        $order_id = isset( $_POST['order_id'] ) ? absint( $_POST['order_id'] ) : 0;
        $chat_id  = isset( $_POST['chat_id'] ) ? sanitize_text_field( wp_unslash( $_POST['chat_id'] ) ) : '';
        $status   = isset( $_POST['chat_status'] ) ? sanitize_key( wp_unslash( $_POST['chat_status'] ) ) : '';
        $message  = isset( $_POST['chat_reply'] ) ? lp_mpr_sanitize_chat_message( wp_unslash( $_POST['chat_reply'] ) ) : '';

        $order = $order_id ? wc_get_order( $order_id ) : false;
        if ( ! $order || ! $chat_id ) {
                wp_safe_redirect( admin_url( 'admin.php?page=lp-mpr-settings#lp-mpr-chats' ) );
                exit;
        }

        $chat = lp_mpr_update_chat_on_order( $order, $chat_id, $message, $status );
        if ( empty( $chat ) ) {
                wp_safe_redirect( admin_url( 'admin.php?page=lp-mpr-settings&lp_mpr_chat=missing#lp-mpr-chats' ) );
                exit;
        }

        if ( '' !== $message ) {
                $order->add_order_note( sprintf( __( 'MPR chat: Admin svarte: %s', 'lilleprinsen' ), $message ), false );
                lp_mpr_append_log_entry( $order, sprintf( __( 'Admin svarte: %s', 'lilleprinsen' ), $message ), 'chat', 'admin' );
                $email = $order->get_billing_email();
                if ( $email ) {
                        $subject = sprintf( __( 'Svar p√• chat om ordre #%s', 'lilleprinsen' ), $order->get_order_number() );
                        $body  = '<p>' . sprintf( esc_html__( 'Hei! Her er oppdatert chat for ordre #%s.', 'lilleprinsen' ), esc_html( $order->get_order_number() ) ) . '</p>';
                        $body .= '<p><strong>' . esc_html__( 'Forslag sendt', 'lilleprinsen' ) . ':</strong> ' . esc_html( $chat['suggestions'] ?? '' ) . '</p>';
                        $body .= '<h3 style="margin-top:18px;">' . esc_html__( 'Samtale', 'lilleprinsen' ) . '</h3>' . lp_mpr_format_chat_transcript_html( $chat );
                        lp_mpr_send_branded_email( $email, $subject, __( 'Vi har svart p√• chatten din', 'lilleprinsen' ), $body, array(), $order, 'chat', 'admin' );
                }
        } elseif ( $status ) {
                $statuses = lp_mpr_chat_status_options();
                $status_label = isset( $statuses[ $status ] ) ? $statuses[ $status ] : $status;
                $order->add_order_note( sprintf( __( 'MPR chat-status satt til %s', 'lilleprinsen' ), $status_label ), false );
        }

        wp_safe_redirect( admin_url( 'admin.php?page=lp-mpr-settings&lp_mpr_chat=updated#lp-mpr-chats' ) );
        exit;
}

add_action( 'admin_post_lp_mpr_save_settings', function () {
        if ( ! current_user_can( 'manage_woocommerce' ) ) {
                wp_die( esc_html__( 'Du har ikke tilgang til dette.', 'lilleprinsen' ) );
        }
        if ( empty( $_POST['lp_mpr_save_settings_nonce'] ) || ! wp_verify_nonce( $_POST['lp_mpr_save_settings_nonce'], 'lp_mpr_save_settings' ) ) {
                wp_die( esc_html__( 'Sikkerhetssjekk feilet.', 'lilleprinsen' ) );
        }

        $intervals = lp_mpr_parse_reminder_intervals_from_input( isset( $_POST['lp_mpr_reminder_intervals'] ) ? wp_unslash( $_POST['lp_mpr_reminder_intervals'] ) : '' );
        update_option( 'lp_mpr_reminder_intervals', $intervals );

        wp_safe_redirect( add_query_arg( 'lp_mpr_saved', '1', admin_url( 'admin.php?page=lp-mpr-settings' ) ) );
        exit;
} );

function lp_mpr_render_settings_page() {
        if ( ! current_user_can( 'manage_woocommerce' ) ) return;

        $ttl_minutes = max( 1, floor( lp_mpr_reservation_ttl_seconds() / 60 ) );
        $debounce    = lp_mpr_debounce_seconds();
        $chats       = lp_mpr_collect_all_chats();
        $statuses    = lp_mpr_chat_status_options();
        $reminders   = lp_mpr_get_reminder_intervals();
        $reminder_str= implode( ', ', $reminders );

        echo '<div class="wrap">';
        echo '<h1>' . esc_html__( 'Erstatninger for manglende varer', 'lilleprinsen' ) . '</h1>';
        echo '<p>' . esc_html__( 'Her finner du portalstatus, tidsgrenser og snarveier for √• f√∏lge opp kundene.', 'lilleprinsen' ) . '</p>';

        if ( isset( $_GET['lp_mpr_saved'] ) ) {
                echo '<div class="notice notice-success"><p>' . esc_html__( 'Innstillingene ble lagret.', 'lilleprinsen' ) . '</p></div>';
        }

        echo '<h2>' . esc_html__( 'Portal og kommunikasjon', 'lilleprinsen' ) . '</h2>';
        echo '<ul>';
        echo '<li>' . esc_html__( 'Send portal-lenker fra ordre-siden via notatfeltet.', 'lilleprinsen' ) . '</li>';
        echo '<li>' . esc_html__( 'Kunder kan godkjenne alternativer eller be oss slette manglende varer.', 'lilleprinsen' ) . '</li>';
        echo '<li>' . esc_html__( 'Velger de et billigere forslag f√•r de mellomlegget tilbake n√•r ordren oppdateres.', 'lilleprinsen' ) . '</li>';
        echo '</ul>';

        echo '<h2>' . esc_html__( 'Tidsgrenser', 'lilleprinsen' ) . '</h2>';
        echo '<p>' . sprintf( esc_html__( 'Reservasjoner holdes i omtrent %d minutter. Nye endringer kan trigges hvert %d. sekund.', 'lilleprinsen' ), (int) $ttl_minutes, (int) $debounce ) . '</p>';

        echo '<p>';
        echo '<a class="button button-primary" href="' . esc_url( admin_url( 'edit.php?post_type=shop_order' ) ) . '">' . esc_html__( 'G√• til ordreoversikt', 'lilleprinsen' ) . '</a> ';
        echo '<a class="button" href="' . esc_url( admin_url( 'admin.php?page=wc-settings' ) ) . '">' . esc_html__( '√Öpne WooCommerce-innstillinger', 'lilleprinsen' ) . '</a>';
        echo '</p>';

        echo '<h2>' . esc_html__( 'P√•minnelser til kunder', 'lilleprinsen' ) . '</h2>';
        echo '<p>' . esc_html__( 'Velg hvor ofte vi skal minne kunder p√• √• fullf√∏re valgene sine n√•r de ikke har svart.', 'lilleprinsen' ) . '</p>';
        echo '<form method="post" action="' . esc_url( admin_url( 'admin-post.php' ) ) . '" class="lp-reminder-form">';
        echo '<p><label for="lp_mpr_reminder_intervals" style="font-weight:600;">' . esc_html__( 'Send p√•minnelse etter (timer)', 'lilleprinsen' ) . '</label><br>';
        echo '<input type="text" id="lp_mpr_reminder_intervals" name="lp_mpr_reminder_intervals" value="' . esc_attr( $reminder_str ) . '" class="regular-text" placeholder="24, 48, 72"> ';
        echo '<span class="description">' . esc_html__( 'Skriv inn tall separert med komma, f.eks. 12, 24, 48.', 'lilleprinsen' ) . '</span></p>';
        echo '<p><button type="submit" class="button button-primary">' . esc_html__( 'Lagre p√•minnelser', 'lilleprinsen' ) . '</button></p>';
        wp_nonce_field( 'lp_mpr_save_settings', 'lp_mpr_save_settings_nonce' );
        echo '<input type="hidden" name="action" value="lp_mpr_save_settings">';
        echo '</form>';

        echo '<h2 id="lp-mpr-chats">' . esc_html__( 'Kundesamtaler', 'lilleprinsen' ) . '</h2>';
        echo '<p>' . esc_html__( 'Kunder kan sende en chat fra portalen hvis forslagene ikke passer. Svarene du skriver her sendes til kundens e-post sammen med hele historikken.', 'lilleprinsen' ) . '</p>';
        echo '<style>.lp-chat-card{box-sizing:border-box;background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:12px;margin:12px 0;box-shadow:0 1px 2px rgba(15,23,42,.08);} .lp-chat-head{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;font-weight:600;} .lp-chat-meta{font-size:12px;color:#475569;margin:6px 0;} .lp-chat-thread{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;margin:8px 0;} .lp-chat-bubble{padding:8px 10px;border-radius:8px;margin:6px 0;background:#fff;border:1px solid #e2e8f0;} .lp-chat-bubble.admin{background:#eef2ff;border-color:#cbd5e1;} .lp-chat-bubble .who{font-weight:600;display:block;} .lp-chat-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0;} .lp-chat-actions select{min-width:140px;} .lp-chat-actions textarea{width:100%;max-width:480px;} .lp-chat-footnote{font-size:12px;color:#64748b;margin:4px 0 0;}</style>';

        if ( empty( $chats ) ) {
                echo '<p>' . esc_html__( 'Ingen chats er registrert enn√•.', 'lilleprinsen' ) . '</p>';
        } else {
                foreach ( $chats as $chat ) {
                        $order_link = isset( $chat['order_id'] ) ? admin_url( 'post.php?post=' . (int) $chat['order_id'] . '&action=edit' ) : '';
                        $last_time  = ! empty( $chat['updated_at'] ) ? date_i18n( 'Y-m-d H:i', (int) $chat['updated_at'] ) : '';
                        echo '<div class="lp-chat-card">';
                        echo '<div class="lp-chat-head">';
                        echo '<div>' . esc_html__( 'Ordre', 'lilleprinsen' ) . ' #' . esc_html( $chat['order_number'] ?? '' ) . ( $order_link ? ' ‚Äì <a href="' . esc_url( $order_link ) . '">' . esc_html__( '√Öpne ordre', 'lilleprinsen' ) . '</a>' : '' ) . '</div>';
                        echo $last_time ? '<div class="tag">' . esc_html__( 'Sist oppdatert', 'lilleprinsen' ) . ': ' . esc_html( $last_time ) . '</div>' : '';
                        echo '</div>';

                        echo '<div class="lp-chat-meta"><strong>' . esc_html__( 'Forslag sendt', 'lilleprinsen' ) . ':</strong> ' . esc_html( $chat['suggestions'] ?? '' ) . '</div>';

                        echo '<div class="lp-chat-thread">';
                        if ( empty( $chat['messages'] ) ) {
                                echo '<p class="description">' . esc_html__( 'Ingen meldinger i denne chatten enn√•.', 'lilleprinsen' ) . '</p>';
                        } else {
                                foreach ( (array) $chat['messages'] as $msg ) {
                                        $who  = (string) ( $msg['from'] ?? '' ) === 'admin' ? __( 'Kundeservice', 'lilleprinsen' ) : __( 'Kunde', 'lilleprinsen' );
                                        $when = ! empty( $msg['at'] ) ? date_i18n( 'Y-m-d H:i', (int) $msg['at'] ) : '';
                                        $body = isset( $msg['body'] ) ? nl2br( esc_html( $msg['body'] ) ) : '';
                                        $class = (string) ( $msg['from'] ?? '' ) === 'admin' ? 'lp-chat-bubble admin' : 'lp-chat-bubble';
                                        echo '<div class="' . esc_attr( $class ) . '"><span class="who">' . esc_html( $who ) . ( $when ? ' (' . esc_html( $when ) . ')' : '' ) . '</span>' . $body . '</div>';
                                }
                        }
                        echo '</div>';

                        echo '<form method="post" action="' . esc_url( admin_url( 'admin-post.php' ) ) . '">';
                        echo '<div class="lp-chat-actions">';
                        echo '<label>' . esc_html__( 'Status', 'lilleprinsen' ) . ' '; 
                        echo '<select name="chat_status">';
                        $current_status = $chat['status'] ?? 'open';
                        foreach ( $statuses as $key => $label ) {
                                echo '<option value="' . esc_attr( $key ) . '" ' . selected( $current_status, $key, false ) . '>' . esc_html( $label ) . '</option>';
                        }
                        echo '</select></label>';
                        echo '</div>';

                        echo '<p><label for="chat-reply-' . esc_attr( $chat['id'] ?? 'chat' ) . '">' . esc_html__( 'Send svar til kunden (valgfritt)', 'lilleprinsen' ) . '</label><br>';
                        echo '<textarea rows="3" name="chat_reply" id="chat-reply-' . esc_attr( $chat['id'] ?? 'chat' ) . '" placeholder="' . esc_attr__( 'Skriv svaret ditt her ‚Ä¶', 'lilleprinsen' ) . '"></textarea></p>';
                        echo '<p><button type="submit" class="button button-primary">' . esc_html__( 'Oppdater chat & send svar', 'lilleprinsen' ) . '</button></p>';
                        echo '<p class="lp-chat-footnote">' . esc_html__( 'Svaret sendes til kundens e-post med hele chatten.', 'lilleprinsen' ) . '</p>';
                        wp_nonce_field( 'lp_mpr_reply_chat', 'lp_mpr_reply_chat_nonce' );
                        echo '<input type="hidden" name="action" value="lp_mpr_reply_chat">';
                        echo '<input type="hidden" name="order_id" value="' . esc_attr( $chat['order_id'] ?? 0 ) . '">';
                        echo '<input type="hidden" name="chat_id" value="' . esc_attr( $chat['id'] ?? '' ) . '">';
                        echo '</form>';

                        echo '</div>';
                }
        }

        echo '</div>';
}

/**
 * Render admin-metaboks (viser delta og valg "kunde betaler" / "butikk dekker")
 */
function lp_render_missing_product_replacement_box( $object ) {
	$order = is_a( $object, 'WP_Post' ) ? wc_get_order( $object->ID ) : $object;
	if ( ! $order || ! is_a( $order, 'WC_Order' ) ) {
		echo '<p>' . esc_html__( 'Fant ikke ordren.', 'lilleprinsen' ) . '</p>';
		return;
	}

        $saved = (array) $order->get_meta( '_lp_missing_replacements', true );
        $discount_ctx = (array) $order->get_meta( '_lp_mpr_discount_context', true );
        if ( empty( $discount_ctx ) ) $discount_ctx = lp_mpr_get_discount_context( $order );

        wp_nonce_field( 'lp_missing_replacements_save', 'lp_missing_replacements_nonce' );
        wp_nonce_field( 'lp_mpr_send_suggestion', 'lp_mpr_send_suggestion_nonce' );

echo '<style>
#lp-mpr{padding:10px;background:#f8fafc;border-radius:8px}
#lp-mpr .lp-header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:8px}
#lp-mpr .lp-eyebrow{margin:0;color:#475569;font-size:12px;letter-spacing:.04em;text-transform:uppercase}
#lp-mpr .lp-title{margin:2px 0 0;font-size:14px;font-weight:700;color:#0f172a}
#lp-mpr .lp-chips{display:flex;gap:6px;flex-wrap:wrap}
#lp-mpr .lp-chip{background:#fff;border:1px solid #e2e8f0;border-radius:999px;padding:4px 10px;font-size:12px;color:#0f172a;box-shadow:0 1px 2px rgba(15,23,42,.06);display:inline-flex;align-items:center;gap:6px}
#lp-mpr .lp-note{margin:4px 0 10px;color:#475569;font-size:12px}
#lp-mpr .lp-row{margin:10px 0;padding:12px;border:1px solid #e2e8f0;border-radius:10px;background:#fff;box-shadow:0 1px 3px rgba(15,23,42,.06)}
#lp-mpr .lp-top{display:flex;align-items:flex-start;gap:12px;flex-wrap:wrap}
#lp-mpr .lp-name{flex:1;font-size:13px;line-height:1.45;color:#0f172a}
#lp-mpr .lp-qty{width:96px}
#lp-mpr .lp-preview{font-size:12px;color:#475569;min-width:60px;text-align:right}
#lp-mpr small.muted{color:#667085}
#lp-mpr .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
#lp-mpr .lp-actions{margin-top:14px;padding:12px;border-top:1px solid #e5e7eb;background:#fff;border-radius:10px}
#lp-mpr .is-disabled{opacity:.6}
#lp-mpr .lp-suggestions{margin-top:10px;padding-top:10px;border-top:1px dashed #e5e7eb}
#lp-mpr .lp-suggestion{display:flex;gap:8px;align-items:flex-start;margin:6px 0;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:8px}
#lp-mpr .lp-suggestion .lp-sq{width:80px}
#lp-mpr .lp-suggestion .lp-remove{margin-left:auto}
#lp-mpr .lp-add{margin-top:6px}
#lp-mpr .select2-container{min-width:320px}
#lp-mpr .delta-badge{font-size:11px;padding:2px 6px;border-radius:999px;background:#eef2ff;color:#1d4ed8;margin-left:6px;white-space:nowrap}
#lp-mpr .mode{font-size:12px;color:#334155}
#lp-mpr .lp-log{margin-top:14px;padding:12px;border:1px solid #e2e8f0;border-radius:10px;background:#fff;box-shadow:0 1px 2px rgba(15,23,42,.06)}
#lp-mpr .lp-log h3{margin:0 0 6px;font-size:14px;font-weight:700;color:#0f172a}
#lp-mpr .lp-log-entry{display:flex;gap:10px;padding:6px 0;border-bottom:1px solid #e2e8f0}
#lp-mpr .lp-log-entry:last-child{border-bottom:0}
#lp-mpr .lp-log-status{font-size:11px;background:#eef2ff;color:#1d4ed8;border-radius:999px;padding:2px 8px;flex:0 0 auto;white-space:nowrap}
#lp-mpr .lp-log-message{flex:1;min-width:0;font-size:13px;color:#0f172a}
#lp-mpr .lp-log-meta{font-size:12px;color:#475569;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
#lp-mpr .lp-log-actor{color:#475569;font-size:12px}
</style>';

	echo '<div id="lp-mpr" role="group" aria-label="' . esc_attr__( 'Erstatninger for manglende varer', 'lilleprinsen' ) . '">';

	$stats = array( 'active' => 0, 'suggestions' => 0 );
	foreach ( $saved as $row ) {
	if ( ! empty( $row['enabled'] ) ) $stats['active']++;
	if ( ! empty( $row['suggestions'] ) && is_array( $row['suggestions'] ) ) $stats['suggestions'] += count( $row['suggestions'] );
	}
	$line_items_count = count( $order->get_items( 'line_item' ) );

	echo '<div class="lp-header">';
	echo '<div><p class="lp-eyebrow">' . esc_html__( 'Oversikt', 'lilleprinsen' ) . '</p><p class="lp-title">' . esc_html__( 'Manglende varer & forslag', 'lilleprinsen' ) . '</p></div>';
	echo '<div class="lp-chips">';
	echo '<span class="lp-chip">üì¶ ' . esc_html( sprintf( _n( '%d varelinje', '%d varelinjer', $line_items_count, 'lilleprinsen' ), $line_items_count ) ) . '</span>';
	echo '<span class="lp-chip">‚úÖ ' . esc_html( sprintf( _n( '%d aktiv', '%d aktive', $stats['active'], 'lilleprinsen' ), $stats['active'] ) ) . '</span>';
	echo '<span class="lp-chip">üí° ' . esc_html( sprintf( _n( '%d forslag', '%d forslag', $stats['suggestions'], 'lilleprinsen' ), $stats['suggestions'] ) ) . '</span>';
echo '</div>';
echo '</div>';
echo '<p class="lp-note">' . esc_html__( 'Stegene ligger nederst for √• gi deg full oversikt ‚Äì merk linjene som mangler, legg til forslag og send lenke til kunden.', 'lilleprinsen' ) . '</p>';

foreach ( $order->get_items( 'line_item' ) as $item_id => $item ) {
		$name         = $item->get_name();
		$variation_id = $item->get_variation_id();
		$ordered_qty  = (int) $item->get_quantity();

		$key       = (string) $item_id;
		$row_saved = isset( $saved[ $key ] ) && is_array( $saved[ $key ] ) ? $saved[ $key ] : array();

		$enabled   = ! empty( $row_saved['enabled'] );
		$qty_val   = isset( $row_saved['qty'] ) ? max( 0, (int) $row_saved['qty'] ) : 0;

		$unit = lp_mpr_get_line_unit_prices( $order, $item );
		$orig_unit_gross = (float) $unit['unit_gross_total'];

		$suggestions = array();
		if ( ! empty( $row_saved['suggestions'] ) && is_array( $row_saved['suggestions'] ) ) {
			foreach ( $row_saved['suggestions'] as $sug ) {
				$pid = isset( $sug['product_id'] ) ? absint( $sug['product_id'] ) : 0;
				$sq  = isset( $sug['qty'] ) ? max( 0, (int) $sug['qty'] ) : 0;
				$mode= isset( $sug['mode'] ) ? (string) $sug['mode'] : ''; // 'customer_pays' | 'store_covers'
				if ( $pid && $sq > 0 ) {
					$p = wc_get_product( $pid );
					if ( $p ) {
                                                $coupon_applied = false;
                                                $delta = lp_mpr_calc_delta_gross( $orig_unit_gross, $p, $sq, $order, $coupon_applied );
                                                $delta = lp_mpr_apply_discount_to_delta( $delta, $discount_ctx, $coupon_applied );
						if ( $mode === '' ) $mode = $delta > 0 ? 'customer_pays' : 'store_covers';
						$suggestions[] = array(
							'product_id' => $p->get_id(),
							'label'      => wp_strip_all_tags( $p->get_formatted_name() ),
							'qty'        => $sq,
							'mode'       => $mode,
							'delta'      => $delta,
						);
					}
				}
			}
		}

		$checkbox_id = 'lp-enable-' . (int) $item_id;
		$qty_id      = 'lp-qty-' . (int) $item_id;

		echo '<div class="lp-row' . ( $enabled ? '' : ' is-disabled' ) . '" data-item-id="' . esc_attr( $item_id ) . '" data-order-id="' . esc_attr( $order->get_id() ) . '">';

		echo '<div class="lp-top">';
		echo '<div>';
		echo '<input type="checkbox" id="' . esc_attr( $checkbox_id ) . '" class="lp-enable" name="lp_replacements[' . esc_attr( $key ) . '][enabled]" value="1" ' . checked( $enabled, true, false ) . '>';
		echo '<label class="sr-only" for="' . esc_attr( $checkbox_id ) . '">' . esc_html__( 'Bruk erstatning for denne linja', 'lilleprinsen' ) . '</label>';
		echo '</div>';

		echo '<div class="lp-name">';
		echo esc_html( $name );
		if ( $variation_id ) echo '<br><small class="muted">#' . esc_html( $variation_id ) . '</small>';
		echo '</div>';

		echo '<input type="number" ' . ( $enabled ? '' : 'disabled' ) . ' id="' . esc_attr( $qty_id ) . '" class="lp-qty" min="0" max="' . esc_attr( $ordered_qty ) . '" step="1" name="lp_replacements[' . esc_attr( $key ) . '][qty]" value="' . esc_attr( $qty_val ) . '" aria-label="' . esc_attr__( 'Manglende antall (som skal erstattes)', 'lilleprinsen' ) . '" aria-describedby="' . esc_attr( $qty_id ) . '-desc">';
		echo '<div class="lp-preview" id="' . esc_attr( $qty_id ) . '-desc" aria-live="polite" data-ordered="' . esc_attr( $ordered_qty ) . '">' . esc_html( $qty_val . '/' . $ordered_qty ) . '</div>';
		echo '</div>';

		echo '<div class="lp-suggestions">';
		echo '<div class="lp-suggestion-rows" data-name-prefix="lp_replacements[' . esc_attr( $key ) . '][suggestions]">';

		if ( $enabled && ! empty( $suggestions ) ) {
			foreach ( $suggestions as $idx => $sug ) {
				$select_id = 'lp-sel-' . (int) $item_id . '-' . (int) $idx;
				$sq_id     = 'lp-sq-' . (int) $item_id . '-' . (int) $idx;
				$mode_name = 'lp_replacements[' . esc_attr( $key ) . '][suggestions][' . esc_attr( $idx ) . '][mode]';
				echo '<div class="lp-suggestion" data-idx="' . esc_attr( $idx ) . '">';
				echo '<select ' . ( $enabled ? '' : 'disabled' ) . ' id="' . esc_attr( $select_id ) . '" class="wc-product-search lp-sel" style="width:100%" name="lp_replacements[' . esc_attr( $key ) . '][suggestions][' . esc_attr( $idx ) . '][product_id]" data-placeholder="' . esc_attr__( 'S√∏k etter erstatning ‚Ä¶', 'lilleprinsen' ) . '" data-action="' . esc_attr( apply_filters( 'lp_mpr_search_action', 'lp_mpr_search_products_with_stock' ) ) . '" data-allow_clear="true">';
				echo '<option value="' . esc_attr( $sug['product_id'] ) . '" selected="selected">' . esc_html( $sug['label'] ) . '</option>';
				echo '</select>';
				$sign = $sug['delta'] > 0 ? '+ ' : ( $sug['delta'] < 0 ? '‚àí ' : '' );
				$delta_html = $sign . wc_price( abs( $sug['delta'] ), array( 'currency' => $order->get_currency() ) );
				echo '<span class="delta-badge" title="' . esc_attr__( 'Prisforskjell for valgt antall', 'lilleprinsen' ) . '">' . wp_kses_post( $delta_html ) . '</span>';
				echo '<input type="number" ' . ( $enabled ? '' : 'disabled' ) . ' id="' . esc_attr( $sq_id ) . '" class="lp-sq" min="0" step="1" name="lp_replacements[' . esc_attr( $key ) . '][suggestions][' . esc_attr( $idx ) . '][qty]" value="' . esc_attr( (int) $sug['qty'] ) . '" aria-label="' . esc_attr__( 'Foresl√•tt antall for dette produktet', 'lilleprinsen' ) . '">';
				$mode_name_attr = esc_attr( $mode_name );
				echo '<label class="mode"><input type="radio" name="'.$mode_name_attr.'" value="customer_pays" '.checked($sug['mode'],'customer_pays',false).'/> ' . esc_html__( 'Kunden betaler', 'lilleprinsen' ) . '</label>';
				echo '<label class="mode" style="margin-left:8px;"><input type="radio" name="'.$mode_name_attr.'" value="store_covers" '.checked($sug['mode'],'store_covers',false).'/> ' . esc_html__( 'Butikken dekker', 'lilleprinsen' ) . '</label>';
				echo '<button type="button" class="button lp-remove" ' . ( $enabled ? '' : 'disabled' ) . ' aria-label="' . esc_attr__( 'Fjern forslag', 'lilleprinsen' ) . '">√ó</button>';
				echo '</div>';
			}
		}

		echo '</div>'; // rows
		echo '<button type="button" class="button lp-add" ' . ( $enabled ? '' : 'disabled' ) . '>' . esc_html__( 'Legg til forslag', 'lilleprinsen' ) . '</button>';
		echo '<p class="description" style="margin:6px 0 0;">' . esc_html__( 'Kunden kan godkjenne ett eller flere forslag, men summen kan ikke v√¶re h√∏yere enn manglende antall.', 'lilleprinsen' ) . '</p>';
		echo '</div>'; // suggestions

		echo '</div>'; // row
	}

	echo '<div class="lp-actions">';
	echo '<p style="margin:0 0 6px;"><label for="lp_mpr_message" style="font-weight:600;">' . esc_html__( 'Send forslag til kunden', 'lilleprinsen' ) . '</label><br>';
	echo '<textarea id="lp_mpr_message" name="lp_mpr_message" rows="3" placeholder="' . esc_attr__( 'Valgfri melding ‚Ä¶', 'lilleprinsen' ) . '"></textarea></p>';
        echo '<p style="margin:6px 0 0;"><button type="button" class="button button-primary" id="lp-mpr-send-btn" disabled>' . esc_html__( 'Send forslag', 'lilleprinsen' ) . '</button> ';
        echo '<span class="description">' . esc_html__( 'Sender en lenke til egen portal via kunde-notat e-post.', 'lilleprinsen' ) . '</span></p>';
        echo '</div>';

        $logs = array_reverse( lp_mpr_get_log_entries( $order ) );
        echo '<div class="lp-log">';
        echo '<h3>' . esc_html__( 'Logg og status', 'lilleprinsen' ) . '</h3>';
        echo '<p class="lp-log-meta" style="margin:0 0 6px;">' . esc_html__( 'Viser handlinger fra admin, kunden og systemet ‚Äì inkludert e-poster og reserveringer.', 'lilleprinsen' ) . '</p>';
        if ( empty( $logs ) ) {
                echo '<p class="description" style="margin:6px 0 0;">' . esc_html__( 'Ingen loggf√∏rt aktivitet enn√•.', 'lilleprinsen' ) . '</p>';
        } else {
                foreach ( $logs as $entry ) {
                        $when   = ! empty( $entry['at'] ) ? date_i18n( 'Y-m-d H:i', (int) $entry['at'] ) : '';
                        $status = ! empty( $entry['status'] ) ? lp_mpr_log_status_label( (string) $entry['status'] ) : '';
                        $actor_key = (string) ( $entry['actor'] ?? 'system' );
                        $actor = $actor_key === 'customer' ? __( 'Kunde', 'lilleprinsen' ) : ( ( $actor_key === 'admin' ) ? __( 'Admin', 'lilleprinsen' ) : __( 'System', 'lilleprinsen' ) );
                        $message = isset( $entry['message'] ) ? (string) $entry['message'] : '';

                        echo '<div class="lp-log-entry">';
                        if ( $status ) echo '<span class="lp-log-status">' . esc_html( $status ) . '</span>';
                        echo '<div class="lp-log-message">' . esc_html( $message ) . '</div>';
                        echo '<div class="lp-log-meta">';
                        if ( $when ) echo '<span>' . esc_html( $when ) . '</span>';
                        echo '<span class="lp-log-actor">' . esc_html( $actor ) . '</span>';
                        echo '</div>';
                        echo '</div>';
                }
        }
        echo '</div>';

        echo '</div>'; // #lp-mpr
        ?>
	<script>
	jQuery(function($){
		const previewNonce = '<?php echo esc_js( wp_create_nonce( 'lp_mpr_preview_delta' ) ); ?>';

		function initProductSearch($ctx){
			const $els = $ctx ? $ctx.find('.wc-product-search').filter(':not(.enhanced)') : $('.wc-product-search').filter(':not(.enhanced)');
			if ( $.fn.wc_product_search ) {
				$els.each(function(){ $(this).addClass('enhanced').wc_product_search(); });
			} else if ( $.fn.selectWoo ) {
				$els.each(function(){
					const $el = $(this);
					const actionName = $el.data('action') || 'lp_mpr_search_products_with_stock';
					$el.addClass('enhanced').selectWoo({
						allowClear: true,
						minimumInputLength: 2,
						ajax: {
							url: ajaxurl, dataType: 'json', delay: 250,
							data: function(params){ return { term: params.term || '', action: actionName, security: '<?php echo esc_js( wp_create_nonce( 'search-products' ) ); ?>' }; },
							processResults: function(data){ const results = []; $.each(data, function(id, text){ results.push({id:id, text:text}); }); return { results: results }; }
						},
						width: '100%'
					});
				});
			}
		}
		initProductSearch();

		function toggleRow($row, on){
			$row.toggleClass('is-disabled', !on);
			$row.find('.lp-qty, .wc-product-search, .lp-add, .lp-remove, .lp-sq, .mode input').prop('disabled', !on).trigger('change.select2');
		}
		$('#lp-mpr').on('change', '.lp-enable', function(){ toggleRow($(this).closest('.lp-row'), this.checked); refreshSendState(); });
		$('#lp-mpr .lp-row').each(function(){ toggleRow($(this), $(this).find('.lp-enable').is(':checked')); });

		$('#lp-mpr').on('input change', '.lp-qty', function(){
			const $row = $(this).closest('.lp-row');
			const ordered = parseInt($row.find('.lp-preview').attr('data-ordered'), 10) || 0;
			let chosen  = parseInt(this.value || '0', 10); if (isNaN(chosen)) chosen = 0;
			chosen = Math.max(0, Math.min(ordered, chosen)); this.value = chosen;
			$row.find('.lp-preview').text(chosen + '/' + ordered); refreshSendState();
		});

		// --- FIKS: robust beregning av neste index (tar h√∏yde for slettinger) ---
		function nextIndex($container){
			let maxIdx = -1;
			$container.children('.lp-suggestion').each(function(){
				const i = parseInt($(this).attr('data-idx') || '-1', 10);
				if (!isNaN(i)) maxIdx = Math.max(maxIdx, i);
			});
			return maxIdx + 1;
		}

		function recalcDelta($sug){
			const $row = $sug.closest('.lp-row');
			const orderId = parseInt($row.data('order-id'), 10) || 0;
			const itemId  = parseInt($row.data('item-id'), 10) || 0;
			const productId = parseInt($sug.find('.lp-sel').val(), 10) || 0;
			const qty = parseInt($sug.find('.lp-sq').val(), 10) || 0;
			if(!orderId || !itemId || !productId || !qty){
				$sug.find('.delta-badge').html('<?php echo wp_kses_post( wc_price( 0 ) ); ?>');
				return;
			}
			$.post(ajaxurl, { action:'lp_mpr_preview_delta', nonce: previewNonce, order_id: orderId, item_id: itemId, product_id: productId, qty: qty })
			.done(function(resp){ if(resp && resp.success && resp.data && resp.data.html){ $sug.find('.delta-badge').html(resp.data.html); } });
		}

		// Legg til forslag
		$(document).on('click', '#lp-mpr .lp-add', function(e){
			e.preventDefault();
			const $row = $(this).closest('.lp-row');
			const $container = $row.find('.lp-suggestion-rows');
			const prefix = $container.data('name-prefix');
			const itemId = $row.data('item-id');
			const idx = nextIndex($container);
			const selId = 'lp-sel-' + itemId + '-' + idx;
			const sqId  = 'lp-sq-' + itemId + '-' + idx;
			const modeName = prefix+'['+ idx +'][mode]';

			const html =
			'<div class="lp-suggestion" data-idx="'+ idx +'">\
				<select id="'+ selId +'" class="wc-product-search lp-sel" style="width:100%" \
					name="'+ prefix +'['+ idx +'][product_id]" \
					data-placeholder="<?php echo esc_js( __( 'S√∏k etter erstatning ‚Ä¶', 'lilleprinsen' ) ); ?>" \
					data-action="<?php echo esc_js( apply_filters( 'lp_mpr_search_action', 'lp_mpr_search_products_with_stock' ) ); ?>" \
					data-allow_clear="true"></select>\
				<span class="delta-badge"><?php echo wp_kses_post( wc_price( 0 ) ); ?></span>\
				<input type="number" id="'+ sqId +'" class="lp-sq" min="0" step="1" name="'+ prefix +'['+ idx +'][qty]" value="1" aria-label="<?php echo esc_js( __( 'Foresl√•tt antall for dette produktet', 'lilleprinsen' ) ); ?>">\
				<label class="mode"><input type="radio" name="'+modeName+'" value="customer_pays" checked/> <?php echo esc_js( __( 'Kunden betaler', 'lilleprinsen' ) ); ?></label>\
				<label class="mode" style="margin-left:8px;"><input type="radio" name="'+modeName+'" value="store_covers"/> <?php echo esc_js( __( 'Butikken dekker', 'lilleprinsen' ) ); ?></label>\
				<button type="button" class="button lp-remove" aria-label="<?php echo esc_js( __( 'Fjern forslag', 'lilleprinsen' ) ); ?>">√ó</button>\
			</div>';

			const $html = $(html);
			$container.append($html);
			initProductSearch($html);
			refreshSendState();
		});

		// Fjern forslag
		$(document).on('click', '#lp-mpr .lp-remove', function(e){
			e.preventDefault();
			$(this).closest('.lp-suggestion').remove();
			refreshSendState();
		});

		// Delta-live
		$(document).on('change input', '#lp-mpr .lp-suggestion .lp-sel, #lp-mpr .lp-suggestion .lp-sq', function(){ recalcDelta($(this).closest('.lp-suggestion')); });
		$('#lp-mpr .lp-suggestion').each(function(){ recalcDelta($(this)); });

		// Send-fanen
		const $orderForm = $('#post').length ? $('#post') : $('#lp-mpr').closest('form'); if (!$orderForm.attr('id')) $orderForm.attr('id','lp-mpr-form');

		function collectEnabledRows(){
			const rows = [];
			$('#lp-mpr .lp-row').each(function(){
				const $row = $(this);
				const enabled = $row.find('.lp-enable').is(':checked');
				if (!enabled) return;
				const missingQty = parseInt($row.find('.lp-qty').val(), 10) || 0;
				if (missingQty <= 0) return;
				let hasSuggestion = false;
				$row.find('.lp-suggestion').each(function(){
					const pid = $(this).find('.lp-sel').val();
					const sq  = parseInt($(this).find('.lp-sq').val(), 10) || 0;
					if (pid && sq > 0) { hasSuggestion = true; }
				});
				if (hasSuggestion) rows.push(true);
			});
			return rows;
		}
		function refreshSendState(){ $('#lp-mpr-send-btn').prop('disabled', collectEnabledRows().length === 0); }
		$(document).on('change input', '#lp-mpr .lp-sel, #lp-mpr .lp-sq, #lp-mpr .mode input', refreshSendState);
		refreshSendState();

		// Send forslag
		$(document).on('click', '#lp-mpr #lp-mpr-send-btn', function(e){
			e.preventDefault();
			const $btn = $(this);
			$btn.prop('disabled', true);
			const data = $orderForm.serializeArray();
			data.push({ name: 'action',   value: 'lp_mpr_send_suggestion' });
			data.push({ name: 'order_id', value: '<?php echo esc_js( $order->get_id() ); ?>' });
			$.post(ajaxurl, data)
			.done(function(resp){
				if (resp && resp.success) {
					alert(resp.data && resp.data.message ? resp.data.message : '<?php echo esc_js( __( 'Forslaget ble sendt til kunden.', 'lilleprinsen' ) ); ?>');
					location.reload();
				} else {
					alert((resp && resp.data && resp.data.message) || '<?php echo esc_js( __( 'Klarte ikke √• sende forslaget.', 'lilleprinsen' ) ); ?>');
				}
			})
			.fail(function(){ alert('<?php echo esc_js( __( 'Nettverksfeil. Pr√∏v igjen.', 'lilleprinsen' ) ); ?>'); })
			.always(function(){ $btn.prop('disabled', false); });
		});
	});
	</script>
	<?php
}
/** Lagre verdier fra admin-metaboks (inkl. modus per forslag) */
add_action( 'woocommerce_process_shop_order_meta', function( $order_id ) {
	if ( ! isset( $_POST['lp_missing_replacements_nonce'] ) || ! wp_verify_nonce( $_POST['lp_missing_replacements_nonce'], 'lp_missing_replacements_save' ) ) return;
	if ( ! current_user_can( 'edit_shop_order', $order_id ) ) return;
	$order = wc_get_order( $order_id );
	if ( ! $order ) return;

	$raw = isset( $_POST['lp_replacements'] ) && is_array( $_POST['lp_replacements'] ) ? wp_unslash( $_POST['lp_replacements'] ) : array();

	$clean = array();
	foreach ( $order->get_items( 'line_item' ) as $item_id => $item ) {
		$key = (string) $item_id;
		if ( empty( $raw[ $key ] ) || ! is_array( $raw[ $key ] ) ) continue;
		$row = $raw[ $key ];

		$enabled     = ! empty( $row['enabled'] );
		$qty_posted  = isset( $row['qty'] ) ? (int) $row['qty'] : 0;
		$ordered     = (int) $item->get_quantity();
		$missing_qty = max( 0, min( $ordered, $qty_posted ) );

		$sugs_clean = array();
		if ( ! empty( $row['suggestions'] ) && is_array( $row['suggestions'] ) ) {
			foreach ( $row['suggestions'] as $sug ) {
				$pid  = isset( $sug['product_id'] ) ? absint( $sug['product_id'] ) : 0;
				$sq   = isset( $sug['qty'] ) ? (int) $sug['qty'] : 0;
				$mode = isset( $sug['mode'] ) ? sanitize_key( $sug['mode'] ) : '';
				$sq   = max( 0, $sq );
				if ( $pid && $sq > 0 ) {
					$p = wc_get_product( $pid );
					if ( $p ) {
						if ( $mode !== 'customer_pays' && $mode !== 'store_covers' ) {
							$unit = lp_mpr_get_line_unit_prices( $order, $item );
							$delta = lp_mpr_calc_delta_gross( (float) $unit['unit_gross_total'], $p, $sq, $order );
							$mode = $delta > 0 ? 'customer_pays' : 'store_covers';
						}
						$sugs_clean[] = array( 'product_id' => $p->get_id(), 'qty' => $sq, 'mode' => $mode );
					}
				}
			}
		}

		if ( $enabled && $missing_qty > 0 && ! empty( $sugs_clean ) ) {
			$clean[ $key ] = array(
				'enabled'     => 1,
				'qty'         => $missing_qty,
				'suggestions' => array_values( $sugs_clean ),
			);
		}
	}

	if ( ! empty( $clean ) ) {
		$order->update_meta_data( '_lp_missing_replacements', $clean );
	} else {
		$order->delete_meta_data( '_lp_missing_replacements' );
	}
	$order->save();
}, 20 );

/** Bygg portal-URL (ren rute) */
function lp_mpr_build_portal_url( WC_Order $order, $issue_ver = 0 ) : string {
$order_id = $order->get_id();
$key      = $order->get_order_key();

$args = array(
'lp_mpr_portal'   => 1,
'lp_mpr_order_id' => $order_id,
'lp_mpr_key'      => $key,
);

if ( $issue_ver ) $args['v'] = (int) $issue_ver;

return add_query_arg( $args, home_url( '/' ) );
}
add_filter( 'lp_mpr_portal_url', function( $url, $order_id ){
$order = wc_get_order( $order_id );
if ( ! $order ) return $url;
	$issue = (array) $order->get_meta( '_lp_mpr_issue', true );
	$ver = (int) ( $issue['ver'] ?? 0 );
	return lp_mpr_build_portal_url( $order, $ver );
}, 10, 2 );

/** AJAX: send forslag p√• e-post med portal-lenke (gjen√•pner issue) */
add_action( 'wp_ajax_lp_mpr_send_suggestion', 'lp_mpr_send_suggestion' );
function lp_mpr_send_suggestion() {
	if ( empty( $_POST['order_id'] ) ) wp_send_json_error( array( 'message' => __( 'Mangler ordre-ID.', 'lilleprinsen' ) ) );
	$order_id = absint( $_POST['order_id'] );
	$order    = wc_get_order( $order_id );
	if ( ! $order ) wp_send_json_error( array( 'message' => __( 'Fant ikke ordren.', 'lilleprinsen' ) ) );
	if ( ! current_user_can( 'edit_shop_order', $order_id ) ) wp_send_json_error( array( 'message' => __( 'Du har ikke tilgang til dette.', 'lilleprinsen' ) ) );
	if ( empty( $_POST['lp_mpr_send_suggestion_nonce'] ) || ! wp_verify_nonce( $_POST['lp_mpr_send_suggestion_nonce'], 'lp_mpr_send_suggestion' ) ) {
		wp_send_json_error( array( 'message' => __( 'Sikkerhetssjekk feilet.', 'lilleprinsen' ) ) );
	}

	// Persist√©r siste admin-valg
	$raw = isset( $_POST['lp_replacements'] ) && is_array( $_POST['lp_replacements'] ) ? wp_unslash( $_POST['lp_replacements'] ) : array();

	$clean = array();
	foreach ( $order->get_items( 'line_item' ) as $item_id => $item ) {
		$key = (string) $item_id;
		if ( empty( $raw[ $key ] ) || ! is_array( $raw[ $key ] ) ) continue;
		$row = $raw[ $key ];

		$enabled     = ! empty( $row['enabled'] );
		$qty_posted  = isset( $row['qty'] ) ? (int) $row['qty'] : 0;
		$ordered     = (int) $item->get_quantity();
		$missing_qty = max( 0, min( $ordered, $qty_posted ) );

		$sugs_clean = array();
		if ( ! empty( $row['suggestions'] ) && is_array( $row['suggestions'] ) ) {
			foreach ( $row['suggestions'] as $sug ) {
				$pid  = isset( $sug['product_id'] ) ? absint( $sug['product_id'] ) : 0;
				$sq   = isset( $sug['qty'] ) ? (int) $sug['qty'] : 0;
				$mode = isset( $sug['mode'] ) ? sanitize_key( $sug['mode'] ) : '';
				$sq   = max( 0, $sq );
				if ( $pid && $sq > 0 ) {
					$p = wc_get_product( $pid );
					if ( $p ) {
						if ( $mode !== 'customer_pays' && $mode !== 'store_covers' ) {
							$unit = lp_mpr_get_line_unit_prices( $order, $item );
							$delta = lp_mpr_calc_delta_gross( (float) $unit['unit_gross_total'], $p, $sq, $order );
							$mode = $delta > 0 ? 'customer_pays' : 'store_covers';
						}
						$sugs_clean[] = array( 'product_id' => $p->get_id(), 'qty' => $sq, 'mode' => $mode );
					}
				}
			}
		}

		if ( $enabled && $missing_qty > 0 && ! empty( $sugs_clean ) ) {
			$clean[ $key ] = array(
				'enabled'     => 1,
				'qty'         => $missing_qty,
				'suggestions' => array_values( $sugs_clean ),
			);
		}
	}

        if ( ! empty( $clean ) ) {
                $order->update_meta_data( '_lp_missing_replacements', $clean );
        } else {
                $order->delete_meta_data( '_lp_missing_replacements' );
                $order->save();
                wp_send_json_error( array( 'message' => __( 'Ingen gyldige forslag √• sende.', 'lilleprinsen' ) ) );
        }

        // Ta vare p√• rabattkontekst slik at kunden f√•r samme prosent ved oppgradering
        $discount_ctx = lp_mpr_get_discount_context( $order );
        if ( $discount_ctx['percent'] > 0 ) {
                $order->update_meta_data( '_lp_mpr_discount_context', $discount_ctx );
        } else {
                $order->delete_meta_data( '_lp_mpr_discount_context' );
        }

	// Gjen√•pne "issue"
        $issue = (array) $order->get_meta( '_lp_mpr_issue', true );
        $ver   = isset( $issue['ver'] ) ? (int) $issue['ver'] : 0;
        $ver++;
        $order->update_meta_data( '_lp_mpr_issue', array(
                'ver'      => $ver,
                'consumed' => false,
                'sent_at'  => time(),
        ) );
        if ( $order->get_status() !== 'feedback' ) {
                $order->set_status( 'feedback', __( 'Forslag sendt til kunde for tilbakemelding.', 'lilleprinsen' ) );
        }
        $order->save();
        lp_mpr_append_log_entry( $order, __( 'Alternativer sendt til kunden.', 'lilleprinsen' ), 'alternativer_sendt', 'admin', array( 'url' => $url ) );
        lp_mpr_schedule_reminders( $order, $ver );

        // Throttle
        $throttle_key = 'lp_mpr_sent_' . $order_id;
	if ( get_transient( $throttle_key ) ) {
		wp_send_json_error( array( 'message' => __( 'Forslag ble nettopp sendt. Vent et lite √∏yeblikk f√∏r du sender igjen.', 'lilleprinsen' ) ) );
	}
	set_transient( $throttle_key, 1, MINUTE_IN_SECONDS * 2 );

	// Ny portal-lenke
	$url = apply_filters( 'lp_mpr_portal_url', '', $order_id );

	// Kunde-notat
	$extra = isset( $_POST['lp_mpr_message'] ) ? wp_kses_post( wp_unslash( $_POST['lp_mpr_message'] ) ) : '';
        $note  = $extra ? $extra . "\n\n" : '';
        $note .= sprintf( __( 'Vi har foresl√•tt alternativer for varer vi mangler. √Öpne portalen her: %s', 'lilleprinsen' ), esc_url( $url ) );
        if ( $discount_ctx['percent'] > 0 && ! empty( $discount_ctx['codes'] ) ) {
                $note .= "\n\n" . sprintf(
                        __( 'Vi s√∏rger for at rabatten din (%1$s) ogs√• gjelder om du velger et dyrere alternativ.', 'lilleprinsen' ),
                        implode( ', ', array_map( 'esc_html', $discount_ctx['codes'] ) )
                );
        }
        $order->add_order_note( $note, false );

        do_action( 'lp_mpr_suggestion_emailed', $order, $url, $clean );

        wp_send_json_success( array( 'message' => __( 'Forslaget ble sendt til kunden.', 'lilleprinsen' ), 'url' => $url ) );
}

add_action( 'lp_mpr_suggestion_emailed', function( WC_Order $order, string $url, array $suggestions ) {
        if ( ! $order || empty( $suggestions ) ) return;

        $discount_ctx = (array) $order->get_meta( '_lp_mpr_discount_context', true );
        if ( empty( $discount_ctx ) ) $discount_ctx = lp_mpr_get_discount_context( $order );

        $lines = array();
        foreach ( $order->get_items( 'line_item' ) as $item_id => $item ) {
                $key = (string) $item_id;
                if ( empty( $suggestions[ $key ]['suggestions'] ) ) continue;

                $missing_qty = max( 0, (int) ( $suggestions[ $key ]['qty'] ?? 0 ) );
                $row_suggestions = (array) $suggestions[ $key ]['suggestions'];

                $unit_prices       = lp_mpr_get_line_unit_prices( $order, $item );
                $orig_unit_gross   = (float) $unit_prices['unit_gross_total'];
                $item_label        = wp_strip_all_tags( $item->get_name() );
                $suggestion_lines  = array();

                foreach ( $row_suggestions as $sug ) {
                        $pid  = absint( $sug['product_id'] ?? 0 );
                        $qty  = max( 0, (int) ( $sug['qty'] ?? 0 ) );
                        $mode = (string) ( $sug['mode'] ?? '' );
                        if ( ! $pid || $qty <= 0 ) continue;

                        $product = wc_get_product( $pid );
                        $name    = $product ? wp_strip_all_tags( $product->get_formatted_name() ) : '#' . $pid;
                        $coupon_applied = false;
                        $delta_raw = $product ? lp_mpr_calc_delta_gross( $orig_unit_gross, $product, $qty, $order, $coupon_applied ) : 0.0;
                        $delta     = lp_mpr_apply_discount_to_delta( $delta_raw, $discount_ctx, $coupon_applied );

                        $delta_label = $delta === 0.0
                                ? __( 'ingen prisendring', 'lilleprinsen' )
                                : ( ( $delta > 0 ? '+ ' : '‚àí ' ) . wp_strip_all_tags( wc_price( abs( $delta ), array( 'currency' => $order->get_currency() ) ) ) );
                        $payer_label = $mode === 'store_covers' || $delta < 0
                                ? __( 'Butikken dekker mellomlegget', 'lilleprinsen' )
                                : __( 'Kunde betaler mellomlegget', 'lilleprinsen' );

                        $suggestion_lines[] = sprintf( '%s √ó %d ‚Äî %s (%s)', $name, $qty, $delta_label, $payer_label );
                }

                if ( ! empty( $suggestion_lines ) ) {
                        $intro = sprintf( __( '%1$s (mangler %2$d):', 'lilleprinsen' ), $item_label, $missing_qty );
                        $lines[] = $intro . ' ' . implode( '; ', $suggestion_lines );
                }
        }

        $body  = '<p>' . esc_html__( 'Vi har forslag klare for deg ‚Äì bekreft hvilke erstatninger du √∏nsker.', 'lilleprinsen' ) . '</p>';
        if ( ! empty( $lines ) ) {
                $body .= '<ul style="padding-left:20px;line-height:1.5;">';
                foreach ( $lines as $line ) {
                        $body .= '<li>' . esc_html( $line ) . '</li>';
                }
                $body .= '</ul>';
        }
        $body .= '<p>' . esc_html__( 'Klikk p√• knappen under for √• √•pne erstatningsportalen.', 'lilleprinsen' ) . '</p>';

        lp_mpr_send_branded_email(
                $order->get_billing_email(),
                __( 'Velg erstatningene dine', 'lilleprinsen' ),
                __( 'Vi har forslag til deg', 'lilleprinsen' ),
                $body,
                array( 'label' => __( '√Öpne portalen', 'lilleprinsen' ), 'url' => $url ),
                $order,
                'alternativer_sendt'
        );

        if ( ! empty( $lines ) ) {
                $note  = __( 'MPR: Forslag sendt til kunde.', 'lilleprinsen' );
                $note .= "\n" . implode( "\n", $lines );
                $order->add_order_note( $note, false );
        }
}, 10, 3 );

/* ==========================================================
 *           PORTAL ‚Äì rewrite + query vars + hooks
 * ========================================================== */

/** Gjenbrukbar sjekk: er dette en portal-foresp√∏rsel? */
function lp_mpr_is_portal_request() : bool {
  return intval( get_query_var( 'lp_mpr_portal' ) ) === 1;
}

function lp_mpr_register_portal_route() {
  add_rewrite_rule( '^lp-mpr/([0-9]+)/([^/]+)/?$', 'index.php?lp_mpr_portal=1&lp_mpr_order_id=$matches[1]&lp_mpr_key=$matches[2]', 'top' );
}
add_action( 'init', 'lp_mpr_register_portal_route' );

// Ingen kanonisk omdirigering eller WooCommerce-kontekst for portalen
add_filter( 'redirect_canonical', function( $redirect ) {
  return lp_mpr_is_portal_request() ? false : $redirect;
} );
add_filter( 'woocommerce_is_account_page', function( $is_account_page ) {
  return lp_mpr_is_portal_request() ? false : $is_account_page;
} );

add_filter( 'query_vars', function( $vars ){
	$vars[] = 'lp_mpr_portal';
	$vars[] = 'lp_mpr_order_id';
	$vars[] = 'lp_mpr_key';
	return $vars;
} );

/** Flush rewrites p√• aktivering/oppdatering */
register_activation_hook( __FILE__, function(){
	lp_mpr_register_portal_route();
	flush_rewrite_rules();
} );
register_deactivation_hook( __FILE__, function(){
	flush_rewrite_rules();
} );

/* ==========================================================
 *                 PORTAL-AJAX (gjestesikker) ‚Äî del 1
 * ========================================================== */

add_action( 'wp_ajax_lp_mpr_portal_action', 'lp_mpr_portal_action' );
add_action( 'wp_ajax_nopriv_lp_mpr_portal_action', 'lp_mpr_portal_action' );
function lp_mpr_portal_action() {
	$which      = isset( $_POST['which'] ) ? sanitize_key( wp_unslash( $_POST['which'] ) ) : '';
	$order_id   = isset( $_POST['order_id'] ) ? absint( $_POST['order_id'] ) : 0;
	$order_key  = isset( $_POST['order_key'] ) ? (string) $_POST['order_key'] : '';
	$nonce      = isset( $_POST['nonce'] ) ? (string) $_POST['nonce'] : '';
	$issue_ver  = isset( $_POST['issue_ver'] ) ? (int) $_POST['issue_ver'] : -1;

	if ( ! wp_verify_nonce( $nonce, 'lp_mpr_portal_action' ) ) wp_send_json_error( array( 'message' => __( 'Sikkerhetssjekk feilet.', 'lilleprinsen' ) ) );

        $order = $order_id ? wc_get_order( $order_id ) : false;
        if ( ! $order ) wp_send_json_error( array( 'message' => __( 'Fant ikke ordren.', 'lilleprinsen' ) ) );

        // Sjekk kunde-kontekst (lenke med order-key skal alltid fungere)
        $valid_key = $order_key && hash_equals( (string) $order->get_order_key(), (string) $order_key );
        $ok_context = $valid_key;
        if ( ! $ok_context && is_user_logged_in() ) {
                $ok_context = ( (int) $order->get_user_id() === (int) get_current_user_id() ) || current_user_can( 'edit_shop_order', $order_id );
        }
        if ( ! $ok_context ) wp_send_json_error( array( 'message' => __( 'Du har ikke tilgang til denne ordren.', 'lilleprinsen' ) ) );

	// liten throttle
	$ip   = isset( $_SERVER['REMOTE_ADDR'] ) ? sanitize_text_field( wp_unslash( $_SERVER['REMOTE_ADDR'] ) ) : '0.0.0.0';
	$thk  = 'lp_mpr_th_' . md5( $order_id . '|' . $which . '|' . $ip );
	if ( get_transient( $thk ) ) wp_send_json_error( array( 'message' => __( 'Vent et lite √∏yeblikk f√∏r du pr√∏ver igjen.', 'lilleprinsen' ) ) );
	set_transient( $thk, 1, 5 );

        $allowed = array( 'approve_update', 'delete_missing', 'send_chat' );
        if ( ! in_array( $which, $allowed, true ) ) wp_send_json_error( array( 'message' => __( 'Ukjent handling.', 'lilleprinsen' ) ) );

        // Versjonssjekk
        $issue = (array) $order->get_meta( '_lp_mpr_issue', true );
        $cur_ver = isset( $issue['ver'] ) ? (int) $issue['ver'] : 0;
        $strict_issue_check = $which !== 'send_chat';
        if ( $strict_issue_check && $issue_ver >= 0 && $issue_ver !== $cur_ver ) wp_send_json_error( array( 'message' => __( 'Denne lenken er utl√∏pt. Bruk den siste vi sendte.', 'lilleprinsen' ) ) );

        // Blokker hvis allerede konsumert (flag settes ved suksess)
        if ( $strict_issue_check && ! empty( $issue['consumed'] ) ) wp_send_json_error( array( 'message' => __( 'Denne foresp√∏rselen er allerede besvart.', 'lilleprinsen' ) ) );

        if ( $which === 'send_chat' ) {
                $raw_msg = isset( $_POST['message'] ) ? wp_unslash( $_POST['message'] ) : '';
                $msg     = lp_mpr_sanitize_chat_message( $raw_msg );
                if ( '' === $msg ) wp_send_json_error( array( 'message' => __( 'Skriv en melding f√∏rst.', 'lilleprinsen' ) ) );

                $chat = lp_mpr_create_customer_chat( $order, $msg, $cur_ver );
                $order->add_order_note( sprintf( __( 'MPR portal: Kunde √•pnet chat: %s', 'lilleprinsen' ), $msg ), false );
                lp_mpr_append_log_entry( $order, sprintf( __( 'Kunde √•pnet chat: %s', 'lilleprinsen' ), $msg ), 'chat', 'customer' );

                $admin_email = apply_filters( 'lp_mpr_chat_notification_email', 'kundeservice@lilleprinsen.no', $order );
                if ( $admin_email ) {
                        $subject = sprintf( __( 'Ny chat fra kunde p√• ordre #%s', 'lilleprinsen' ), $order->get_order_number() );
                        $body  = '<p>' . sprintf( esc_html__( 'En kunde har sendt en chat fra portalen for ordre #%s.', 'lilleprinsen' ), esc_html( $order->get_order_number() ) ) . '</p>';
                        $body .= '<p><strong>' . esc_html__( 'Melding', 'lilleprinsen' ) . ':</strong><br>' . nl2br( esc_html( $msg ) ) . '</p>';
                        $body .= '<p><strong>' . esc_html__( 'Forslag sendt', 'lilleprinsen' ) . ':</strong> ' . esc_html( $chat['suggestions'] ?? '' ) . '</p>';
                        $body .= '<p><a href="' . esc_url( admin_url( 'admin.php?page=lp-mpr-settings#lp-mpr-chats' ) ) . '">' . esc_html__( '√Öpne chats i innstillingene', 'lilleprinsen' ) . '</a></p>';
                        wc_mail( $admin_email, $subject, $body, array( 'Content-Type: text/html; charset=UTF-8' ) );
                }

                wp_send_json_success( array( 'message' => __( 'Meldingen er sendt. Vi svarer p√• e-post.', 'lilleprinsen' ) ) );
        }

        $data = (array) $order->get_meta( '_lp_missing_replacements', true );
	/* ===== approve_update ===== */
	if ( $which === 'approve_update' ) {
                $sel_raw = isset( $_POST['selections'] ) ? wp_unslash( $_POST['selections'] ) : array();

                if ( is_string( $sel_raw ) ) {
                        $decoded = json_decode( $sel_raw, true );
                        if ( json_last_error() !== JSON_ERROR_NONE || ! is_array( $decoded ) ) $decoded = maybe_unserialize( $sel_raw );
                        if ( is_array( $decoded ) ) $sel_raw = $decoded;
                }
          $selections = is_array( $sel_raw ) ? wc_clean( $sel_raw ) : array();

          $declines_raw = isset( $_POST['declines'] ) ? wp_unslash( $_POST['declines'] ) : array();
          if ( is_string( $declines_raw ) ) {
                  $decoded = json_decode( $declines_raw, true );
                  if ( json_last_error() !== JSON_ERROR_NONE || ! is_array( $decoded ) ) $decoded = maybe_unserialize( $declines_raw );
                  if ( is_array( $decoded ) ) $declines_raw = $decoded;
          }
          $declines = array();
          foreach ( (array) $declines_raw as $d ) { $id = absint( $d ); if ( $id ) $declines[] = $id; }
          $declines = array_values( array_unique( $declines ) );

          if ( empty( $selections ) && empty( $declines ) ) { $order->add_order_note( 'MPR portal: tomt valg fra kunden.', false ); wp_send_json_error( array( 'message' => __( 'Vi mottok ingen valg.', 'lilleprinsen' ) ) ); }

          $respondable = array();
          foreach ( $data as $row_item_id => $row ) {
                  $row_item_id = (int) $row_item_id;
                  if ( empty( $row['enabled'] ) ) continue;
                  $missing_qty = max( 0, (int) ( $row['qty'] ?? 0 ) );
                  if ( $missing_qty <= 0 ) continue;
                  $respondable[] = $row_item_id;
          }
          if ( count( $respondable ) > 1 ) {
                  foreach ( $respondable as $rid ) {
                          if ( empty( $selections[ (string) $rid ] ) && ! in_array( $rid, $declines, true ) ) {
                                  wp_send_json_error( array( 'message' => __( 'Velg erstatning eller sletting for alle varene som mangler.', 'lilleprinsen' ) ) );
                          }
                  }
          }

                // Cap mot "missing"
                foreach ( $selections as $item_id_str => $indexes ) {
                        $item_id = absint( $item_id_str ); $key = (string) $item_id;
                        $missing_qty = isset( $data[ $key ]['qty'] ) ? max( 0, (int) $data[ $key ]['qty'] ) : 0;
                        $sugs        = ! empty( $data[ $key ]['suggestions'] ) ? array_values( $data[ $key ]['suggestions'] ) : array();
			$chosen_total = 0;
			if ( is_array( $indexes ) ) foreach ( $indexes as $i ) if ( isset( $sugs[ $i ] ) ) $chosen_total += max( 0, (int) ( $sugs[ $i ]['qty'] ?? 0 ) );
			if ( $missing_qty > 0 && $chosen_total > $missing_qty ) { $order->add_order_note( 'MPR portal: over-valg blokkert.', false ); wp_send_json_error( array( 'message' => __( 'Valgt antall er for h√∏yt i forhold til det som mangler.', 'lilleprinsen' ) ) ); }
		}

		// Lager-sjekk + reservasjon
		$want = array(); // pid => qty
		foreach ( $selections as $item_id_str => $indexes ) {
			$item_id = absint( $item_id_str ); $key = (string) $item_id;
			$sugs = ! empty( $data[ $key ]['suggestions'] ) ? array_values( $data[ $key ]['suggestions'] ) : array();
			if ( ! is_array( $indexes ) ) continue;
			foreach ( $indexes as $i ) {
				$i = absint( $i );
				if ( isset( $sugs[ $i ] ) ) {
					$pid = absint( $sugs[ $i ]['product_id'] ?? 0 );
					$qty = max( 0, (int) ( $sugs[ $i ]['qty'] ?? 0 ) );
					if ( $pid && $qty > 0 ) $want[$pid] = ($want[$pid] ?? 0) + $qty;
				}
			}
		}

		$reserved = array();
		foreach ( $want as $pid => $qty ) {
			if ( apply_filters( 'lp_mpr_skip_external_stock_manager', false, $pid ) ) continue;
			$p = wc_get_product( $pid );
			if ( ! $p || ! $p->is_purchasable() ) wp_send_json_error( array( 'message' => sprintf( __( 'Erstatningsprodukt #%d er ikke kj√∏pbart lenger.', 'lilleprinsen' ), $pid ) ) );
			if ( $p->backorders_allowed() ) continue;
			if ( $p->managing_stock() ) {
				$have = (int) $p->get_stock_quantity();
				if ( $have < $qty ) wp_send_json_error( array( 'message' => sprintf( __( 'Beklager! %1$s har bare %3$d p√• lager, men du valgte %2$d.', 'lilleprinsen' ), wp_strip_all_tags( $p->get_formatted_name() ), $qty, max(0,$have) ) ) );
				$updated = wc_update_product_stock( $p, $qty, 'decrease' );
				if ( is_wp_error( $updated ) ) wp_send_json_error( array( 'message' => __( 'Kunne ikke reservere lager for valgt vare.', 'lilleprinsen' ) ) );
				$reserved[ $pid ] = $qty;
			} else {
				if ( ! $p->is_in_stock() ) wp_send_json_error( array( 'message' => sprintf( __( '%s er ikke p√• lager lenger.', 'lilleprinsen' ), wp_strip_all_tags( $p->get_formatted_name() ) ) ) );
			}
		}

                $delete_items = array();
                foreach ( $declines as $decline_item_id ) {
                        $key = (string) $decline_item_id;
                        if ( empty( $data[ $key ]['enabled'] ) ) continue;
                        $missing = max( 0, (int) ( $data[ $key ]['qty'] ?? 0 ) );
                        if ( $missing <= 0 ) continue;
                        $delete_items[] = array( 'order_item_id' => (int) $decline_item_id, 'missing_qty' => $missing );
                }

                $payload = lp_mpr_build_payload( $order, $data, $selections, array( 'reserved_products' => $reserved, 'issue_ver' => $cur_ver ) );
                if ( ! empty( $delete_items ) ) $payload['delete_only'] = $delete_items;
                if ( empty( $payload['items'] ) && empty( $payload['delete_only'] ) ) { $order->add_order_note( __( 'MPR: Ingen gyldige valg i payload.', 'lilleprinsen' ), false ); wp_send_json_error( array( 'message' => __( 'Ingen gyldige valg funnet.', 'lilleprinsen' ) ) ); }

		$hash = lp_mpr_selection_hash( $payload );
		$pending = (array) $order->get_meta( '_lp_mpr_pending', true );
		$pending['hash']    = $hash;
		$pending['payload'] = $payload;
		$order->update_meta_data( '_lp_mpr_pending', $pending );

		// Registr√©r reservasjoner (med TTL)
		if ( ! empty( $reserved ) ) {
			$order->update_meta_data( '_lp_mpr_reservations', array(
				'products'   => $reserved,
				'expires_at' => time() + lp_mpr_reservation_ttl_seconds(),
				'issue_ver'  => $cur_ver,
			) );
		}
		$order->save();

                // Planlegg kun frigj√∏ring av reservasjoner og bruk endringene umiddelbart
                if ( function_exists( 'as_schedule_single_action' ) ) {
                        if ( function_exists( 'as_unschedule_all_actions' ) ) as_unschedule_all_actions( LP_MPR_RELEASE_JOB_ACTION, array( $order->get_id(), $cur_ver ), LP_MPR_JOB_GROUP );
                        $res = (array) $order->get_meta( '_lp_mpr_reservations', true );
                        if ( ! empty( $res['expires_at'] ) ) as_schedule_single_action( (int) $res['expires_at'], LP_MPR_RELEASE_JOB_ACTION, array( $order->get_id(), $cur_ver ), LP_MPR_JOB_GROUP, true );
                }

                $issue['consumed'] = true;
                $order->update_meta_data( '_lp_mpr_issue', $issue );
                $order->save();

                try {
                        $result = lp_mpr_run_apply_job( $order->get_id() ) ?: array();
                } catch ( Throwable $e ) {
                        wp_send_json_error( array( 'message' => __( 'Kunne ikke oppdatere ordren akkurat n√•.', 'lilleprinsen' ) ) );
                }

                if ( ! empty( $result['pending_fee'] ) ) {
                        $amount = (float) ( $result['pending_fee']['amount'] ?? 0.0 );
                        lp_mpr_append_log_entry( $order, sprintf( __( 'Kunde godkjente alternativer med mellomlegg p√• %s.', 'lilleprinsen' ), wc_price( $amount, array( 'currency' => $order->get_currency() ) ) ), 'kunde_godkjent_venter', 'customer' );
                } else {
                        lp_mpr_append_log_entry( $order, __( 'Kunde godkjente og ordren er oppdatert.', 'lilleprinsen' ), 'kunde_godkjent', 'customer' );
                }

                $redirect = add_query_arg( 'lp_mpr_done', '1', lp_mpr_build_portal_url( $order, $cur_ver ) );
                $pricing = (array) ( $result['pricing'] ?? array() );
                $order_total_html = $pricing['order_total_html'] ?? wp_kses_post( wc_price( $order->get_total(), array( 'currency' => $order->get_currency() ) ) );
                $summary_key = '';
                $delta_sum   = isset( $pricing['delta_gross_sum'] ) ? (float) $pricing['delta_gross_sum'] : 0.0;
                if ( $delta_sum <= 0 && empty( $result['pending_fee'] ) ) {
                        $summary_key = lp_mpr_store_customer_summary( $order, $result );
                }

                $response = array( 'ok' => true, 'pricing' => $pricing );
                if ( ! empty( $result['pending_fee']['order_id'] ) ) {
                        $child = wc_get_order( (int) $result['pending_fee']['order_id'] );
                        $response['redirect'] = $child ? $child->get_checkout_payment_url() : esc_url_raw( $redirect );
                        $response['message']  = __( 'Vi sender deg videre til en trygg betalingsside for mellomlegget.', 'lilleprinsen' );
                } else {
                        $response['message'] = sprintf( __( 'Ordren er oppdatert. Ny totalsum: %s', 'lilleprinsen' ), $order_total_html );
                        $response['order_total_html'] = $order_total_html;
                        if ( $summary_key ) {
                                $response['redirect'] = add_query_arg( array(
                                        'lp_mpr_done'    => '1',
                                        'lp_mpr_summary' => rawurlencode( $summary_key ),
                                ), $redirect );
                        }
                }

                wp_send_json_success( $response );
        }

        /* ===== delete_missing ===== */
	if ( $which === 'delete_missing' ) {
		$delete_items = array();
		foreach ( $order->get_items( 'line_item' ) as $item_id => $item ) {
			$key = (string) $item_id;
			if ( empty( $data[ $key ]['enabled'] ) ) continue;
			$missing = max( 0, (int) ( $data[ $key ]['qty'] ?? 0 ) );
			if ( $missing <= 0 ) continue;
			$delete_items[] = array( 'order_item_id' => (int) $item_id, 'missing_qty' => $missing );
		}
		if ( empty( $delete_items ) ) wp_send_json_error( array( 'message' => __( 'Ingen manglende linjer √• slette.', 'lilleprinsen' ) ) );

		$payload = array(
			'order_id'    => $order->get_id(),
			'delete_only' => $delete_items,
			'issue_ver'   => $cur_ver,
			'created_at'  => time(),
			'policy'      => array( 'shipping' => 'no_rerate', 'discounts' => 'freeze' ),
		);
                $hash = lp_mpr_selection_hash( $payload );
                $pending = (array) $order->get_meta( '_lp_mpr_pending', true );
                $pending['hash']    = $hash;
                $pending['payload'] = $payload;
                $order->update_meta_data( '_lp_mpr_pending', $pending );
                $order->save();

                if ( function_exists( 'as_schedule_single_action' ) && function_exists( 'as_unschedule_all_actions' ) ) {
                        as_unschedule_all_actions( LP_MPR_RELEASE_JOB_ACTION, array( $order->get_id(), $cur_ver ), LP_MPR_JOB_GROUP );
                }

                $issue['consumed'] = true;
                $order->update_meta_data( '_lp_mpr_issue', $issue );
                $order->save();

                try {
                        lp_mpr_run_apply_job( $order->get_id() );
                } catch ( Throwable $e ) {
                        wp_send_json_error( array( 'message' => __( 'Kunne ikke oppdatere ordren akkurat n√•.', 'lilleprinsen' ) ) );
                }

                lp_mpr_append_log_entry( $order, __( 'Kunde ba om sletting av manglende varer.', 'lilleprinsen' ), 'sletting_valgt', 'customer' );

                $redirect = add_query_arg( 'lp_mpr_done', '1', lp_mpr_build_portal_url( $order, $cur_ver ) );
                wp_send_json_success( array( 'ok' => true, 'redirect' => esc_url_raw( $redirect ) ) );
        }

	wp_send_json_success( array( 'ok' => true ) );
}

/* ========= PRODUKT-S√òK (admin) + live deltavisning ========= */

add_action( 'wp_ajax_lp_mpr_search_products_with_stock', 'lp_mpr_search_products_with_stock' );
function lp_mpr_search_products_with_stock() {
	if ( ! current_user_can( 'edit_products' ) ) wp_send_json_error( array( 'message' => __( 'Du har ikke tilgang til dette.', 'lilleprinsen' ) ) );
	$nonce = isset( $_REQUEST['security'] ) ? wp_unslash( $_REQUEST['security'] ) : '';
	if ( ! wp_verify_nonce( $nonce, 'search-products' ) ) wp_send_json_error( array( 'message' => __( 'Sikkerhetssjekk feilet.', 'lilleprinsen' ) ) );

	$term = isset( $_REQUEST['term'] ) ? wc_clean( wp_unslash( $_REQUEST['term'] ) ) : '';
	$results       = array();
	$max           = (int) apply_filters( 'lp_mpr_search_limit', 30 );
	$only_in_stock = (bool) apply_filters( 'lp_mpr_search_only_in_stock', false );
	$max_children  = (int) apply_filters( 'lp_mpr_search_max_children', 50 );

	$products = wc_get_products( array(
		'status'  => array( 'publish', 'private' ),
		'limit'   => $max,
		'type'    => array( 'simple', 'variable' ),
		'orderby' => 'title',
		'order'   => 'ASC',
		's'       => (string) $term,
		'return'  => 'objects',
	) );
	foreach ( $products as $product ) {
		if ( $product->is_type( 'simple' ) ) {
			if ( $only_in_stock && ! $product->is_in_stock() ) continue;
			$results[ $product->get_id() ] = lp_mpr_format_label_with_stock( $product );
		} elseif ( $product->is_type( 'variable' ) ) {
			$children = array_slice( (array) $product->get_children(), 0, $max_children );
			foreach ( $children as $vid ) {
				if ( count( $results ) >= $max ) break;
				$variation = wc_get_product( $vid );
				if ( ! $variation || ! $variation->exists() ) continue;
				if ( $only_in_stock && ! $variation->is_in_stock() ) continue;
				$hay = strtolower( $variation->get_formatted_name() . ' ' . $variation->get_sku() );
				if ( $term === '' || strpos( $hay, strtolower( $term ) ) !== false ) $results[ $variation->get_id() ] = lp_mpr_format_label_with_stock( $variation );
			}
		}
	}
	if ( empty( $results ) && $term ) {
		$sku_id = wc_get_product_id_by_sku( $term );
		if ( $sku_id ) {
			$p = wc_get_product( $sku_id );
			if ( $p && ( ! $only_in_stock || $p->is_in_stock() ) ) $results[ $p->get_id() ] = lp_mpr_format_label_with_stock( $p );
		}
	}
	wp_send_json( $results );
}

function lp_mpr_format_label_with_stock( WC_Product $product ) : string {
	$name = wp_strip_all_tags( $product->get_formatted_name() );
	$sku  = $product->get_sku();
	$stock_text = $product->is_in_stock() ? __( 'P√• lager', 'lilleprinsen' ) : __( 'Tomt p√• lager', 'lilleprinsen' );
	if ( $product->managing_stock() ) {
		$q = $product->get_stock_quantity();
		$stock_text = is_null($q) ? $stock_text : sprintf( __( 'P√• lager: %d', 'lilleprinsen' ), (int) $q );
		if ( $product->backorders_allowed() && $product->get_stock_status() === 'onbackorder' ) $stock_text = __( 'Restordre', 'lilleprinsen' );
	}
	$bits = array( $name, $sku ? '['.$sku.']' : '', '‚Äî ' . $stock_text );
	return trim( implode( ' ', array_filter( $bits ) ) );
}

add_action( 'wp_ajax_lp_mpr_preview_delta', function () {
	if ( ! current_user_can( 'edit_shop_orders' ) ) wp_send_json_error( array( 'message' => __( 'Mangler rettigheter.', 'lilleprinsen' ) ) );
	if ( empty( $_POST['nonce'] ) || ! wp_verify_nonce( wp_unslash( $_POST['nonce'] ), 'lp_mpr_preview_delta' ) ) wp_send_json_error( array( 'message' => __( 'Sikkerhetssjekk feilet.', 'lilleprinsen' ) ) );

	$order_id  = absint( $_POST['order_id'] ?? 0 );
	$item_id   = absint( $_POST['item_id'] ?? 0 );
	$product_id= absint( $_POST['product_id'] ?? 0 );
	$qty       = max( 0, intval( $_POST['qty'] ?? 0 ) );

	$order = wc_get_order( $order_id );
	$item  = $order ? $order->get_item( $item_id ) : false;
	$p     = $product_id ? wc_get_product( $product_id ) : false;

	if ( ! $order || ! $item || ! $p || $qty <= 0 ) {
		wp_send_json_success( array( 'html' => wp_kses_post( wc_price( 0, array( 'currency' => $order ? $order->get_currency() : get_woocommerce_currency() ) ) ) ) );
	}

        $unit = lp_mpr_get_line_unit_prices( $order, $item );
        $coupon_applied = false;
        $delta = lp_mpr_calc_delta_gross( (float) $unit['unit_gross_total'], $p, $qty, $order, $coupon_applied );
        $discount_ctx = (array) $order->get_meta( '_lp_mpr_discount_context', true );
        if ( empty( $discount_ctx ) ) $discount_ctx = lp_mpr_get_discount_context( $order );
        $delta = lp_mpr_apply_discount_to_delta( $delta, $discount_ctx, $coupon_applied );
	$sign  = $delta > 0 ? '+ ' : ( $delta < 0 ? '‚àí ' : '' );
	$html  = $sign . wc_price( abs( $delta ), array( 'currency' => $order->get_currency() ) );
	wp_send_json_success( array( 'html' => wp_kses_post( $html ) ) );
} );

/* ===== BUILD PAYLOAD + JOBB DRIVER + RESERVASJON RELEASE ===== */

function lp_mpr_build_payload( WC_Order $order, array $data, array $selections, array $opts = array() ) : array {
	$items = array();
	foreach ( $selections as $item_id_str => $indexes ) {
		$item_id = absint( $item_id_str ); $key = (string) $item_id;
		if ( empty( $data[ $key ]['enabled'] ) || empty( $data[ $key ]['suggestions'] ) ) continue;

		$order_item = $order->get_item( $item_id ); if ( ! $order_item || 'line_item' !== $order_item->get_type() ) continue;
		$orig_qty_total   = (int) $order_item->get_quantity();
		$missing_qty      = max( 0, (int) ( $data[ $key ]['qty'] ?? 0 ) );

		$qty_safe           = max( 1, $orig_qty_total );
		$unit_net_subtotal  = (float) $order_item->get_subtotal()     / $qty_safe;
		$unit_tax_subtotal  = (float) $order_item->get_subtotal_tax() / $qty_safe;
		$unit_net_total     = (float) $order_item->get_total()        / $qty_safe;
		$unit_tax_total     = (float) $order_item->get_total_tax()    / $qty_safe;

		$unit_gross_subtotal = $unit_net_subtotal + $unit_tax_subtotal;
		$unit_gross_total    = $unit_net_total    + $unit_tax_total;

		$orig_tax_class = $order_item->get_tax_class();

		$sugs   = array_values( $data[ $key ]['suggestions'] );
		$chosen = array();
		if ( is_array( $indexes ) ) {
			foreach ( $indexes as $i ) {
				$i = absint( $i );
				if ( isset( $sugs[ $i ] ) ) {
					$pid  = absint( $sugs[ $i ]['product_id'] ?? 0 );
					$sq   = max( 0, (int) ( $sugs[ $i ]['qty'] ?? 0 ) );
					$mode = in_array( (string) ( $sugs[ $i ]['mode'] ?? '' ), array( 'customer_pays', 'store_covers' ), true ) ? (string) $sugs[ $i ]['mode'] : 'customer_pays';
					if ( $pid && $sq > 0 ) $chosen[] = array( 'product_id' => $pid, 'qty' => $sq, 'mode' => $mode );
				}
			}
		}
		if ( empty( $chosen ) ) continue;

		$items[] = array(
			'order_item_id'       => $item_id,
			'old_product_id'      => $order_item->get_product_id(),
			'old_variation_id'    => $order_item->get_variation_id(),
			'missing_qty'         => $missing_qty,
			'unit_gross_subtotal' => $unit_gross_subtotal,
			'unit_gross_total'    => $unit_gross_total,
			'unit_tax_subtotal'   => $unit_tax_subtotal,
			'unit_tax_total'      => $unit_tax_total,
			'tax_class'           => is_string( $orig_tax_class ) ? $orig_tax_class : '',
			'replacements'        => $chosen, // inkluderer 'mode'
		);
	}

	$payload = array(
		'order_id'   => $order->get_id(),
		'items'      => $items,
		'policy'     => array(
			'pricing'   => 'preserve_gross_per_unit',
			'tax'       => 'keep_original_tax_class',
			'discounts' => 'freeze',
			'shipping'  => 'no_rerate',
			'stock'     => array( 'new' => 'reduce_by_qty', 'old' => apply_filters( 'lp_mpr_force_old_stock_zero', false ) ? 'force_zero' : 'decrease' ),
		),
		'created_at' => time(),
	);
	if ( ! empty( $opts['reserved_products'] ) && is_array( $opts['reserved_products'] ) ) $payload['reserved_products'] = array_map( 'absint', $opts['reserved_products'] );
	if ( isset( $opts['issue_ver'] ) ) $payload['issue_ver'] = (int) $opts['issue_ver'];

	return $payload;
}

function lp_mpr_acquire_lock( $order_id ) : bool { $key = 'lp_mpr_lock_order_' . (int) $order_id; if ( get_transient( $key ) ) return false; set_transient( $key, 1, (int) apply_filters( 'lp_mpr_lock_ttl', 600 ) ); return true; }
function lp_mpr_release_lock( $order_id ) : void { delete_transient( 'lp_mpr_lock_order_' . (int) $order_id ); }

function lp_mpr_run_apply_job( $order_id ) {
        $order_id = absint( $order_id ); $order = wc_get_order( $order_id ); if ( ! $order ) return;
        if ( ! lp_mpr_acquire_lock( $order_id ) ) { if ( function_exists( 'as_schedule_single_action' ) ) as_schedule_single_action( time() + 30, LP_MPR_JOB_ACTION, array( $order->get_id() ), LP_MPR_JOB_GROUP, true ); $order->add_order_note( 'MPR: Jobb hoppet over pga. aktiv l√•s; planlagt ny kj√∏ring.', false ); return null; }
        $result = null;
        try {
                $pending = (array) $order->get_meta( '_lp_mpr_pending', true );
                if ( empty( $pending['hash'] ) || empty( $pending['payload'] ) ) { $order->add_order_note( __( 'MPR: Ingen ventende payload √• bruke.', 'lilleprinsen' ), false ); return null; }
                $hash    = (string) $pending['hash'];
                $payload = (array) $pending['payload'];

                $applied_map = (array) $order->get_meta( '_lp_mpr_applied', true );
                if ( ! empty( $applied_map[ $hash ] ) ) { $order->add_order_note( __( 'MPR: Payload allerede brukt (idempotent).', 'lilleprinsen' ), false ); return null; }

                $blocked = apply_filters( 'lp_mpr_blocked_statuses', array( 'cancelled', 'refunded', 'failed' ) );
                if ( in_array( $order->get_status(), $blocked, true ) ) throw new Exception( 'Ordre har avsluttende status: ' . $order->get_status() );

                do_action( 'lp_mpr_before_apply', $order, $payload );
                $result = lp_mpr_apply_replacements_atomic_v2( $order, $payload );

                if ( ! empty( $result['pending_fee'] ) ) {
                        $amount = (float) ( $result['pending_fee']['amount'] ?? 0.0 );
                        $order->add_order_note( sprintf( __( 'MPR: Venter p√• tilleggsbetaling (%s). Varer er reservert inntil fristen.', 'lilleprinsen' ), wc_price( $amount, array( 'currency' => $order->get_currency() ) ) ), true );
                        $order->save();
                        return $result;
                }

		$applied_map[ $hash ] = array( 'applied_at' => time(), 'v' => 2 );
		$order->update_meta_data( '_lp_mpr_applied', $applied_map );

		$current = (array) $order->get_meta( '_lp_mpr_pending', true );
		if ( isset( $current['hash'] ) && $current['hash'] === $hash ) $order->delete_meta_data( '_lp_mpr_pending' );

		if ( apply_filters( 'lp_mpr_delete_meta_on_success', true, $order, $payload ) ) $order->delete_meta_data( '_lp_missing_replacements' );
		$order->delete_meta_data( '_lp_mpr_reservations' );

		$order->update_status( 'oppdatert', __( 'Erstatninger er lagt inn (MPR).', 'lilleprinsen' ), true ); $order->save();

		do_action( 'lp_mpr_after_apply', $order, $result );
		lp_mpr_send_customer_confirmation( $order, $result );

        } catch ( Throwable $e ) {
                $order->add_order_note( sprintf( __( 'MPR feilet: %s', 'lilleprinsen' ), $e->getMessage() ), false );
                do_action( 'lp_mpr_apply_failed', $order, $e );
                throw $e;
        } finally { lp_mpr_release_lock( $order_id ); }
        return $result;
}
add_action( 'plugins_loaded', function () {
        add_action( LP_MPR_JOB_ACTION,         'lp_mpr_run_apply_job',       10, 1 );
        add_action( LP_MPR_RELEASE_JOB_ACTION, 'lp_mpr_release_reservations',10, 2 );
        add_action( LP_MPR_REMINDER_JOB_ACTION,'lp_mpr_send_missing_reminder',10, 2 );
} );

function lp_mpr_release_reservations( $order_id, $issue_ver = 0 ) {
	$order = wc_get_order( $order_id ); if ( ! $order ) return;
	$res = (array) $order->get_meta( '_lp_mpr_reservations', true ); if ( empty( $res['products'] ) ) return;
	if ( isset( $res['issue_ver'] ) && $issue_ver && (int) $res['issue_ver'] !== (int) $issue_ver ) return;

	$pending = (array) $order->get_meta( '_lp_mpr_pending', true );
	if ( empty( $pending ) ) { $order->delete_meta_data( '_lp_mpr_reservations' ); $order->save(); return; }

        foreach ( (array) $res['products'] as $pid => $qty ) {
                $pid = absint( $pid ); $qty = max( 0, (int) $qty ); if ( ! $pid || $qty <= 0 ) continue;
                if ( apply_filters( 'lp_mpr_skip_external_stock_manager', false, $pid ) ) continue;
                $p = wc_get_product( $pid ); if ( $p && $p->managing_stock() ) wc_update_product_stock( $p, $qty, 'increase' );
        }
        $order->add_order_note( __( 'MPR: Reserverte varer er frigitt (tidsavbrudd).', 'lilleprinsen' ), false );
        lp_mpr_append_log_entry( $order, __( 'Reserverte varer ble frigitt etter tidsavbrudd.', 'lilleprinsen' ), 'reservasjon_frigitt', 'system' );
        $order->delete_meta_data( '_lp_mpr_reservations' ); $order->save();
}
/* ==========================================================
 *           ATOMISK MUTASJON V2 + EKSTRA-GEBYR (per forslag)
 * ========================================================== */

function lp_mpr_apply_replacements_atomic_v2( WC_Order $order, array $payload ) : array {
        if ( ! empty( $payload['delete_only'] ) ) return lp_mpr_apply_delete_only( $order, $payload );

        $policy          = (array) ( $payload['policy'] ?? array() );
        $old_stock_mode  = $policy['stock']['old'] ?? 'decrease';
        $cap_enabled     = true;
        $discount_ctx    = (array) $order->get_meta( '_lp_mpr_discount_context', true );
        if ( empty( $discount_ctx ) ) $discount_ctx = lp_mpr_get_discount_context( $order );

        $delta_gross_sum = 0.0; $delta_by_line = array();
        $pricing = array(
                'delta_gross_sum'       => 0.0,
                'order_total_before'    => (float) wc_format_decimal( $order->get_total(), wc_get_price_decimals() ),
        );

        // Kun forslag merket "customer_pays" skaper tilleggsordre ‚Äì og bare for positive deltas.
        foreach ( (array) $payload['items'] as $it ) {
		$allowed = max( 0, (int) ( $it['missing_qty'] ?? 0 ) );
		$reps    = (array) ( $it['replacements'] ?? array() );

		$approved_total = 0; foreach ( $reps as $rep ) { $approved_total += max(0,(int)$rep['qty']); }
		if ( $cap_enabled && $allowed > 0 ) $approved_total = min( $approved_total, $allowed );

		$orig_unit_gross = (float) $it['unit_gross_total'];
		$left = $approved_total; $d_line = 0.0;

		foreach ( $reps as $rep ) {
			if ( $left <= 0 ) break;
			$qty = min( $left, max( 0, (int) $rep['qty'] ) );
			if ( $qty <= 0 ) continue;
			if ( (string) ( $rep['mode'] ?? 'customer_pays' ) !== 'customer_pays' ) { $left -= $qty; continue; } // butikk dekker ‚Üí ikke med i avgift

                        $p = wc_get_product( absint( $rep['product_id'] ) );
                        if ( ! $p ) { $left -= $qty; continue; }
                        $coupon_factor = lp_mpr_get_coupon_factor_for_product( $p, $order );
                        $repl_unit_gross = lp_mpr_get_product_unit_gross_for_order( $p, $order ) * (float) $coupon_factor['factor'];
                        $diff_raw = max( 0, $repl_unit_gross - $orig_unit_gross ) * $qty; // Kunde betaler kun POSITIVT mellomlegg
                        $diff = lp_mpr_apply_discount_to_delta( $diff_raw, $discount_ctx, (bool) $coupon_factor['applies'] );
			$d_line += $diff;
			$left -= $qty;
		}
		if ( $d_line > 0 ) { $delta_by_line[ absint( $it['order_item_id'] ) ] = $d_line; $delta_gross_sum += $d_line; }
        }
        $delta_gross_sum = (float) wc_format_decimal( $delta_gross_sum, wc_get_price_decimals() );
        $pricing['delta_gross_sum'] = $delta_gross_sum;

        // Tilleggsordre hvis n√∏dvendig
        if ( $delta_gross_sum > 0 ) {
                $child = lp_mpr_create_extra_fee_order( $order, $payload, $delta_gross_sum, $delta_by_line );
                $order->update_meta_data( '_lp_mpr_child_fee_order_id', $child->get_id() ); $order->save();
                lp_mpr_email_extra_fee_invoice( $order, $child, $delta_gross_sum );
                $pricing['order_total_after']      = (float) wc_format_decimal( $pricing['order_total_before'] + $delta_gross_sum, wc_get_price_decimals() );
                $pricing['order_total_after_html'] = wp_kses_post( wc_price( $pricing['order_total_after'], array( 'currency' => $order->get_currency() ) ) );
                $pricing['order_total_before_html']= wp_kses_post( wc_price( $pricing['order_total_before'], array( 'currency' => $order->get_currency() ) ) );
                $pricing['order_total_delta']      = $delta_gross_sum;
                $pricing['order_total_delta_html'] = wp_kses_post( wc_price( abs( $delta_gross_sum ), array( 'currency' => $order->get_currency() ) ) );
                $pricing['order_total_html']       = $pricing['order_total_after_html'];
                $pricing['delta_payer']            = 'customer';

                return array( 'pending_fee' => array( 'order_id' => $child->get_id(), 'amount' => $delta_gross_sum ), 'pricing' => $pricing );
        }

        // Ellers: bruk erstatningene n√•
        $applied = lp_mpr_apply_now( $order, $payload, array( 'old_stock_mode' => $old_stock_mode, 'cap' => $cap_enabled ) );
        $pricing['order_total_after']      = (float) wc_format_decimal( $order->get_total(), wc_get_price_decimals() );
        $pricing['order_total_after_html'] = wp_kses_post( wc_price( $pricing['order_total_after'], array( 'currency' => $order->get_currency() ) ) );
        $pricing['order_total_delta']      = (float) wc_format_decimal( $pricing['order_total_after'] - $pricing['order_total_before'], wc_get_price_decimals() );
        $pricing['order_total_delta_html'] = wp_kses_post( wc_price( abs( $pricing['order_total_delta'] ), array( 'currency' => $order->get_currency() ) ) );
        $pricing['order_total_html']       = $pricing['order_total_after_html'];
        $pricing['order_total_before_html']= wp_kses_post( wc_price( $pricing['order_total_before'], array( 'currency' => $order->get_currency() ) ) );
        $pricing['delta_payer']            = $pricing['order_total_delta'] > 0
                ? ( $pricing['delta_gross_sum'] > 0 ? 'customer' : 'store' )
                : ( $pricing['order_total_delta'] < 0 ? 'store' : 'even' );
        $applied['pricing'] = $pricing;
        return $applied;
}

function lp_mpr_apply_delete_only( WC_Order $order, array $payload ) : array {
        $pricing = array(
                'delta_gross_sum'     => 0.0,
                'order_total_before'  => (float) wc_format_decimal( $order->get_total(), wc_get_price_decimals() ),
        );
        $changes = array();
        foreach ( (array) $payload['delete_only'] as $row ) {
                $order_item_id = absint( $row['order_item_id'] ); $missing = max(0,(int)($row['missing_qty']??0));
		if ( ! $order_item_id || $missing <= 0 ) continue;

		$old_item = $order->get_item( $order_item_id ); $old_qty = (int) $old_item->get_quantity();
		$new_qty = max(0,$old_qty-$missing);
		if ( $new_qty === 0 ) $order->remove_item( $old_item->get_id() );
		else {
			$scale = $new_qty / max(1,$old_qty);
			$old_item->set_quantity( $new_qty );
			$old_item->set_subtotal( (float)$old_item->get_subtotal() * $scale );
			$old_item->set_total(    (float)$old_item->get_total()    * $scale );
			$old_item->set_subtotal_tax( (float)$old_item->get_subtotal_tax()*$scale );
			$old_item->set_total_tax(    (float)$old_item->get_total_tax()   *$scale );
			$old_item->save();
		}
		$changes[] = array( 'order_item_id'=>$order_item_id, 'old'=>array('name'=>$old_item->get_name(),'qty_before'=>$old_qty,'qty_after'=>$new_qty), 'new_added'=>array() );
        }
        lp_mpr_recalculate_order( $order ); $order->save();
        $pricing['order_total_after']       = (float) wc_format_decimal( $order->get_total(), wc_get_price_decimals() );
        $pricing['order_total_after_html']  = wp_kses_post( wc_price( $pricing['order_total_after'], array( 'currency' => $order->get_currency() ) ) );
        $pricing['order_total_before_html'] = wp_kses_post( wc_price( $pricing['order_total_before'], array( 'currency' => $order->get_currency() ) ) );
        $pricing['order_total_delta']       = (float) wc_format_decimal( $pricing['order_total_after'] - $pricing['order_total_before'], wc_get_price_decimals() );
        $pricing['order_total_delta_html']  = wp_kses_post( wc_price( abs( $pricing['order_total_delta'] ), array( 'currency' => $order->get_currency() ) ) );
        $pricing['order_total_html']        = $pricing['order_total_after_html'];
        $pricing['delta_payer']             = $pricing['order_total_delta'] > 0 ? 'customer' : ( $pricing['order_total_delta'] < 0 ? 'store' : 'even' );
        if ( ! empty( $changes ) ) $order->add_order_note( __( 'üóëÔ∏è MPR: Manglende vare(r) slettet uten alternativ.', 'lilleprinsen' ), false );
        return array( 'changes'=>$changes, 'pricing' => $pricing );
}

function lp_mpr_describe_delta_reasons( WC_Order $order, array $delta_by_line ) : string {
        $parts = array();
        foreach ( $delta_by_line as $line_id => $delta ) {
                if ( (float) $delta <= 0.0 ) continue;
                $item = $order->get_item( $line_id );
                if ( ! $item || 'line_item' !== $item->get_type() ) continue;
                $name = wp_strip_all_tags( $item->get_name() );
                $qty  = max( 0, (int) $item->get_quantity() );
                $parts[] = $qty > 0
                        ? sprintf( _x( '%1$s √ó %2$d', 'product name √ó quantity', 'lilleprinsen' ), $name, $qty )
                        : $name;
        }

        $parts = array_filter( array_map( 'trim', $parts ) );
        if ( empty( $parts ) ) return '';

        if ( count( $parts ) > 3 ) {
                $parts = array_slice( $parts, 0, 3 );
                $parts[] = __( 'm.fl.', 'lilleprinsen' );
        }

        return implode( ', ', $parts );
}

function lp_mpr_apply_now( WC_Order $order, array $payload, array $opts ) : array {
        $changes = array(); $old_stock_mode = $opts['old_stock_mode'] ?? 'decrease'; $cap_enabled = ! empty( $opts['cap'] );
        $cap_total_at = array_key_exists( 'cap_total_at', $opts ) ? (float) wc_format_decimal( $opts['cap_total_at'], wc_get_price_decimals() ) : null;
        $fee_order_id = isset( $opts['fee_order_id'] ) ? (int) $opts['fee_order_id'] : 0;
        $baseline_total = (float) wc_format_decimal( null !== $cap_total_at ? $cap_total_at : $order->get_total(), wc_get_price_decimals() );
        $discount_applied = false; $discount_amount = 0.0; $discount_label = '';

	foreach ( (array) $payload['items'] as $it ) {
		$order_item_id = absint( $it['order_item_id'] ); $replacements = (array) ( $it['replacements'] ?? array() );
		$old_item = $order->get_item( $order_item_id ); if ( ! $old_item || 'line_item' !== $old_item->get_type() ) continue;

		$missing = max( 0, (int) $it['missing_qty'] ); $old_qty = (int) $old_item->get_quantity();
		$allowed = $missing > 0 ? $missing : $old_qty; if ( $allowed <= 0 ) { $order->add_order_note( sprintf('MPR: Hopper over linje %d ‚Äî allowed_qty=0.',$order_item_id), false ); continue; }

          $unit_gross_subtotal = (float) $it['unit_gross_subtotal']; $unit_gross_total = (float) $it['unit_gross_total'];
          $unit_tax_subtotal   = (float) $it['unit_tax_subtotal'];   $unit_tax_total  = (float) $it['unit_tax_total'];
          $tax_class           = (string) $it['tax_class'];

          $gross_discount_factor = lp_mpr_discount_factor_from_units( $unit_gross_subtotal, $unit_gross_total );

		$old_name = $old_item->get_name(); $old_pid = (int) $it['old_product_id']; $old_vid = (int) $it['old_variation_id'];

		$applied_for_this_item = array(); $old_line_taxes = $old_item->get_taxes();

		$approved_total = 0; foreach ( $replacements as $rep ) { $approved_total += max(0,(int)$rep['qty']); }
		if ( $cap_enabled && $allowed > 0 ) $approved_total = min( $approved_total, $allowed );
		if ( $approved_total <= 0 ) { $order->add_order_note( sprintf('MPR: Skipper linje %d ‚Äî approved_total=0 (allowed=%d).',$order_item_id,$allowed), false ); continue; }

		$left_to_apply = $approved_total;

		foreach ( $replacements as $rep ) {
			if ( $left_to_apply <= 0 ) break;

			$pid = absint( $rep['product_id'] ); $qty_req = max(0,(int)$rep['qty']); $qty = min( $qty_req, $left_to_apply );
			if ( ! $pid || $qty <= 0 ) continue;
			$product = wc_get_product( $pid ); if ( ! $product ) continue;

                  $price_data = lp_mpr_get_product_unit_breakdown_for_order( $product, $order );
                  $coupon_factor = lp_mpr_get_coupon_factor_for_product( $product, $order );
                  $effective_discount_factor = min( $gross_discount_factor, (float) $coupon_factor['factor'] );
                  $tax_map_subtotal = lp_mpr_scale_tax_amounts( $price_data['taxes'], $qty );
                  $tax_map_total    = lp_mpr_scale_tax_amounts( $price_data['taxes'], $effective_discount_factor * $qty );

                  $line = new WC_Order_Item_Product();
                  $line->set_product( $product );
                  $line->set_name( wp_strip_all_tags( $product->get_formatted_name() ) );
                  $line->set_quantity( $qty );
                  $line->set_subtotal( max( 0, (float) $price_data['unit_net'] ) * $qty );
                  $line->set_total(    max( 0, (float) $price_data['unit_net'] * $effective_discount_factor ) * $qty );
                  $line_tax_class = $product->get_tax_class();
                  if ( '' === $line_tax_class ) $line_tax_class = $tax_class;
                  $line->set_tax_class( $line_tax_class );
                  $line->set_subtotal_tax( array_sum( $tax_map_subtotal ) );
                  $line->set_total_tax(    array_sum( $tax_map_total ) );
                  $line->set_taxes( array( 'subtotal' => $tax_map_subtotal, 'total' => $tax_map_total ) );

			$order->add_item( $line ); $line->save();

			// Reduser lager (skip ved ekst./reservasjon)
			$stock_before = null; $stock_after = null;
			if ( ! apply_filters( 'lp_mpr_skip_external_stock_manager', false, $pid ) && $product->managing_stock() ) {
				$stock_before = $product->get_stock_quantity();
				$updated      = wc_update_product_stock( $product, $qty, 'decrease' );
				$stock_after  = is_wp_error( $updated ) ? $stock_before : (int) $updated;
				$line->add_meta_data( '_reduced_stock', $qty ); $line->save();
			}

			$applied_for_this_item[] = array(
				'type'           => 'added',
				'product_id'     => $pid,
				'name'           => $product->get_name(),
				'qty'            => $qty,
                                'subtotal_gross' => (float) wc_format_decimal( (float) $price_data['unit_gross'] * $qty, wc_get_price_decimals() ),
                          'total_gross'    => (float) wc_format_decimal( (float) $price_data['unit_gross'] * $effective_discount_factor * $qty, wc_get_price_decimals() ),
				'stock_before'   => $stock_before,
				'stock_after'    => $stock_after,
			);
			$left_to_apply -= $qty;
		}

		// Reduser gammel linje
		$new_qty = max( 0, $old_qty - $approved_total );
		if ( $new_qty === 0 ) $order->remove_item( $old_item->get_id() );
		else {
			$scale = $new_qty / max(1,$old_qty);
			$old_item->set_quantity( $new_qty );
			$old_item->set_subtotal(      (float) $old_item->get_subtotal()      * $scale );
			$old_item->set_total(         (float) $old_item->get_total()         * $scale );
			$old_item->set_subtotal_tax(  (float) $old_item->get_subtotal_tax()  * $scale );
			$old_item->set_total_tax(     (float) $old_item->get_total_tax()     * $scale );
			$old_item->set_taxes( lp_mpr_scale_tax_array( $old_line_taxes, max(1,$old_qty), $new_qty ) );
			$old_item->save();
		}

		// Lagerh√•ndtering for gammel vare
		if ( $old_pid && ! apply_filters( 'lp_mpr_skip_external_stock_manager', false, $old_pid ) ) {
			$old_product = wc_get_product( $old_vid ? $old_vid : $old_pid );
			if ( $old_product && $old_product->managing_stock() ) {
				if ( $old_stock_mode === 'force_zero' ) wc_update_product_stock( $old_product, 0, 'set' );
				else wc_update_product_stock( $old_product, $approved_total, 'decrease' );
			}
		}

		$changes[] = array(
			'order_item_id' => $order_item_id,
			'old' => array(
				'product_id'        => $old_pid,
				'variation_id'      => $old_vid,
				'name'              => $old_name,
				'qty_before'        => $old_qty,
				'qty_after'         => $new_qty,
				'stock_mode'        => $old_stock_mode,
			),
			'new_added'     => $applied_for_this_item,
		);
	}

        lp_mpr_recalculate_order( $order ); $order->save();

        $current_total = (float) wc_format_decimal( $order->get_total(), wc_get_price_decimals() );
        $paid_on_other_order = 0.0; $fee_reason = ''; $fee_order = null;
        if ( $fee_order_id ) {
                $fee_order = wc_get_order( $fee_order_id );
                if ( $fee_order ) {
                        $paid_on_other_order = (float) wc_format_decimal( $fee_order->get_total(), wc_get_price_decimals() );
                        $fee_reason = (string) $fee_order->get_meta( '_lp_mpr_fee_reason', true );
                        if ( '' === $fee_reason ) {
                                $fee_delta_map = (array) $fee_order->get_meta( '_lp_mpr_delta_breakdown', true );
                                $fee_reason    = lp_mpr_describe_delta_reasons( $order, $fee_delta_map );
                        }
                }
        }

        $intermediate    = (float) wc_format_decimal( max( 0, $current_total - $baseline_total ), wc_get_price_decimals() );
        $discount_amount = $intermediate;

        if ( $discount_amount > 0 ) {
                $discount_label = sprintf( __( 'Mellomlegg betalt p√• Ordre %s', 'lilleprinsen' ), $fee_order_id ? $fee_order_id : $order->get_order_number() );
                $discount_label_base = $discount_label;
                if ( $fee_reason ) {
                        $discount_label = sprintf( __( '%1$s ‚Äî %2$s', 'lilleprinsen' ), $discount_label, $fee_reason );
                }

                foreach ( $order->get_items( 'fee' ) as $fee_item ) {
                        $fee_name = $fee_item->get_name();
                        if ( $discount_label === $fee_name || ( isset( $discount_label_base ) && $discount_label_base === $fee_name ) ) {
                                $order->remove_item( $fee_item->get_id() );
                        }
                }

                $tax_lines = $order->get_taxes(); $tax_totals = array(); $tax_total_sum = 0.0;
                foreach ( $tax_lines as $tax_line ) {
                        $rate_id = (int) $tax_line->get_rate_id();
                        $amount  = (float) $tax_line->get_tax_total() + (float) $tax_line->get_shipping_tax_total();
                        if ( $rate_id && $amount !== 0.0 ) { $tax_totals[ $rate_id ] = $amount; $tax_total_sum += $amount; }
                }

                $discount = new WC_Order_Item_Fee();
                $discount->set_name( $discount_label );

                if ( $tax_total_sum > 0 ) {
                        $net_base = max( 0.0, (float) $order->get_total() - (float) $order->get_total_tax() );
                        $tax_ratio = $net_base > 0 ? (float) $order->get_total_tax() / $net_base : 0.0;
                        $discount_net  = $tax_ratio > 0 ? $discount_amount / ( 1 + $tax_ratio ) : $discount_amount;
                        $discount_tax  = max( 0.0, $discount_amount - $discount_net );

                        $discount->set_amount( -1 * $discount_net );
                        $discount->set_total(  -1 * $discount_net );

                        $alloc = array(); $left_tax = $discount_tax; $rate_ids = array_keys( $tax_totals );
                        foreach ( $rate_ids as $idx => $rid ) {
                                $share = $tax_total_sum > 0 ? (float) $tax_totals[ $rid ] / $tax_total_sum : 0.0;
                                $portion = ( $idx === array_key_last( $rate_ids ) ) ? $left_tax : wc_round_tax_total( $discount_tax * $share );
                                $alloc[ $rid ] = -1 * $portion;
                                $left_tax -= $portion;
                        }
                        $discount->set_taxes( array( 'total' => $alloc, 'subtotal' => $alloc ) );
                        $discount->set_tax_status( 'taxable' );
                } else {
                        $discount->set_amount( -1 * $discount_amount );
                        $discount->set_total(  -1 * $discount_amount );
                        $discount->set_tax_status( 'none' );
                }

                $order->add_item( $discount );

                lp_mpr_recalculate_order( $order );
                $order->save();

                $discount_applied = true;
        }

        if ( function_exists( 'wc_delete_shop_order_transients' ) ) wc_delete_shop_order_transients( $order->get_id() );

        $currency = $order->get_currency();
        if ( ! empty( $changes ) ) {
                $lines = array();
                foreach ( $changes as $c ) {
                        $old = $c['old'];
                        $id_label = '#' . $old['product_id'] . ( $old['variation_id'] ? '/' . $old['variation_id'] : '' );
                        $lines[] = sprintf( '‚Ä¢ %s (%s): %d ‚Üí %d ‚Äî %s', $old['name'], $id_label, $old['qty_before'], $old['qty_after'], $old['stock_mode'] );
                        foreach ( $c['new_added'] as $n ) {
                                $price_str = wp_strip_all_tags( wc_price( $n['total_gross'], array( 'currency' => $currency ) ) );
                                $stock_note = '';
                                if ( $n['stock_before'] !== null && $n['stock_after'] !== null ) {
                                        $stock_note = ' (' . sprintf( __( 'lager %d ‚Üí %d', 'lilleprinsen' ), $n['stock_before'], $n['stock_after'] ) . ')';
                                }
                                $lines[] = sprintf( '   ‚Ü≥ + %s (#%d) √ó %d ‚Äî %s%s', $n['name'], $n['product_id'], $n['qty'], $price_str, $stock_note );
                        }
                }
                if ( $discount_applied && $discount_amount > 0 ) {
                        $lines[] = sprintf( '   ‚Ü≥ %s ‚Äî %s', $discount_label, wp_strip_all_tags( wc_price( -1 * $discount_amount, array( 'currency' => $currency ) ) ) );
                }
                $policy = __( 'Politikk: cap per linje; bruk produktpris i ordre-kontekst; behold rabatter; frakt uendret.', 'lilleprinsen' );
                $order->add_order_note( "üßæ MPR: Erstatning brukt\n" . implode( "\n", $lines ) . "\n" . $policy, false );
        } else {
                $order->add_order_note( __( '‚ÑπÔ∏è MPR: Ingen endringer ble gjort.', 'lilleprinsen' ), false );
        }
        return array( 'changes' => $changes );
}

/** Tilleggsordre (avgiftsfri fee p√• brutto mellomlegg) */
function lp_mpr_create_extra_fee_order( WC_Order $parent, array $payload, float $amount_gross, array $delta_by_line ) : WC_Order {
	$args  = array( 'customer_id' => $parent->get_user_id() ? (int) $parent->get_user_id() : 0 );
	$child = wc_create_order( $args );
	$child->update_meta_data( '_lp_mpr_parent_order_id', $parent->get_id() );
	$child->update_meta_data( '_lp_mpr_hash',            lp_mpr_selection_hash( $payload ) );
	$child->update_meta_data( '_lp_mpr_delta_breakdown', $delta_by_line );
	$child->set_address( $parent->get_address( 'billing' ), 'billing' );
	$child->set_address( $parent->get_address( 'shipping' ), 'shipping' );

        $fee = new WC_Order_Item_Fee();
        $fee_label = __( 'Tilleggsbetaling for erstatningsvarer', 'lilleprinsen' );
        $fee_reason = lp_mpr_describe_delta_reasons( $parent, $delta_by_line );
        if ( $fee_reason ) {
                $fee_label = sprintf( __( '%1$s ‚Äî %2$s', 'lilleprinsen' ), $fee_label, $fee_reason );
                $fee->update_meta_data( '_lp_mpr_fee_reason', $fee_reason );
        }
        $fee->set_name( $fee_label );
        $fee->set_amount( $amount_gross );
        $fee->set_total(  $amount_gross );
        $fee->set_tax_status( 'none' );
	$child->add_item( $fee );

	$child->set_currency( $parent->get_currency() );
        lp_mpr_recalculate_order( $child );
	$child->update_status( 'pending', __( 'Ventende tilleggsbetaling (MPR).', 'lilleprinsen' ), true );
	$child->save();

	$parent->add_order_note( sprintf( __( 'MPR: Laget tilleggsordre #%s p√• %.2f.', 'lilleprinsen' ), $child->get_order_number(), $amount_gross ), false );
	return $child;
}

function lp_mpr_email_extra_fee_invoice( WC_Order $parent, WC_Order $child, float $amount_gross ) : void {
        $email = $parent->get_billing_email(); if ( ! $email ) return;
        $link  = $child->get_checkout_payment_url();
        $body  = '<p>' . esc_html__( 'Du har godkjent erstatningsvarer som koster litt mer enn originalen.', 'lilleprinsen' ) . '</p>';
        $body .= '<p>' . sprintf( esc_html__( 'Mellomlegget som gjenst√•r er %s. N√•r betalingen er fullf√∏rt oppdaterer vi ordren automatisk.', 'lilleprinsen' ), wp_kses_post( wc_price( $amount_gross, array( 'currency' => $parent->get_currency() ) ) ) ) . '</p>';
        $body .= '<p style="margin:18px 0 0;color:#475569;">' . esc_html__( 'Har du sp√∏rsm√•l? Svar gjerne p√• denne e-posten.', 'lilleprinsen' ) . '</p>';
        lp_mpr_send_branded_email(
                $email,
                __( 'Tilleggsbetaling for erstatningsvarer', 'lilleprinsen' ),
                __( 'Fullf√∏r betalingen for erstatningsvarene', 'lilleprinsen' ),
                $body,
                array( 'label' => __( 'Betal mellomlegget', 'lilleprinsen' ), 'url' => $link ),
                $parent,
                'kunde_godkjent_venter'
        );
}

add_action( 'woocommerce_order_status_processing', 'lp_mpr_on_fee_order_paid' );
add_action( 'woocommerce_order_status_completed',  'lp_mpr_on_fee_order_paid' );
add_action( 'woocommerce_payment_complete',        'lp_mpr_on_fee_order_paid' );
function lp_mpr_on_fee_order_paid( $fee_order_id ) {
        $fee = wc_get_order( $fee_order_id ); if ( ! $fee ) return;
        $parent_id = (int) $fee->get_meta( '_lp_mpr_parent_order_id', true ); if ( ! $parent_id ) return;
	$parent = wc_get_order( $parent_id ); if ( ! $parent ) return;

        $pending = (array) $parent->get_meta( '_lp_mpr_pending', true );
        if ( empty( $pending['hash'] ) || empty( $pending['payload'] ) ) { $parent->add_order_note( __( 'MPR: Ingen pending payload ved registrert betaling av tilleggsordre.', 'lilleprinsen' ), false ); return; }

        $hash_parent = (string) $pending['hash']; $hash_child  = (string) $fee->get_meta( '_lp_mpr_hash', true );
        if ( $hash_child && $hash_child !== $hash_parent ) { $parent->add_order_note( __( 'MPR: Hash-mismatch mellom tilleggsordre og payload ‚Äî hopper over.', 'lilleprinsen' ), false ); return; }

        $fee_order_id = $fee->get_id();

        try {
                $result = lp_mpr_apply_now( $parent, (array) $pending['payload'], array(
                        'old_stock_mode' => ( $pending['payload']['policy']['stock']['old'] ?? 'decrease' ),
                        'cap'            => true,
                        'cap_total_at'   => (float) wc_format_decimal( $parent->get_total(), wc_get_price_decimals() ),
                        'fee_order_id'   => $fee_order_id,
                ) );
		$applied_map = (array) $parent->get_meta( '_lp_mpr_applied', true );
		$applied_map[ $hash_parent ] = array( 'applied_at' => time(), 'v' => 2, 'by_fee' => $fee_order_id );
		$parent->update_meta_data( '_lp_mpr_applied', $applied_map );
		$parent->delete_meta_data( '_lp_mpr_pending' );
		$parent->delete_meta_data( '_lp_mpr_reservations' );

		if ( apply_filters( 'lp_mpr_delete_meta_on_success', true, $parent, $pending['payload'] ) ) $parent->delete_meta_data( '_lp_missing_replacements' );

                $parent->update_status( 'oppdatert', __( 'Erstatninger brukt etter mottatt tilleggsbetaling.', 'lilleprinsen' ), true );
                $parent->save();

                $fee->update_status( 'completed', __( 'Tilleggsbetaling registrert (MPR).', 'lilleprinsen' ), true ); $fee->save();

                lp_mpr_send_customer_confirmation( $parent, $result );
                lp_mpr_append_log_entry( $parent, __( 'Tilleggsbetaling mottatt og endringer brukt.', 'lilleprinsen' ), 'kunde_godkjent', 'system' );
        } catch ( Throwable $e ) {
                $parent->add_order_note( sprintf( __( 'MPR: Feil under bruk etter betaling: %s', 'lilleprinsen' ), $e->getMessage() ), false );
                throw $e;
        }
}

add_action( 'woocommerce_order_status_failed',    'lp_mpr_on_fee_order_not_paid' );
add_action( 'woocommerce_order_status_cancelled', 'lp_mpr_on_fee_order_not_paid' );
function lp_mpr_on_fee_order_not_paid( $fee_order_id ) {
        $fee = wc_get_order( $fee_order_id ); if ( ! $fee ) return;
        $parent_id = (int) $fee->get_meta( '_lp_mpr_parent_order_id', true ); if ( ! $parent_id ) return;
        $parent = wc_get_order( $parent_id ); if ( ! $parent ) return;

        $pending     = (array) $parent->get_meta( '_lp_mpr_pending', true );
        $hash_parent = (string) ( $pending['hash'] ?? '' );
        $hash_child  = (string) $fee->get_meta( '_lp_mpr_hash', true );
        if ( $hash_parent && $hash_child && $hash_parent !== $hash_child ) return; // annen endring gjort
        if ( empty( $pending ) ) return;

        $issue     = (array) $parent->get_meta( '_lp_mpr_issue', true );
        $issue_ver = (int) ( $issue['ver'] ?? 0 );

        lp_mpr_release_reservations( $parent->get_id(), $issue_ver );
        $issue['consumed'] = false;
        $parent->update_meta_data( '_lp_mpr_issue', $issue );
        $parent->save();

        $pay_url = $fee->get_checkout_payment_url();
        $portal  = apply_filters( 'lp_mpr_portal_url', '', $parent->get_id() );
        $body  = '<p>' . esc_html__( 'Vi fikk ikke godkjent betalingen for erstatningsvarene.', 'lilleprinsen' ) . '</p>';
        $body .= '<p>' . esc_html__( 'Vi har frigitt reservasjonen. Du kan pr√∏ve betalingen p√• nytt eller √•pne portalen for √• bekrefte p√• nytt.', 'lilleprinsen' ) . '</p>';
        lp_mpr_send_branded_email(
                $parent->get_billing_email(),
                __( 'Betalingen ble ikke godkjent', 'lilleprinsen' ),
                __( 'Betaling mislyktes ‚Äì vil du pr√∏ve igjen?', 'lilleprinsen' ),
                $body,
                array( 'label' => __( 'Pr√∏v betalingen p√• nytt', 'lilleprinsen' ), 'url' => $pay_url ?: $portal ),
                $parent,
                'betaling_feilet'
        );
        if ( $portal ) {
                lp_mpr_append_log_entry( $parent, __( 'Betaling mislyktes ‚Äì reservasjon slettet og kunde varslet.', 'lilleprinsen' ), 'betaling_feilet', 'system', array( 'portal' => $portal ) );
        }
}

/* ===== Unng√• dobbel lagerreduksjon ved reservasjon ‚Üí apply ===== */

$GLOBALS['lp_mpr_current_apply_order_id'] = 0;
add_action( 'lp_mpr_before_apply', function( WC_Order $order ){ $GLOBALS['lp_mpr_current_apply_order_id'] = (int) $order->get_id(); }, 1, 1 );
add_action( 'lp_mpr_after_apply',  function( WC_Order $order ){ $GLOBALS['lp_mpr_current_apply_order_id'] = 0; }, 99, 1 );

add_filter( 'lp_mpr_skip_external_stock_manager', function( $skip, $pid ){
	$order_id = (int) ( $GLOBALS['lp_mpr_current_apply_order_id'] ?? 0 ); if ( ! $order_id ) return $skip;
	$order = wc_get_order( $order_id ); if ( ! $order ) return $skip;
	$res = (array) $order->get_meta( '_lp_mpr_reservations', true ); if ( empty( $res['products'][ $pid ] ) ) return $skip;
	return true;
}, 10, 2 );

add_action( 'lp_mpr_after_apply', function( WC_Order $order, array $result ){
	$res = (array) $order->get_meta( '_lp_mpr_reservations', true ); if ( empty( $res['products'] ) ) return;
	$left = (array) $res['products']; $used = array();
	foreach ( (array) $result['changes'] as $change ) foreach ( (array) $change['new_added'] as $n ) { $pid=(int)$n['product_id']; $qty=max(0,(int)$n['qty']); if ($pid && $qty>0) $used[$pid]=($used[$pid]??0)+$qty; }
	if ( empty( $used ) ) return;
	foreach ( $used as $pid=>$qty ) { if ( empty( $left[$pid] ) ) continue; $left[$pid]=max(0,(int)$left[$pid]-(int)$qty); if ($left[$pid]===0) unset($left[$pid]); }
	if ( empty( $left ) ) {
		$order->delete_meta_data( '_lp_mpr_reservations' ); $order->save();
		if ( function_exists( 'as_unschedule_all_actions' ) ) { $issue=(array)$order->get_meta('_lp_mpr_issue',true); $ver=(int)($issue['ver']??0); as_unschedule_all_actions( LP_MPR_RELEASE_JOB_ACTION, array( $order->get_id(), $ver ), LP_MPR_JOB_GROUP ); }
	} else {
		$order->update_meta_data( '_lp_mpr_reservations', array(
			'products'   => $left,
			'issue_ver'  => $res['issue_ver'] ?? 0,
			'expires_at' => $res['expires_at'] ?? 0,
			'mode'       => 'decrease_hold',
		) ); $order->save();
	}
}, 10, 2 );

/* ===== Kunde-bekreftelse + status ===== */

if ( ! function_exists( 'lp_mpr_send_customer_confirmation' ) ) {
	function lp_mpr_send_customer_confirmation( WC_Order $order, array $result ) : void {
		$send = apply_filters( 'lp_mpr_send_customer_email', true, $order, $result ); if ( ! $send ) return;
		$email = $order->get_billing_email(); if ( ! $email ) return;
		$order_url = $order->get_view_order_url();
                $lines = array();
                if ( ! empty( $result['changes'] ) ) {
                        foreach ( $result['changes'] as $c ) {
                                $old = $c['old']; $lines[] = sprintf( "%s: %d ‚Üí %d", $old['name'], $old['qty_before'], $old['qty_after'] );
                                foreach ( $c['new_added'] as $n ) $lines[] = sprintf( "Erstattet med: %s √ó %d", $n['name'], $n['qty'] );
                        }
                }
                $subject = sprintf( __( 'Vi har oppdatert bestillingen din #%s hos Lilleprinsen', 'lilleprinsen' ), $order->get_order_number() );
                $html_lines = '';
                foreach ( $lines as $line ) {
                        $html_lines .= '<li>' . esc_html( $line ) . '</li>';
                }
                $body  = '<p>' . esc_html__( 'Takk for at du valgte erstatning! Vi har oppdatert bestillingen din.', 'lilleprinsen' ) . '</p>';
                if ( $html_lines ) {
                        $body .= '<ul style="padding-left:20px;line-height:1.5;">' . $html_lines . '</ul>';
                }
                $body .= '<p>' . esc_html__( 'Pris per enhet er uendret. Du kan se ordren din her:', 'lilleprinsen' ) . '</p>';
                $body .= '<p><a href="' . esc_url( $order_url ) . '" style="color:#0ea5e9;font-weight:700;text-decoration:none;">' . esc_html__( '√Öpne ordren', 'lilleprinsen' ) . '</a></p>';
                lp_mpr_send_branded_email( $email, $subject, __( 'Vi har oppdatert ordren din', 'lilleprinsen' ), $body, array( 'label' => __( 'Se oppdatert ordre', 'lilleprinsen' ), 'url' => $order_url ), $order, 'oppdatert' );
        }
}

add_action( 'init', function() {
	register_post_status( 'wc-oppdatert', array(
		'label'                     => _x( 'Oppdatert', 'Order status', 'lilleprinsen' ),
		'public'                    => true,
		'exclude_from_search'       => false,
		'show_in_admin_all_list'    => true,
		'show_in_admin_status_list' => true,
		'label_count'               => _n_noop( 'Oppdatert <span class="count">(%s)</span>', 'Oppdatert <span class="count">(%s)</span>', 'lilleprinsen' ),
	) );
});
add_filter( 'wc_order_statuses', function( $statuses ) {
        $new = array();
        foreach ( $statuses as $key => $label ) {
                $new[ $key ] = $label;
                if ( 'wc-completed' === $key ) $new['wc-oppdatert'] = _x( 'Oppdatert', 'Order status', 'lilleprinsen' );
        }
        if ( ! isset( $new['wc-oppdatert'] ) ) $new['wc-oppdatert'] = _x( 'Oppdatert', 'Order status', 'lilleprinsen' );
        return $new;
} );

function lp_mpr_consume_customer_summary( string $key, WC_Order $order ) : array {
        $key = trim( $key );
        if ( '' === $key ) return array();

        $stored = get_transient( 'lp_mpr_summary_' . $key );
        if ( empty( $stored['order_id'] ) || (int) $stored['order_id'] !== (int) $order->get_id() ) return array();

        delete_transient( 'lp_mpr_summary_' . $key );
        $data = (array) ( $stored['data'] ?? array() );
        $data['order_total_html'] = isset( $data['order_total_html'] ) ? wp_kses_post( $data['order_total_html'] ) : '';
        $data['added']   = isset( $data['added'] ) && is_array( $data['added'] ) ? $data['added'] : array();
        $data['removed'] = isset( $data['removed'] ) && is_array( $data['removed'] ) ? $data['removed'] : array();

        return $data;
}
/* ==========================================================
 *           STANDALONE PORTAL-RENDER (kun ved rute)
 * ========================================================== */

add_action( 'template_redirect', function(){
  if ( ! lp_mpr_is_portal_request() ) return;

  $order_id  = absint( get_query_var( 'lp_mpr_order_id' ) );
  $order_key = (string) get_query_var( 'lp_mpr_key' );
  if ( ! $order_id || ! $order_key ) return;

  $order = wc_get_order( $order_id ); if ( ! $order ) return;

        // Sikkerhetskontekst (lenke med order-key skal alltid fungere)
        $valid_key = $order_key && hash_equals( (string) $order->get_order_key(), (string) $order_key );
        $ok = $valid_key;
        if ( ! $ok && is_user_logged_in() ) {
                $ok = ( (int) $order->get_user_id() === (int) get_current_user_id() ) || current_user_can( 'edit_shop_order', $order_id );
        }
        if ( ! $ok ) { status_header( 403 ); echo esc_html__( 'Du har ikke tilgang til denne siden.', 'lilleprinsen' ); exit; }

  // Ikke cache
  nocache_headers();
  status_header( 200 );
  global $wp_query;
  if ( $wp_query ) {
    $wp_query->is_404 = false;
    $wp_query->is_singular = false;
    $wp_query->is_page = false;
    $wp_query->is_home = false;
  }

	$data  = (array) $order->get_meta( '_lp_missing_replacements', true );
	$issue = (array) $order->get_meta( '_lp_mpr_issue', true );
	$ver   = (int) ( $issue['ver'] ?? 0 );

	// Regn informasjonsoppsummering (hvem dekker?)
	$cnt_customer_pays = 0; $cnt_store_covers = 0;
	foreach ( $data as $row ) {
		if ( empty( $row['enabled'] ) || empty( $row['suggestions'] ) ) continue;
		foreach ( (array) $row['suggestions'] as $s ) {
			$m = (string) ( $s['mode'] ?? 'customer_pays' );
			if ( $m === 'store_covers' ) $cnt_store_covers++; else $cnt_customer_pays++;
		}
	}
$customer_name = trim( $order->get_billing_first_name() . ' ' . $order->get_billing_last_name() );
if ( ! $customer_name ) $customer_name = (string) $order->get_billing_company();
if ( ! $customer_name ) $customer_name = (string) $order->get_formatted_billing_full_name();
if ( ! $customer_name ) $customer_name = __( 'venn', 'lilleprinsen' );
$discount_ctx = (array) $order->get_meta( '_lp_mpr_discount_context', true );
if ( empty( $discount_ctx ) ) $discount_ctx = lp_mpr_get_discount_context( $order );
$summary_key   = isset( $_GET['lp_mpr_summary'] ) ? sanitize_text_field( wp_unslash( $_GET['lp_mpr_summary'] ) ) : '';
$summary_data  = $summary_key ? lp_mpr_consume_customer_summary( $summary_key, $order ) : array();

?><!doctype html>
<html <?php language_attributes(); ?>>
        <head>
	<meta charset="<?php bloginfo( 'charset' ); ?>">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<title><?php echo esc_html__( 'Erstatninger for manglende varer', 'lilleprinsen' ); ?></title>
<style>
:root{--ink:#0f172a;--muted:#475569;--bg:#f8fafc;--card:#ffffff;--br:#e2e8f0;--accent:#0f172a;--pill:#f1f5f9;}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);}
.container{max-width:720px;margin:0 auto;padding:18px;}
.hero{display:flex;gap:12px;align-items:center;background:#ffffff;color:var(--ink);border-radius:14px;padding:14px 16px;box-shadow:0 8px 20px rgba(15,23,42,.06);border:1px solid var(--br);margin-bottom:12px}
.hero .emoji{font-size:26px}
.hero .title{margin:0;font-size:18px;font-weight:700}
.hero .subtitle{margin:6px 0 0;font-size:13px;color:var(--muted)}
.pills{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 10px 0}
.pill{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;background:var(--pill);border:1px solid var(--br);color:#0f172a;border-radius:12px;font-size:13px;font-weight:600}
.pill .emoji{font-size:14px}
.card{background:var(--card);border:1px solid var(--br);border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 1px 4px rgba(15,23,42,.06)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.tag{font-size:12px;color:var(--muted)}
.badge{font-size:12px;background:#eef2ff;color:#3730a3;padding:4px 10px;border-radius:10px;white-space:nowrap;display:inline-flex;align-items:center;gap:6px}
.chip{font-size:11px;background:#ecfeff;color:#0e7490;border:1px solid #a5f3fc;padding:2px 8px;border-radius:999px;margin-left:6px;white-space:nowrap}
.choice{display:flex;gap:10px;align-items:center;padding:10px;border:1px solid var(--br);border-radius:10px;margin:8px 0;background:#f8fafc}
.choice img{flex:0 0 auto}
.choice a,.product-link{color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:6px}
.choice a:focus,.choice a:hover,.product-link:focus,.product-link:hover{color:var(--accent);text-decoration:underline}
.screen-reader-text{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
button{appearance:none;background:var(--accent);border:0;color:#fff;border-radius:10px;padding:12px 14px;font-weight:700;box-shadow:0 1px 3px rgba(15,23,42,.22)}
button.secondary{background:#fff;color:var(--ink);border:1px solid var(--br);box-shadow:none}
button.choice-picked{box-shadow:0 0 0 2px #1d4ed8,0 1px 3px rgba(15,23,42,.22);outline:none;transform:translateY(-1px)}
button.secondary.choice-picked{background:#eef2ff;color:#1d4ed8;border-color:#1d4ed8}
.decision-status{border:1px dashed var(--br);padding:10px;border-radius:12px;font-size:12px;color:var(--muted);background:#f8fafc;margin-top:6px}
.decision-status.accept{border-color:#22c55e66;background:#ecfdf3;color:#166534}
.decision-status.decline{border-color:#ef444466;background:#fef2f2;color:#b91c1c}
.footer-note{color:var(--muted);font-size:13px;margin-top:12px;text-align:center}
hr{border:0;border-top:1px solid var(--br);margin:10px 0}
.small{font-size:12px;color:var(--muted)}
.chat-card textarea{width:100%;border:1px solid var(--br);border-radius:10px;padding:10px;font-family:inherit;font-size:14px;min-height:90px;margin:6px 0}
.muted-note{color:var(--muted);font-size:12px;margin:4px 0 0}
.pay-note{color:var(--muted);font-size:12px;margin:4px 0 0}
.refund-note{margin-top:4px;line-height:1.4}
.li{list-style:none;padding:0;margin:0}
.qty{font-variant-numeric:tabular-nums;color:var(--muted)}
.price-line{margin-top:4px;color:var(--muted)}
.old{display:flex;gap:10px;align-items:center;flex:1;min-width:0}
.status{display:none;margin:10px 0;padding:12px 14px;border-radius:12px;border:1px solid var(--br);background:#f8fafc;font-size:13px;line-height:1.5}
.status.show{display:block}
.status.success{border-color:#22c55e29;background:#ecfdf3;color:#166534}
.status.error{border-color:#ef444429;background:#fef2f2;color:#b91c1c}
.loading-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:50}
.loading-backdrop.visible{display:flex}
.loading-box{background:#0f172a;color:#fff;padding:16px 18px;border-radius:12px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.spinner{width:24px;height:24px;border-radius:50%;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;animation:lp-spin 1s linear infinite}
.summary-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
.summary-label{font-weight:700;font-size:13px}
.summary-title{margin:8px 0 4px;font-weight:700}
.summary-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px}
.summary-line{display:flex;justify-content:space-between;gap:10px;font-size:13px;color:var(--ink);flex-wrap:wrap;align-items:flex-start}
.summary-price{margin-left:auto}
.summary-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;z-index:60;padding:16px}
.summary-backdrop.visible{display:flex}
.summary-modal{background:#fff;max-width:520px;width:100%;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:18px;max-height:85vh;overflow:auto}
.summary-modal h3{margin:0 0 6px;font-size:18px}
.summary-modal .small{margin:0 0 12px}
.summary-section{margin:12px 0 0}
.summary-section .summary-title{margin-top:0}
.summary-empty{color:var(--muted);font-size:13px;margin:4px 0 0}
.summary-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
.summary-meta{display:block;font-size:12px;color:var(--muted);margin-top:2px}
.summary-total{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--br);border-radius:10px;background:#f8fafc;margin:8px 0 12px}
.summary-total .badge{margin-left:auto}
.summary-total.negative .badge{background:#ecfdf3;color:#166534;border-color:#22c55e33}
.summary-total.positive .badge{background:#fef2f2;color:#b91c1c;border-color:#ef444433}
.final-card{border:1px solid var(--br);background:#f8fafc}
.lp-step-label{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;color:var(--muted);font-size:12px}
.lp-step-card{position:relative;margin-bottom:8px}
.lp-step-card.completed-step{border-style:dashed;opacity:.97}
.lp-step-card.future-step{opacity:1;display:block}
.lp-step-nav{display:none}
.note-line{color:var(--muted);font-size:13px;margin:4px 0 0}
@keyframes lp-spin{to{transform:rotate(360deg)}}
@media (max-width:480px){ .badge{margin-top:4px; width:100%; justify-content:center;} }
</style>
        </head>
        <body>
<div class="container" id="lp-mpr-standalone"
         data-ajax="<?php echo esc_attr( admin_url( 'admin-ajax.php' ) ); ?>"
         data-order-id="<?php echo esc_attr( $order_id ); ?>"
         data-order-key="<?php echo esc_attr( $order_key ); ?>"
         data-nonce="<?php echo esc_attr( wp_create_nonce( 'lp_mpr_portal_action' ) ); ?>"
         data-currency="<?php echo esc_attr( $order->get_currency() ); ?>"
         data-issue-ver="<?php echo esc_attr( $ver ); ?>">
<div class="loading-backdrop" id="lp-mpr-loading" role="status" aria-live="polite" aria-label="<?php echo esc_attr__( 'Behandler valgene dine ‚Ä¶', 'lilleprinsen' ); ?>">
        <div class="loading-box">
                <div class="spinner" aria-hidden="true"></div>
                <div class="loading-text"><?php echo esc_html__( 'Behandler valgene dine ‚Ä¶', 'lilleprinsen' ); ?></div>
        </div>
</div>
<div class="hero">
<div class="emoji">ü§ó</div>
<div>
<p class="title"><?php echo sprintf( esc_html__( 'Hei %s!', 'lilleprinsen' ), esc_html( $customer_name ) ); ?></p>
<p class="subtitle"><?php echo esc_html__( 'Den opprinnelige varen er utsolgt. Velg erstatninger √©n og √©n ‚Äì resten fikser vi for deg. ‚ú®', 'lilleprinsen' ); ?></p>
</div>
</div>

<div class="pills">
<span class="pill"><span class="emoji">üì¶</span><span><?php echo esc_html__( 'Originalvaren er utsolgt, men vi har forslag klare til deg.', 'lilleprinsen' ); ?></span></span>
<span class="pill"><span class="emoji">üí∏</span><span><?php echo esc_html__( 'Velger du en rimeligere erstatning, f√∏rer vi mellomlegget tilbake til deg.', 'lilleprinsen' ); ?></span></span>
<?php if ( $cnt_customer_pays && $cnt_store_covers ) : ?>
<span class="pill"><span class="emoji">üí≥</span><span><?php echo esc_html__( 'Noen alternativer kan gi et lite mellomlegg.', 'lilleprinsen' ); ?></span></span>
<?php elseif ( $cnt_customer_pays ) : ?>
<span class="pill"><span class="emoji">üí≥</span><span><?php echo esc_html__( 'Mellomlegg betales kun om du velger dyrere vare.', 'lilleprinsen' ); ?></span></span>
<?php else : ?>
<span class="pill"><span class="emoji">‚úÖ</span><span><?php echo esc_html__( 'Ingen av forslagene koster deg ekstra.', 'lilleprinsen' ); ?></span></span>
<?php endif; ?>
<span class="pill"><span class="emoji">üßæ</span><span><?php echo esc_html__( 'Velg √©n eller flere forslag, maks likt antallet som mangler.', 'lilleprinsen' ); ?></span></span>
</div>

<?php if ( $cnt_customer_pays ) : ?>
<p class="note-line"><?php echo esc_html__( 'Velger du en dyrere erstatning, dekker du mellomlegget. Vi ber deg bekrefte f√∏r vi endrer ordren.', 'lilleprinsen' ); ?></p>
<?php endif; ?>
<p class="note-line"><?php echo esc_html__( 'Totalsummen p√• den opprinnelige bestillingen √∏ker ikke ‚Äì eventuelle mellomlegg blir fakturert i en egen ordre.', 'lilleprinsen' ); ?></p>
<p class="note-line"><?php echo esc_html__( 'Valgene dine blir lagret f√∏rst n√•r du godkjenner p√• siste steg.', 'lilleprinsen' ); ?></p>

<div id="lp-mpr-status" class="status" aria-live="polite"></div>

<?php
if ( isset( $_GET['lp_mpr_done'] ) ) {
echo '<div class="card">';
echo '<p><strong>' . esc_html__( 'Takk! Vi har oppdatert ordren din.', 'lilleprinsen' ) . '</strong></p><p class="small">' . esc_html__( 'Du kan lukke siden eller f√∏lge med p√• e-post for bekreftelse.', 'lilleprinsen' ) . '</p>';
if ( ! empty( $summary_data ) ) {
        echo '<hr />';
        $before_html = isset( $summary_data['order_total_before_html'] ) ? (string) $summary_data['order_total_before_html'] : '';
        $after_html  = isset( $summary_data['order_total_after_html'] )  ? (string) $summary_data['order_total_after_html']  : '';
        $delta_html  = isset( $summary_data['order_total_delta_html'] )  ? (string) $summary_data['order_total_delta_html']  : '';
        $delta_val   = isset( $summary_data['order_total_delta'] ) ? (float) $summary_data['order_total_delta'] : 0.0;
        $payer       = isset( $summary_data['delta_payer'] ) ? (string) $summary_data['delta_payer'] : '';

        if ( $before_html || $after_html ) {
                if ( $before_html ) {
                        echo '<div class="summary-header"><span class="summary-label">' . esc_html__( 'Tidligere totalsum', 'lilleprinsen' ) . '</span><span class="badge summary-price">' . wp_kses_post( $before_html ) . '</span></div>';
                }
                if ( $after_html ) {
                        echo '<div class="summary-header"><span class="summary-label">' . esc_html__( 'Ny totalsum', 'lilleprinsen' ) . '</span><span class="badge summary-price">' . wp_kses_post( $after_html ) . '</span></div>';
                }
                if ( $delta_val !== 0.0 && $delta_html ) {
                        if ( $delta_val > 0 ) {
                                $payer_text = $payer === 'customer' ? esc_html__( 'Du betaler mellomlegget.', 'lilleprinsen' ) : esc_html__( 'Butikken dekker mellomlegget.', 'lilleprinsen' );
                                echo '<p class="small note-line">' . sprintf( esc_html__( 'Pris √∏kte med %1$s. %2$s', 'lilleprinsen' ), wp_kses_post( $delta_html ), esc_html( $payer_text ) ) . '</p>';
                        } else {
                                echo '<p class="small note-line">' . sprintf( esc_html__( 'Pris redusert med %s. Vi tilbakef√∏rer mellomlegget til deg.', 'lilleprinsen' ), wp_kses_post( $delta_html ) ) . '</p>';
                        }
                }
        } elseif ( ! empty( $summary_data['order_total_html'] ) ) {
                echo '<div class="summary-header"><span class="summary-label">' . esc_html__( 'Ny totalsum', 'lilleprinsen' ) . '</span><span class="badge summary-price">' . wp_kses_post( $summary_data['order_total_html'] ) . '</span></div>';
        }
        if ( ! empty( $summary_data['added'] ) ) {
                echo '<p class="small summary-title">' . esc_html__( 'Lagt til', 'lilleprinsen' ) . '</p><ul class="summary-list">';
                foreach ( $summary_data['added'] as $added ) {
                        $name = isset( $added['name'] ) ? (string) $added['name'] : '';
                        $qty  = isset( $added['qty'] ) ? (int) $added['qty'] : 0;
                        $price = isset( $added['price_html'] ) ? (string) $added['price_html'] : '';
                        echo '<li class="summary-line"><span>' . esc_html( $name ) . ' √ó ' . esc_html( $qty ) . '</span>' . ( $price ? '<span class="badge summary-price">' . wp_kses_post( $price ) . '</span>' : '' ) . '</li>';
                }
                echo '</ul>';
        }
        if ( ! empty( $summary_data['removed'] ) ) {
                echo '<p class="small summary-title">' . esc_html__( 'Fjernet', 'lilleprinsen' ) . '</p><ul class="summary-list">';
                foreach ( $summary_data['removed'] as $removed ) {
                        $name = isset( $removed['name'] ) ? (string) $removed['name'] : '';
                        $qty  = isset( $removed['qty'] ) ? (int) $removed['qty'] : 0;
                        echo '<li class="summary-line"><span>' . esc_html( $name ) . '</span><span class="badge summary-price">‚àí ' . esc_html( $qty ) . '</span></li>';
                }
                echo '</ul>';
        }
}
echo '</div>';
}

if ( empty( $data ) ) {
echo '<div class="card"><p>' . esc_html__( 'Ingen erstatninger foresl√•tt akkurat n√•.', 'lilleprinsen' ) . '</p></div>';
}

		foreach ( $order->get_items( 'line_item' ) as $item_id => $item ) {
			$key = (string) $item_id;
			if ( empty( $data[ $key ]['enabled'] ) ) continue;

                        $ordered     = (int) $item->get_quantity();
                        $missing_qty = max( 0, (int) ( $data[ $key ]['qty'] ?? 0 ) );
                        $sugs        = ! empty( $data[ $key ]['suggestions'] ) ? (array) $data[ $key ]['suggestions'] : array();
                        $unit        = lp_mpr_get_line_unit_prices( $order, $item );

			// Gammelt produktbilde
			$old_prod = null;
			$old_vid  = $item->get_variation_id();
			$old_pid  = $item->get_product_id();
			if ( $old_vid ) $old_prod = wc_get_product( $old_vid );
			if ( ! $old_prod && $old_pid ) $old_prod = wc_get_product( $old_pid );

                        echo '<div class="card lp-portal-item" data-item-id="' . esc_attr( $item_id ) . '" data-missing="' . esc_attr( $missing_qty ) . '" data-decision="">';
			echo '<div class="row old">';
                        echo wp_kses_post( lp_mpr_thumb_html( $old_prod, 'lp-thumb', $item->get_name() ) );
			echo '<div style="flex:1"><div><strong>' . esc_html( $item->get_name() ) . '</strong></div><div class="tag">' . esc_html__( 'Opprinnelig vare', 'lilleprinsen' ) . '</div></div>';
                        echo '<div class="qty small">' . esc_html__( 'Bestilt', 'lilleprinsen' ) . ': ' . esc_html( $ordered ) . '</div>';
                        echo '<div class="qty small">' . esc_html__( 'Mangler', 'lilleprinsen' ) . ': ' . esc_html( $missing_qty ) . '</div>';
                        $orig_price_html = wc_price( (float) $unit['unit_gross_total'], array( 'currency' => $order->get_currency() ) );
                        echo '<div class="small price-line">' . sprintf( esc_html__( 'Opprinnelig pris per stk.: %s', 'lilleprinsen' ), wp_kses_post( $orig_price_html ) ) . '</div>';
			echo '</div>';

			echo '<hr />';
			if ( ! empty( $sugs ) ) {
				echo '<ul class="li">';
                                foreach ( array_values( $sugs ) as $idx => $s ) {
                                        $pid = absint( $s['product_id'] ?? 0 );
                                        $sq  = max( 0, (int) ( $s['qty'] ?? 0 ) );
                                        $mode = in_array( (string) ( $s['mode'] ?? '' ), array( 'customer_pays', 'store_covers' ), true ) ? (string) $s['mode'] : 'customer_pays';
                                        if ( ! $pid || $sq <= 0 ) continue;

                                        $p     = wc_get_product( $pid );
                                        $label = $p ? wp_strip_all_tags( $p->get_formatted_name() ) : '#' . $pid;
                                        $link  = ( $p && $p->is_visible() ) ? get_permalink( $p->get_id() ) : '';

                                        $coupon_factor = $p ? lp_mpr_get_coupon_factor_for_product( $p, $order ) : array( 'factor' => 1.0, 'applies' => false );
                                        $price_data    = $p ? lp_mpr_get_product_unit_breakdown_for_order( $p, $order ) : array( 'unit_gross' => 0 );
                                        $unit_price_html = $p ? wc_price( (float) ( $price_data['unit_gross'] ?? 0 ), array( 'currency' => $order->get_currency() ) ) : '';
                                        $discounted_price_html = '';
                                        if ( $p && (float) $coupon_factor['factor'] < 1.0 ) {
                                                $discounted_price = (float) ( $price_data['unit_gross'] ?? 0 ) * (float) $coupon_factor['factor'];
                                                $discounted_price_html = wc_price( $discounted_price, array( 'currency' => $order->get_currency() ) );
                                        }

                                        $coupon_applied = (bool) ( $coupon_factor['applies'] ?? false );
                                        $delta = $p ? lp_mpr_calc_delta_gross( (float) $unit['unit_gross_total'], $p, $sq, $order, $coupon_applied ) : 0.0;
                                        $delta = lp_mpr_apply_discount_to_delta( $delta, $discount_ctx, $coupon_applied );
                                        $sign  = $delta > 0 ? '+ ' : ( $delta < 0 ? '‚àí ' : '' );
                                        $delta_html = $sign . wc_price( abs( $delta ), array( 'currency' => $order->get_currency() ) );
                                        $delta_plain = $sign . wp_strip_all_tags( wc_price( abs( $delta ), array( 'currency' => $order->get_currency() ) ) );
                                        $chip = $mode === 'store_covers' ? esc_html__( 'Butikken dekker', 'lilleprinsen' ) : esc_html__( 'Kunde betaler', 'lilleprinsen' );
                                        $mode_label = $mode === 'store_covers' ? esc_html__( 'Butikken dekker mellomlegget', 'lilleprinsen' ) : esc_html__( 'Kunde betaler mellomlegget', 'lilleprinsen' );
                                        $credit_note = $delta < 0 ? '<div class="small refund-note">' . esc_html__( 'Denne er billigere ‚Äì vi ordner mellomlegget tilbake til deg.', 'lilleprinsen' ) . '</div>' : '';
                                        $paying_note = ( $mode === 'customer_pays' && $delta > 0 ) ? '<div class="pay-note">' . esc_html__( 'Velger du denne, betaler du mellomlegget for prisforskjellen.', 'lilleprinsen' ) . '</div>' : '';
                                        $chip_html = $delta > 0 ? '<span class="chip">' . esc_html( $chip ) . '</span>' : '';

                                        echo '<li class="choice" data-delta="' . esc_attr( $delta ) . '" data-delta-display="' . esc_attr( $delta_plain ) . '" data-payer="' . esc_attr( $mode ) . '" data-payer-label="' . esc_attr( $mode_label ) . '">';
                                        echo '<input class="lp-choice" type="checkbox" value="' . esc_attr( $idx ) . '" data-qty="' . esc_attr( $sq ) . '"> ';
                                        echo wp_kses_post( lp_mpr_thumb_html( $p, 'lp-thumb', $label ) );
                                        echo '<div style="flex:1;min-width:0">';
                                        if ( $link ) {
                                                $aria_label = sprintf( __( '√Öpne %s i ny fane', 'lilleprinsen' ), $label );
                                                echo '<a class="product-link" href="' . esc_url( $link ) . '" target="_blank" rel="noreferrer noopener" aria-label="' . esc_attr( $aria_label ) . '"><strong>' . esc_html( $label ) . '</strong></a>';
                                        } else {
                                                echo '<strong>' . esc_html( $label ) . '</strong>';
                                        }
                                        echo '<div class="small">' . esc_html__( 'Antall', 'lilleprinsen' ) . ': ' . esc_html( $sq ) . '</div>';
                                        if ( $unit_price_html ) {
                                                echo '<div class="small price-line">' . sprintf( esc_html__( 'Ny pris per stk.: %s', 'lilleprinsen' ), wp_kses_post( $unit_price_html ) ) . '</div>';
                                        }
                                        if ( $discounted_price_html ) {
                                                echo '<div class="small price-line">' . sprintf( esc_html__( 'Pris med rabatt: %s', 'lilleprinsen' ), wp_kses_post( $discounted_price_html ) ) . '</div>';
                                        }
                                        echo $credit_note . $paying_note;
                                        echo '</div>';
                                        echo '<div><span class="badge" title="' . esc_attr__( 'Prisforskjell', 'lilleprinsen' ) . '">' . wp_kses_post( $delta_html ) . '</span>' . $chip_html . '</div>';
                                        echo '</li>';
				}
				echo '</ul>';
			} else {
				echo '<p class="small">' . esc_html__( 'Ingen alternativer oppf√∏rt for denne linjen. Du kan velge √• slette det manglende antallet.', 'lilleprinsen' ) . '</p>';
			}

                        echo '<div class="decision-status" aria-live="polite">' . esc_html__( 'Velg erstatning eller marker at vi skal slette den manglende varen for √• g√• videre.', 'lilleprinsen' ) . '</div>';

                        echo '<div class="actions">';
                        echo '<button type="button" class="primary" data-action="mark_accept">' . esc_html__( 'Lagre valget mitt for denne varen', 'lilleprinsen' ) . '</button>';
                        echo '<button type="button" class="secondary" data-action="delete_missing">' . esc_html__( 'Jeg vil slette denne varen i stedet', 'lilleprinsen' ) . '</button>';
                        echo '</div>';

			echo '</div>'; // card
		}
		?>

                <div class="card final-card">
                        <h3><?php echo esc_html__( 'Klar til √• bekrefte?', 'lilleprinsen' ); ?></h3>
                        <p class="small"><?php echo esc_html__( 'Se over valgene dine og bekreft alle endringer samlet til slutt.', 'lilleprinsen' ); ?></p>
                        <div class="actions">
                                <button type="button" class="primary" data-action="open_summary"><?php echo esc_html__( 'Bekreft alle endringer', 'lilleprinsen' ); ?></button>
                        </div>
                        <p class="muted-note"><?php echo esc_html__( 'Du f√•r en tydelig oversikt f√∏r vi oppdaterer ordren.', 'lilleprinsen' ); ?></p>
                </div>

                <p class="footer-note"><?php echo esc_html__( 'Vi venter med √• oppdatere ordren til du har bekreftet hele oversikten.', 'lilleprinsen' ); ?></p>

                <div class="card chat-card">
                        <h3><?php echo esc_html__( 'Passer ikke forslagene?', 'lilleprinsen' ); ?></h3>
                        <p class="small"><?php echo esc_html__( 'Send oss en melding, s√• ser kundeservice p√• ordren din.', 'lilleprinsen' ); ?></p>
                        <textarea id="lp-chat-message" placeholder="<?php echo esc_attr__( 'Fortell oss hva du √∏nsker ‚Ä¶', 'lilleprinsen' ); ?>"></textarea>
                        <div class="actions">
                                <button type="button" class="secondary" data-action="send_chat"><?php echo esc_html__( 'Send melding til kundeservice', 'lilleprinsen' ); ?></button>
                        </div>
                        <p class="muted-note"><?php echo esc_html__( 'Vi svarer p√• e-post og legger ved hele chatten.', 'lilleprinsen' ); ?></p>
                </div>

                <div class="summary-backdrop" id="lp-summary-modal" aria-hidden="true" role="presentation">
                        <div class="summary-modal" role="dialog" aria-modal="true" aria-labelledby="lp-summary-title">
                                <h3 id="lp-summary-title"><?php echo esc_html__( 'Se over endringene dine', 'lilleprinsen' ); ?></h3>
                                <p class="small"><?php echo esc_html__( 'Vi oppdaterer f√∏rst etter at du har bekreftet denne oversikten.', 'lilleprinsen' ); ?></p>
                                <div id="lp-summary-replacements" class="summary-section"></div>
                                <div id="lp-summary-deletions" class="summary-section"></div>
                                <div class="summary-actions">
                                        <button type="button" class="secondary" data-action="close_summary"><?php echo esc_html__( 'Tilbake', 'lilleprinsen' ); ?></button>
                                        <button type="button" class="primary" data-action="confirm_changes"><?php echo esc_html__( 'Bekreft og oppdater', 'lilleprinsen' ); ?></button>
                                </div>
                        </div>
                </div>
        </div>

        <script>
        (function(){
                var host = document.getElementById('lp-mpr-standalone'); if(!host) return;
                var ajax=host.getAttribute('data-ajax'), orderId=parseInt(host.getAttribute('data-order-id')||'0',10)||0, orderKey=host.getAttribute('data-order-key')||'', nonce=host.getAttribute('data-nonce')||'', issueVer=parseInt(host.getAttribute('data-issue-ver')||'0',10)||0, currency=host.getAttribute('data-currency')||'';
                var cooldown=2500, lastClick=0, redirecting=false;
                var loadingEl=document.getElementById('lp-mpr-loading');
                var statusEl=document.getElementById('lp-mpr-status');
                var summaryModal=document.getElementById('lp-summary-modal');
                var summaryReplacements=document.getElementById('lp-summary-replacements');
                var summaryDeletions=document.getElementById('lp-summary-deletions');
                var stepCards=[], activeStep=0;

                function setLoading(active, text){
                        if(!loadingEl) return;
                        var t = loadingEl.querySelector('.loading-text');
                        if(t && text){ t.textContent=text; }
                        loadingEl.classList.toggle('visible', !!active);
                }

                function ensureThumbLoaded(img){
                        if(!img || img.dataset.loaded) return;
                        var actual=img.getAttribute('data-src')||'';
                        var fallback=img.getAttribute('data-fallback')||'';
                        img.dataset.loaded='1';
                        if(!actual){ if(fallback && img.src!==fallback){ img.src=fallback; } return; }
                        var loader=new Image();
                        loader.onload=function(){ img.src=actual; };
                        loader.onerror=function(){ if(fallback){ img.src=fallback; } };
                        loader.src=actual;
                }
                function primeThumbs(){ host.querySelectorAll('img.lp-thumb').forEach(ensureThumbLoaded); }
                function formatMoney(amount){
                        var opts={minimumFractionDigits:2, maximumFractionDigits:2};
                        if(currency){
                                try { return new Intl.NumberFormat(undefined, Object.assign({style:'currency', currency:currency}, opts)).format(amount); }
                                catch(e){}
                        }
                        return amount.toLocaleString(undefined, opts);
                }

                function showStatus(message, tone){
                        if(!statusEl) return;
                        statusEl.innerHTML = message;
                        statusEl.className = 'status show' + (tone ? ' ' + tone : '');
                }

                function toggleSummary(show){
                        if(!summaryModal) return;
                        summaryModal.classList.toggle('visible', !!show);
                        summaryModal.setAttribute('aria-hidden', show ? 'false' : 'true');
                }

                function clearEl(el){ while(el && el.firstChild){ el.removeChild(el.firstChild); } }

                function selectionDecision(card){ return (card && card.getAttribute('data-decision')) || ''; }
                function updateActionButtons(card, state){
                        if(!card) return;
                        var acceptBtn = card.querySelector('button[data-action="mark_accept"]');
                        var deleteBtn = card.querySelector('button[data-action="delete_missing"]');
                        [acceptBtn, deleteBtn].forEach(function(btn){ if(btn){ btn.classList.remove('choice-picked'); } });
                        if(state==='accept' && acceptBtn){ acceptBtn.classList.add('choice-picked'); }
                        if(state==='decline' && deleteBtn){ deleteBtn.classList.add('choice-picked'); }
                }
                function updateDecisionBadge(card, state){
                        if(!card) return;
                        card.setAttribute('data-decision', state||'');
                        var badge = card.querySelector('.decision-status');
                        if(!badge) return;
                        badge.className='decision-status';
                        if(state==='accept'){
                                badge.classList.add('accept');
                                badge.textContent='<?php echo esc_js( __( 'Vi erstatter denne varen med valgte alternativer n√•r du bekrefter til slutt.', 'lilleprinsen' ) ); ?>';
                        } else if(state==='decline') {
                                badge.classList.add('decline');
                                badge.textContent='<?php echo esc_js( __( 'Denne varen blir slettet n√•r du fullf√∏rer p√• siste steg.', 'lilleprinsen' ) ); ?>';
                        } else {
                                badge.textContent='<?php echo esc_js( __( 'Velg erstatning eller marker sletting f√∏r du g√•r videre.', 'lilleprinsen' ) ); ?>';
                        }
                        updateActionButtons(card, state);
                }
                function selections(){
                        var out = {};
                        host.querySelectorAll('.lp-portal-item').forEach(function(card){
                                if(selectionDecision(card)==='decline') return;
                                var id = card.getAttribute('data-item-id'), picked=[];
                                card.querySelectorAll('.lp-choice:checked').forEach(function(c){ picked.push(parseInt(c.value,10)); });
                                if(picked.length){ out[id]=picked; updateDecisionBadge(card,'accept'); }
                        });
                        return out;
                }
                function declines(){
                        var out = [];
                        host.querySelectorAll('.lp-portal-item[data-decision="decline"]').forEach(function(card){
                                var id = parseInt(card.getAttribute('data-item-id')||'0',10)||0;
                                if(id) out.push(id);
                        });
                        return out;
                }
          function overChosen(card){
                  var allowed = parseInt(card.getAttribute('data-missing')||'0',10)||0, chosen=0;
                  if(selectionDecision(card)==='decline') return false;
                  card.querySelectorAll('.lp-choice:checked').forEach(function(c){ chosen += parseInt(c.getAttribute('data-qty')||'0',10)||0; });
                  return allowed>0 && chosen>allowed;
          }
                function cardsRequiringSelection(){
                        var cards = [];
                        host.querySelectorAll('.lp-portal-item').forEach(function(card){
                                var missing = parseInt(card.getAttribute('data-missing')||'0',10)||0;
                                if(missing>0){ cards.push(card); }
                        });
                        return cards;
                }
                function unansweredCards(cards){
                        return cards.filter(function(card){ return !hasDecision(card); });
                }
                function hasDecision(card){
                        if(!card) return false;
                        if(selectionDecision(card)==='decline') return true;
                        return !!card.querySelector('.lp-choice:checked');
                }
                function updateStepperUI(){
                        if(!stepCards.length) return;
                        stepCards.forEach(function(card, idx){
                                card.classList.toggle('completed-step', hasDecision(card));
                                var progress = card.querySelector('.step-progress');
                                if(progress){ progress.textContent = (idx+1) + ' / ' + stepCards.length; }
                        });
                }
                function setStep(newStep){
                        if(!stepCards.length) return;
                        activeStep = Math.max(0, Math.min(stepCards.length-1, newStep));
                        updateStepperUI();
                }
                function initStepper(){
                        stepCards = cardsRequiringSelection();
                        if(stepCards.length<=1) return;
                        stepCards.forEach(function(card, idx){
                                card.classList.add('lp-step-card');
                                        if(!card.querySelector('.lp-step-label')){
                                                var label=document.createElement('div');
                                                label.className='lp-step-label';
                                                label.innerHTML='<span class="badge step-progress"></span><span class="small"><?php echo esc_js( __( 'Velg erstatning eller sletting for hver vare f√∏r du godkjenner.', 'lilleprinsen' ) ); ?></span>';
                                                card.insertBefore(label, card.firstChild);
                                        }
                                updateDecisionBadge(card, selectionDecision(card));
                        });
                        setStep(0);
                }
                initStepper();
                primeThumbs();
                host.querySelectorAll('.lp-portal-item').forEach(function(card){ updateDecisionBadge(card, selectionDecision(card)); });
                function markDecline(card){
                        if(!card) return;
                        card.querySelectorAll('.lp-choice').forEach(function(c){ c.checked=false; });
                        updateDecisionBadge(card,'decline');
                        updateStepperUI();
                        showStatus('<?php echo esc_js( __( 'Vi sletter denne varen n√•r du bekrefter alle endringer.', 'lilleprinsen' ) ); ?>','success');
                        if(stepCards.length>1 && activeStep<stepCards.length-1){ setStep(activeStep+1); }
                }
                function onChoiceChange(card){
                        if(!card) return;
                        var any = !!card.querySelector('.lp-choice:checked');
                        updateDecisionBadge(card, any ? 'accept' : '');
                        updateStepperUI();
                }
                function markAccept(card){
                        if(!card) return;
                        if(overChosen(card)){ showStatus('<?php echo esc_js( __( 'Valgt antall er for h√∏yt i forhold til det som mangler.', 'lilleprinsen' ) ); ?>','error'); return; }
                        var any = !!card.querySelector('.lp-choice:checked');
                        if(!any){ showStatus('<?php echo esc_js( __( 'Velg erstatning f√∏r du lagrer valget for denne varen.', 'lilleprinsen' ) ); ?>','error'); return; }
                        updateDecisionBadge(card,'accept');
                        updateStepperUI();
                        showStatus('<?php echo esc_js( __( 'Valget er lagt til oversikten. Bekreft alle endringer nederst.', 'lilleprinsen' ) ); ?>','success');
                        if(stepCards.length>1 && activeStep<stepCards.length-1){ setStep(activeStep+1); }
                }
                function collectChoices(){
                        return { selections: selections(), declines: declines() };
                }
                function validateBeforeSubmit(){
                        var bad=false;
                        host.querySelectorAll('.lp-portal-item').forEach(function(card){ if(overChosen(card)) bad=true; });
                        if(bad){ return { ok:false, message:'<?php echo esc_js( __( 'Valgt antall er for h√∏yt i forhold til det som mangler.', 'lilleprinsen' ) ); ?>' }; }

                        var responseCards = cardsRequiringSelection();
                        if(responseCards.length){
                                var missingAnswers = unansweredCards(responseCards);
                                if(missingAnswers.length){ return { ok:false, message:'<?php echo esc_js( __( 'Velg erstatning eller sletting for alle varene som mangler.', 'lilleprinsen' ) ); ?>' }; }
                        }

                        var choiceData = collectChoices();
                        if(Object.keys(choiceData.selections).length===0 && !choiceData.declines.length){
                                return { ok:false, message:'<?php echo esc_js( __( 'Velg erstatning eller marker sletting f√∏r du g√•r videre.', 'lilleprinsen' ) ); ?>' };
                        }

                        return { ok:true, selections: choiceData.selections, declines: choiceData.declines };
                }
                function summaryData(){
                        var data={replacements:[], deletions:[]};
                        host.querySelectorAll('.lp-portal-item').forEach(function(card){
                                var itemName='';
                                var nameEl=card.querySelector('.old strong');
                                if(nameEl){ itemName=nameEl.textContent.trim(); }
                                var missing=parseInt(card.getAttribute('data-missing')||'0',10)||0;
                                if(selectionDecision(card)==='decline'){
                                        data.deletions.push({item:itemName, qty:missing});
                                        return;
                                }
                                var picked=[];
                                card.querySelectorAll('.lp-choice:checked').forEach(function(c){
                                        var li=c.closest('li.choice');
                                        var chosenName='';
                                        var strong=li ? li.querySelector('strong') : null;
                                        if(strong){ chosenName=strong.textContent.trim(); }
                                        var qty=parseInt(c.getAttribute('data-qty')||'0',10)||0;
                                        var deltaTxt = li ? (li.getAttribute('data-delta-display')||'') : '';
                                        var deltaNum = li ? (parseFloat(li.getAttribute('data-delta')||'0')||0) : 0;
                                        var payerLabel = li ? (li.getAttribute('data-payer-label')||'') : '';
                                        var payer = li ? (li.getAttribute('data-payer')||'') : '';
                                        picked.push({name:chosenName, qty:qty, deltaText:deltaTxt, deltaNumber:deltaNum, payerLabel:payerLabel, payer:payer});
                                });
                                if(picked.length){ data.replacements.push({item:itemName, choices:picked}); }
                        });
                        return data;
                }
                function renderSummaryView(data){
                        if(!summaryModal) return;
                        var totalDelta=0, hasNegative=false, hasCustomerPaysPositive=false;
                        data.replacements.forEach(function(entry){
                                entry.choices.forEach(function(choice){
                                        totalDelta += choice.deltaNumber || 0;
                                        if(choice.deltaNumber>0 && choice.payer==='customer_pays'){ hasCustomerPaysPositive=true; }
                                        if(choice.deltaNumber<0){ hasNegative=true; }
                                });
                        });
                        if(summaryReplacements){
                                clearEl(summaryReplacements);
                                var title=document.createElement('p');
                                title.className='summary-title';
                                title.textContent='<?php echo esc_js( __( 'Erstatninger', 'lilleprinsen' ) ); ?>';
                                summaryReplacements.appendChild(title);
                                if(data.replacements.length){
                                        var totalBox=document.createElement('div'); totalBox.className='summary-total';
                                        if(totalDelta!==0){ totalBox.classList.add(totalDelta>0?'positive':'negative'); }
                                        var totalLabel=document.createElement('span'); totalLabel.textContent='<?php echo esc_js( __( 'Prisforskjell i alt', 'lilleprinsen' ) ); ?>';
                                        var totalBadge=document.createElement('span'); totalBadge.className='badge summary-price';
                                        totalBadge.textContent = totalDelta===0 ? '<?php echo esc_js( __( 'Ingen prisendring', 'lilleprinsen' ) ); ?>' : ((totalDelta>0?'+ ':'‚àí ') + formatMoney(Math.abs(totalDelta)));
                                        totalBox.appendChild(totalLabel);
                                        totalBox.appendChild(totalBadge);
                                        summaryReplacements.appendChild(totalBox);
                                        if(hasCustomerPaysPositive && hasNegative && totalDelta>0){
                                                var nettingNote=document.createElement('p');
                                                nettingNote.className='note-line small';
                                                nettingNote.textContent='<?php echo esc_js( __( 'Vi refunderer de rimeligere varene til den opprinnelige betalingen, og tar mellomlegget for dyrere varer som en egen trygg betaling.', 'lilleprinsen' ) ); ?>';
                                                summaryReplacements.appendChild(nettingNote);
                                        }
                                }
                                if(data.replacements.length){
                                        data.replacements.forEach(function(entry){
                                                var itemLabel=document.createElement('p');
                                                itemLabel.className='summary-label';
                                                itemLabel.textContent=entry.item||'<?php echo esc_js( __( 'Vare', 'lilleprinsen' ) ); ?>';
                                                summaryReplacements.appendChild(itemLabel);
                                                var list=document.createElement('ul'); list.className='summary-list';
                                                entry.choices.forEach(function(choice){
                                                        var li=document.createElement('li'); li.className='summary-line';
                                                        var left=document.createElement('span'); left.textContent=choice.name + ' √ó ' + choice.qty;
                                                        li.appendChild(left);
                                                        if(choice.deltaText){
                                                                var right=document.createElement('span'); right.className='badge summary-price'; right.textContent=choice.deltaText;
                                                                li.appendChild(right);
                                                        }
                                                        if(choice.payerLabel){
                                                                var meta=document.createElement('span'); meta.className='summary-meta'; meta.textContent=choice.payerLabel;
                                                                li.appendChild(meta);
                                                        }
                                                        list.appendChild(li);
                                                });
                                                summaryReplacements.appendChild(list);
                                        });
                                } else {
                                        var empty=document.createElement('p'); empty.className='summary-empty'; empty.textContent='<?php echo esc_js( __( 'Ingen erstatninger valgt.', 'lilleprinsen' ) ); ?>'; summaryReplacements.appendChild(empty);
                                }
                        }
                        if(summaryDeletions){
                                clearEl(summaryDeletions);
                                var delTitle=document.createElement('p');
                                delTitle.className='summary-title';
                                delTitle.textContent='<?php echo esc_js( __( 'Slettinger', 'lilleprinsen' ) ); ?>';
                                summaryDeletions.appendChild(delTitle);
                                if(data.deletions.length){
                                        var delList=document.createElement('ul'); delList.className='summary-list';
                                        data.deletions.forEach(function(entry){
                                                var li=document.createElement('li'); li.className='summary-line';
                                                var left=document.createElement('span'); left.textContent=entry.item||'<?php echo esc_js( __( 'Vare', 'lilleprinsen' ) ); ?>';
                                                var qty=document.createElement('span'); qty.className='badge summary-price'; qty.textContent='‚àí ' + entry.qty;
                                                li.appendChild(left); li.appendChild(qty);
                                                delList.appendChild(li);
                                        });
                                        summaryDeletions.appendChild(delList);
                                } else {
                                        var delEmpty=document.createElement('p'); delEmpty.className='summary-empty'; delEmpty.textContent='<?php echo esc_js( __( 'Ingen varer markert for sletting.', 'lilleprinsen' ) ); ?>'; summaryDeletions.appendChild(delEmpty);
                                }
                        }
                }
                function post(which, extra){
                        var now=Date.now(); if(now-lastClick<cooldown) return; lastClick=now;
                        var loadingText = (extra && extra.loadingText) ? extra.loadingText : '<?php echo esc_js( __( 'Behandler valgene dine ‚Ä¶', 'lilleprinsen' ) ); ?>';
                        if(extra && extra.loading){ setLoading(true, loadingText); }
                        var fd=new FormData(); fd.append('action','lp_mpr_portal_action'); fd.append('which',which); fd.append('order_id',orderId); fd.append('order_key',orderKey); fd.append('nonce',nonce); fd.append('issue_ver',issueVer);
                        if(extra&&extra.selections){ fd.append('selections', JSON.stringify(extra.selections)); }
                        if(extra&&extra.declines){ fd.append('declines', JSON.stringify(extra.declines)); }
                        if(extra&&extra.message){ fd.append('message', extra.message); }
                        fetch(ajax,{method:'POST',body:fd,credentials:'same-origin'}).then(function(r){return r.json().catch(function(){return {success:false,data:{message:'Ugyldig svar'}};});}).then(function(resp){
                                var data = (resp && resp.data) ? resp.data : {};
                                if(resp && resp.success){
                                        if(data.redirect){ redirecting=true; window.location = data.redirect; return; }
                                        var pricing = data.pricing || {};
                                        var okMsg = data.message ? data.message : 'Takk! Vi tar det herfra.';
                                        if(pricing.order_total_after_html && pricing.order_total_before_html){
                                                var delta = typeof pricing.order_total_delta === 'number' ? pricing.order_total_delta : parseFloat(pricing.order_total_delta||'0');
                                                var deltaHtml = pricing.order_total_delta_html || '';
                                                var changeText = '';
                                                if(deltaHtml && delta !== 0){
                                                        changeText = (delta > 0 ? '<?php echo esc_js( __( 'Pris √∏kte med', 'lilleprinsen' ) ); ?> ' : '<?php echo esc_js( __( 'Pris redusert med', 'lilleprinsen' ) ); ?> ') + deltaHtml;
                                                }
                                                var payerInfo = '';
                                                if(delta > 0){
                                                        if(pricing.delta_payer === 'customer'){ payerInfo = '<?php echo esc_js( __( 'Du betaler mellomlegget.', 'lilleprinsen' ) ); ?>'; }
                                                        else if(pricing.delta_payer === 'store'){ payerInfo = '<?php echo esc_js( __( 'Butikken dekker mellomlegget.', 'lilleprinsen' ) ); ?>'; }
                                                } else if(delta < 0){
                                                        payerInfo = '<?php echo esc_js( __( 'Vi tilbakef√∏rer mellomlegget til deg.', 'lilleprinsen' ) ); ?>';
                                                }
                                                okMsg = '<?php echo esc_js( __( 'Totalsum oppdatert:', 'lilleprinsen' ) ); ?> ' + pricing.order_total_before_html + ' ‚Üí ' + pricing.order_total_after_html;
                                                if(changeText || payerInfo){
                                                        okMsg += ' (' + [changeText, payerInfo].filter(function(p){ return p; }).join(' ¬∑ ') + ')';
                                                }
                                        } else if(pricing.order_total_html){
                                                okMsg = data.message ? data.message : '<?php echo esc_js( __( 'Ordren er oppdatert. Ny totalsum:', 'lilleprinsen' ) ); ?> ' + pricing.order_total_html;
                                        }
                                        showStatus(okMsg, 'success');
                                        if(which==='send_chat'){
                                                var field=document.getElementById('lp-chat-message'); if(field) field.value='';
                                        }
                                }
                                else { showStatus((data && data.message)||'Noe gikk galt.','error'); }
                        }).catch(function(){ showStatus('Nettverksfeil.','error'); }).finally(function(){ if(!redirecting) setLoading(false); });
                }

                host.addEventListener('click', function(e){
                        var t=e.target.closest('button[data-action]'); if(!t) return;
                                var act=t.getAttribute('data-action');
                                if(act==='mark_accept'){
                                        markAccept(t.closest('.lp-portal-item'));
                                }else if(act==='delete_missing'){
                                        markDecline(t.closest('.lp-portal-item'));
                                }else if(act==='open_summary'){
                                        var ready = validateBeforeSubmit();
                                        if(!ready.ok){ showStatus(ready.message,'error'); return; }
                                        renderSummaryView(summaryData());
                                        toggleSummary(true);
                                }else if(act==='close_summary'){
                                        toggleSummary(false);
                                }else if(act==='confirm_changes'){
                                        var validation = validateBeforeSubmit();
                                        if(!validation.ok){ toggleSummary(false); showStatus(validation.message,'error'); return; }
                                        renderSummaryView(summaryData());
                                        toggleSummary(false);
                                        post('approve_update',{selections:validation.selections,declines:validation.declines,loading:true,loadingText:'<?php echo esc_js( __( 'Oppdaterer ordren din ‚Ä¶', 'lilleprinsen' ) ); ?>'});
                                }else if(act==='send_chat'){
                                        var field=document.getElementById('lp-chat-message');
                                        var msg=field ? (field.value||'').trim() : '';
                                        if(!msg){ showStatus('<?php echo esc_js( __( 'Skriv en melding f√∏rst.', 'lilleprinsen' ) ); ?>','error'); return; }
                                        post('send_chat',{message:msg});
                                }
                });

                host.addEventListener('change', function(e){
                        var choice = e.target.closest('.lp-choice');
                        if(choice){
                                var card = choice.closest('.lp-portal-item');
                                if(selectionDecision(card)==='decline'){ updateDecisionBadge(card,''); }
                                onChoiceChange(card);
                        }
                });
        })();
        </script>
	</body>
	</html>
	<?php
	exit;
} );